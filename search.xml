<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CompletableFuture 异步编程API列表</title>
    <url>/CompletableFuture%20%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8BAPI%E5%88%97%E8%A1%A8/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimlvbok4mj30go09et9h.jpg"></p>
<a id="more"></a>

<h4 id="CompletableFuture异步编程API"><a href="#CompletableFuture异步编程API" class="headerlink" title="CompletableFuture异步编程API"></a>CompletableFuture异步编程API</h4><h5 id="静态工厂方法："><a href="#静态工厂方法：" class="headerlink" title="静态工厂方法："></a>静态工厂方法：</h5><ul>
<li><p>runAsync(Runnable runnable)：使用ForkJoinPool.commonPool()作为它的线程池执行异步代码。</p>
</li>
<li><p>runAsync(Runnable runnable, Executor executor)：使用指定的thread pool执行异步代码。</p>
</li>
<li><p>supplyAsync(Supplier<U> supplier)：使用ForkJoinPool.commonPool()作为它的线程池执行异步代码，异步操作有返回值。</p>
</li>
</ul>
<ul>
<li>supplyAsync(Supplier<U> supplier, Executor executor)：使用指定的thread pool执行异步代码，异步操作有返回值</li>
</ul>
<ul>
<li>complete(T t)：完成异步执行，并返回future的结果</li>
</ul>
<ul>
<li>completeExceptionally(Throwable ex)：异步执行不正常的结束，抛出异步执行的错误堆栈</li>
</ul>
<h5 id="转换-类似于流里的map-："><a href="#转换-类似于流里的map-：" class="headerlink" title="转换(类似于流里的map)："></a>转换(类似于流里的map)：</h5><ul>
<li><p>thenApply(Function&lt;? super T,? extends U&gt; fn)：接受一个Function&lt;? super T,? extends U&gt;参数用来转换CompletableFuture</p>
</li>
<li><p>thenApplyAsync(Function&lt;? super T,? extends U&gt; fn)：接受一个Function&lt;? super T,? extends U&gt;参数用来转换CompletableFuture，使用ForkJoinPool</p>
</li>
</ul>
<ul>
<li>thenApplyAsync(Function&lt;? super T,? extends U&gt; fn, Executor executor)：接受一个Function&lt;? super T,? extends U&gt;参数用来转换CompletableFuture，使用指定的线程池</li>
</ul>
<h5 id="flatMap："><a href="#flatMap：" class="headerlink" title="flatMap："></a>flatMap：</h5><ul>
<li><p>thenCompose(Function&lt;? super T, ? extends CompletionStage<U>&gt; fn)：在异步操作完成的时候对异步操作的结果进行一些操作，并且仍然返回CompletableFuture类型。</p>
</li>
<li><p>thenComposeAsync(Function&lt;? super T, ? extends CompletionStage<U>&gt; fn)：在异步操作完成的时候对异步操作的结果进行一些操作，并且仍然返回CompletableFuture类型。使用ForkJoinPool。</p>
</li>
</ul>
<ul>
<li>thenComposeAsync(Function&lt;? super T, ? extends CompletionStage<U>&gt; fn,Executor executor)：在异步操作完成的时候对异步操作的结果进行一些操作，并且仍然返回CompletableFuture类型。使用指定的线程池。</li>
</ul>
<h5 id="组合："><a href="#组合：" class="headerlink" title="组合："></a>组合：</h5><ul>
<li><p>thenCombine(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn)：当两个CompletableFuture都正常完成后，执行提供的fn，用它来组合另外一个CompletableFuture的结果。</p>
</li>
<li><p>thenCombineAsync(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn)：当两个CompletableFuture都正常完成后，执行提供的fn，用它来组合另外一个CompletableFuture的结果。使用ForkJoinPool。<br>thenCombineAsync(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn, Executor executor)：当两个CompletableFuture都正常完成后，执行提供的fn，用它来组合另外一个CompletableFuture的结果。使用指定的线程池。</p>
</li>
<li><p>thenAcceptBoth(CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? super T,? super U&gt; action)：当两个CompletableFuture都正常完成后，执行提供的action，用它来组合另外一个CompletableFuture的结果。</p>
</li>
</ul>
<ul>
<li>thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? super T,? super U&gt; action)：当两个CompletableFuture都正常完成后，执行提供的action，用它来组合另外一个CompletableFuture的结果。使用ForkJoinPool。</li>
</ul>
<ul>
<li>thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? super T,? super U&gt; action, Executor executor)：当两个CompletableFuture都正常完成后，执行提供的action，用它来组合另外一个CompletableFuture的结果。使用指定的线程池。</li>
</ul>
<h5 id="计算结果完成时的处理："><a href="#计算结果完成时的处理：" class="headerlink" title="计算结果完成时的处理："></a>计算结果完成时的处理：</h5><ul>
<li><p>whenComplete(BiConsumer&lt;? super T,? super Throwable&gt; action)：当CompletableFuture完成计算结果时对结果进行处理，或者当CompletableFuture产生异常的时候对异常进行处理。</p>
</li>
<li><p>whenCompleteAsync(BiConsumer&lt;? super T,? super Throwable&gt; action)：当CompletableFuture完成计算结果时对结果进行处理，或者当CompletableFuture产生异常的时候对异常进行处理。使用ForkJoinPool。</p>
</li>
</ul>
<ul>
<li>whenCompleteAsync(BiConsumer&lt;? super T,? super Throwable&gt; action, Executor executor)：当CompletableFuture完成计算结果时对结果进行处理，或者当CompletableFuture产生异常的时候对异常进行处理。使用指定的线程池。</li>
</ul>
<ul>
<li>handle(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn)：当CompletableFuture完成计算结果或者抛出异常的时候，执行提供的fn</li>
</ul>
<ul>
<li>handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn)：当CompletableFuture完成计算结果或者抛出异常的时候，执行提供的fn，使用ForkJoinPool。</li>
</ul>
<ul>
<li>handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn, Executor executor)：当CompletableFuture完成计算结果或者抛出异常的时候，执行提供的fn，使用指定的线程池。</li>
</ul>
<ul>
<li>thenAccept(Consumer&lt;? super T&gt; action)：当CompletableFuture完成计算结果，只对结果执行Action，而不返回新的计算值</li>
</ul>
<ul>
<li>thenAcceptAsync(Consumer&lt;? super T&gt; action)：当CompletableFuture完成计算结果，只对结果执行Action，而不返回新的计算值，使用ForkJoinPool。</li>
</ul>
<ul>
<li>thenAcceptAsync(Consumer&lt;? super T&gt; action, Executor executor)：当CompletableFuture完成计算结果，只对结果执行Action，而不返回新的计算值</li>
</ul>
<ul>
<li>acceptEither(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action)：当任意一个CompletableFuture完成的时候，action这个消费者就会被执行。</li>
</ul>
<ul>
<li>acceptEitherAsync(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action)：当任意一个CompletableFuture完成的时候，action这个消费者就会被执行。使用ForkJoinPool</li>
</ul>
<ul>
<li>acceptEitherAsync(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action, Executor executor)：当任意一个CompletableFuture完成的时候，action这个消费者就会被执行。使用指定的线程池</li>
</ul>
<ul>
<li>applyToEither(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T,U&gt; fn)：当任意一个CompletableFuture完成的时候，fn会被执行，它的返回值会当作新的CompletableFuture<U>的计算结果。</li>
</ul>
<ul>
<li>applyToEitherAsync(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T,U&gt; fn)：当任意一个CompletableFuture完成的时候，fn会被执行，它的返回值会当作新的CompletableFuture<U>的计算结果。使用ForkJoinPool</li>
</ul>
<ul>
<li>applyToEitherAsync(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T,U&gt; fn, Executor executor)：当任意一个CompletableFuture完成的时候，fn会被执行，它的返回值会当作新的CompletableFuture<U>的计算结果。使用指定的线程池</li>
</ul>
<ul>
<li>allOf(CompletableFuture&lt;?&gt;… cfs)：在所有Future对象完成后结束，并返回一个future。</li>
</ul>
<ul>
<li>anyOf(CompletableFuture&lt;?&gt;… cfs)：在任何一个Future对象结束后结束，并返回一个future。</li>
</ul>
<h5 id="CompletableFuture异常处理："><a href="#CompletableFuture异常处理：" class="headerlink" title="CompletableFuture异常处理："></a>CompletableFuture异常处理：</h5><ul>
<li>exceptionally(Function fn)：只有当CompletableFuture抛出异常的时候，才会触发这个exceptionally的计算，调用function计算值。</li>
</ul>
]]></content>
      <categories>
        <category>Java笔记</category>
      </categories>
      <tags>
        <tag>Java8异步编程</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM 参数配置</title>
    <url>/JVM%20%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1gimfe2w3jrj30lx0amgrz.jpg"></p>
<a id="more"></a>

<h2 id="JVM-参数配置"><a href="#JVM-参数配置" class="headerlink" title="JVM 参数配置"></a>JVM 参数配置</h2><h3 id="虚拟机及垃圾收集器日志"><a href="#虚拟机及垃圾收集器日志" class="headerlink" title="虚拟机及垃圾收集器日志"></a>虚拟机及垃圾收集器日志</h3><p>在JDK9以前，HotSpot并没有提供统一的日志处理框架，虚拟机各个功能模块的日志开关分布在不同的参数上，日志级别、循环日志大小、输出格式、重定向等设置在不同功能上都需要单独解决。直到JDK9，这些问题才终于解决，HotSpot将所有功能的日志都收归到了<code>-Xlog</code>参数上。</p>
<p>参数格式：<code>-Xlog[:[selector][:[output][:[decorators][:output-options]]]]</code></p>
<p>命令行中最关键的参数是选择器（Selector），它由标签（Tag）和日志级别（Level）共同组成。标签可理解为虚拟机中某个功能模块的名字，它告诉日志框架用户希望得到虚拟机哪些功能的日志输出。垃圾收集器的标签名称为”gc”，由此可见，垃圾收集器日志只是HotSpot众多功能日志的其中一项。</p>
<p>日志级别从低到高，共有Trace、Debug、Info、Warning、Error、Off六种级别，日志级别决定了输出信息的详细程度，默认级别为Info，HotSpot的日志规则与Log4j、Slf4j这类Java日志框架大体上是一致的。</p>
<p>JDK9前后日志参数变化列表。</p>
<table>
<thead>
<tr>
<th align="left">JDK9前日志参数</th>
<th align="left">JDK9后配置形式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-XX:+PrintGC</td>
<td align="left">-Xlog:gc</td>
</tr>
<tr>
<td align="left">-XX:+PrintGCDetails</td>
<td align="left">-Xlog:gc+heap=debug</td>
</tr>
<tr>
<td align="left">-XX:+G1PrintHeapRegions</td>
<td align="left">-Xlog:gc+region=trace</td>
</tr>
<tr>
<td align="left">-XX:+G1PrintRegionLivenessInfo</td>
<td align="left">-Xlog:gc+liveness=trace</td>
</tr>
<tr>
<td align="left">-XX:+G1SummarizeConcMark</td>
<td align="left">-Xlog:gc+marking=trace</td>
</tr>
<tr>
<td align="left">-XX:+G1SummarizeRSetStats</td>
<td align="left">-Xlog:gc+remset*=trace</td>
</tr>
<tr>
<td align="left">-XX:+GCLogFileSize, NumberOfGCLogFiles, UseGCLogFileRotation</td>
<td align="left">-Xlog:gc*:file=<file>::filecount=<count>,filesize=<filesize in kb></td>
</tr>
<tr>
<td align="left">-XX:+PrintAdaptiveSizePolicy</td>
<td align="left">-Xlog:gc+ergo*=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintClassHistogramAfterFullGC</td>
<td align="left">-Xlog:classhisto*=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintClassHistogramBeforeFullGC</td>
<td align="left">-Xlog:classhisto*=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintGCApplicationConcurrentTime</td>
<td align="left">-Xlog:safepoint</td>
</tr>
<tr>
<td align="left">-XX:+PrintGCApplicationStoppedTime</td>
<td align="left">-Xlog:safepoint</td>
</tr>
<tr>
<td align="left">-XX:+PrintGCDateStamps</td>
<td align="left">使用time修饰器</td>
</tr>
<tr>
<td align="left">-XX:+PrintGCTaskTimeStamps</td>
<td align="left">-Xlog:gc+task=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintGcTimeStamps</td>
<td align="left">使用uptime修饰器</td>
</tr>
<tr>
<td align="left">-XX:+PrintHeapAtGC</td>
<td align="left">-Xlog:gc+heap=debug</td>
</tr>
<tr>
<td align="left">-XX:+PrintHeapAtGCExtended</td>
<td align="left">-Xlog:gc+heap=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintJNIGCStalls</td>
<td align="left">-Xlog:gc+jni=debug</td>
</tr>
<tr>
<td align="left">-XX:+PrintOldPLAB</td>
<td align="left">-Xlog:gc+plab=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintParallelOldGCPhaseTimes</td>
<td align="left">-Xlog:gc+phases=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintPLAB</td>
<td align="left">-Xlog:gc+plab=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintPromotionFailure</td>
<td align="left">-Xlog:gc+promotion=debug</td>
</tr>
<tr>
<td align="left">-XX:+PrintReferenceGC</td>
<td align="left">-Xlog:gc+ref=debug</td>
</tr>
<tr>
<td align="left">-XX:+PrintStringDebuplicationStatisitcs</td>
<td align="left">-Xlog:gc+stringdedup</td>
</tr>
<tr>
<td align="left">-XX:+PrintTaskqueue</td>
<td align="left">-Xlog:gc+task+stats=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintTenuringDistribution</td>
<td align="left">-Xlog:gc+age=trace</td>
</tr>
<tr>
<td align="left">-XX:+PrintTerminationStats</td>
<td align="left">-Xlog:gc+task+stats=debug</td>
</tr>
<tr>
<td align="left">-XX:+PrintTLAB</td>
<td align="left">-Xlog:gc+tlab=trace</td>
</tr>
<tr>
<td align="left">-XX:+TraceAdaptiveGCBoundary</td>
<td align="left">-Xlog:heap+ergo=debug</td>
</tr>
<tr>
<td align="left">-XX:+TraceDynamicGCThreads</td>
<td align="left">-Xlog:gc+task=trace</td>
</tr>
<tr>
<td align="left">-XX:+TraceMetadataHumongousAllocation</td>
<td align="left">-Xlog:gc+metaspace+alloc=debug</td>
</tr>
<tr>
<td align="left">-XX:+G1TraceConcRefinement</td>
<td align="left">-Xlog:gc+refine=debug</td>
</tr>
<tr>
<td align="left">-XX:+G1TraceEagerReclaimHumongousObjectss</td>
<td align="left">-Xlog:gc+humongous=debug</td>
</tr>
<tr>
<td align="left">-XX:+G1TraceStringSymbolTableScrubbing</td>
<td align="left">-Xlog:gc+stringtable=trace</td>
</tr>
</tbody></table>
<h3 id="垃圾收集器参数"><a href="#垃圾收集器参数" class="headerlink" title="垃圾收集器参数"></a>垃圾收集器参数</h3><p>垃圾收集齐全相关的常用参数</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-XX:+/-UseSerialGC</td>
<td>虚拟机运行在Client模式下的默认值，打开此开关后，使用Serial + Serial Old的收集器组合进行内存回收</td>
</tr>
<tr>
<td align="center">-XX:+/-UseParNewGC</td>
<td>打开此开关后，使用ParNew + Serial Old的收集器组合进行内存回收，在JDK9后不再支持</td>
</tr>
<tr>
<td align="center">-XX:+/-UseConcMarkSweepGC</td>
<td>打开此开关后，使用ParNew + CMS + Serial Old的收集器组合进行内存回收。Serial Old收集器将作为CMS收集器出现“Concurrent Mode Failure”失败后的后备收集器使用</td>
</tr>
<tr>
<td align="center">-XX:+/-UseParallelGC</td>
<td>JDK9之前虚拟机运行在Server模式下的默认值，打开此开关后，使用Parallel Scavenge + Serial Old（PS MarkSweep）的收集器组合进行内存回收</td>
</tr>
<tr>
<td align="center">-XX:+/-UseParallelOldGC</td>
<td>打开此开关后，使用Parallel Scavenge + Parallel Old的收集器组合进行内存回收</td>
</tr>
<tr>
<td align="center">-Xms256m</td>
<td>初始堆大小</td>
</tr>
<tr>
<td align="center">-Xmx512m</td>
<td>最大堆大小</td>
</tr>
<tr>
<td align="center">-Xmn128m</td>
<td>新生代大小</td>
</tr>
<tr>
<td align="center">-Xss1m</td>
<td>设置栈大小</td>
</tr>
<tr>
<td align="center">-XX:+/-UseTLAB</td>
<td>开启本地线程分配缓冲（Thread Local Allocation Buffer，TLAB）</td>
</tr>
<tr>
<td align="center">-XX:FieldsAllocationStyle</td>
<td>字段存储顺序会受到虚拟机分配策略参数</td>
</tr>
<tr>
<td align="center">-XX：HeapDumpOnOutOfMemoryError</td>
<td>虚拟机内存溢出时导出堆转储快照文件</td>
</tr>
<tr>
<td align="center">-XX:MaxPermSize</td>
<td>最大永久代大小（JDK6）</td>
</tr>
<tr>
<td align="center">-XX:PermSize</td>
<td>初始永久代大小（JDK6）</td>
</tr>
<tr>
<td align="center">-XX:MaxMetaspaceSize</td>
<td>最大元空间大小（JDK8），默认是-1，即不限制，或者说只受限于本地内存大小</td>
</tr>
<tr>
<td align="center">-XX:MetaspaceSize</td>
<td>指定元空间的初始大小，以字节为单位，达到该单位就会触发垃圾收集进行类型卸载，同时收集器会对该值进行调整：如果释放了大量空间就会降低该值；如果释放很少空间，在不超过最大的元空间大小的前提下，适当提高该值</td>
</tr>
<tr>
<td align="center">-XX:MinMetaspaceFreeRatio</td>
<td>作用是在垃圾收集之后控制最小的元空间剩余容量的百分比，可减少因为元空间不足导致的垃圾收集的频率。</td>
</tr>
<tr>
<td align="center">-XX:MaxMetaspaceFreeRatio</td>
<td>用于控制最大的元空间剩余容量的百分比</td>
</tr>
<tr>
<td align="center">-XX:MaxDirectMemorySize</td>
<td>设置直接内存的最大容量，若不指定，则默认与堆最大值一致</td>
</tr>
<tr>
<td align="center">-XX:SurvivorRatio</td>
<td>新生代中Eden区域与Survivor区域的容量比值，默认为8，代表Eden：Survivor=8:1</td>
</tr>
<tr>
<td align="center">-XX:PretenureSizeThreshold</td>
<td>直接晋升到老年代的对象大小，设置这个参数后，大于这个参数的对象将直接在老年代分配</td>
</tr>
<tr>
<td align="center">-XX:MaxTenuringThreshold</td>
<td>晋升到老年代的对象年龄。每个对象在坚持过一次Minor GC之后，年龄就增加1，当超过这个参数值时就进入老年代</td>
</tr>
<tr>
<td align="center">-XX:UseAdaptiveSizePolicy</td>
<td>动态调整Java堆中各个区域的大小以及进入老年代的年龄</td>
</tr>
<tr>
<td align="center">-XX:HandlePromotionFailure</td>
<td>是否允许分配担保失败，即老年代的剩余空间不足以应对新生代的整个Eden和Survivor区的所有对象都存活的极端情况</td>
</tr>
<tr>
<td align="center">-XX:ParallelGCThreads</td>
<td>设置并行GC时进行内存回收的线程数，也就是用户线程冻结期间并行执行的收集器线程数</td>
</tr>
<tr>
<td align="center">-XX:GCTimeRatio</td>
<td>GC时间占总时间的比率，默认值为99，即允许1%的GC时间。仅在使用Parallel Scavenge收集器时生效</td>
</tr>
<tr>
<td align="center">-XX:MaxGCPauseMillis</td>
<td>设置GC的最大停顿时间。仅在使用Parallel Scavenge收集器时生效</td>
</tr>
<tr>
<td align="center">-XX:CMSInitiatingOccupancyFraction</td>
<td>设置CMS收集器在老年代空间被使用多少后触发垃圾收集。默认值为68%，仅在使用CMS收集器时生效</td>
</tr>
<tr>
<td align="center">-XX:UseCMSCompactAtFullCollection</td>
<td>设置CMS收集器在完成垃圾收集后是否要进行一次内存碎片整理。仅在使用CMS收集器时生效，此参数从JDK9开始废弃</td>
</tr>
<tr>
<td align="center">-XX:CMSFullGCsBeforeCompaction</td>
<td>设置CMS收集器在进行若干次垃圾收集后再启动一次内存碎片整理。仅在使用CMS收集器时生效，此参数从JDK9开始废弃</td>
</tr>
<tr>
<td align="center">-XX:UseG1GC</td>
<td>使用G1收集器，这个是JDK9后的Server模式默认值</td>
</tr>
<tr>
<td align="center">-XX:G1HeapRegionSize=n</td>
<td>设置Region大小，并非最终值</td>
</tr>
<tr>
<td align="center">-XX:MaxGCPauseMillis</td>
<td>设置G1收集过程目标时间，默认值200ms，不是硬性条件</td>
</tr>
<tr>
<td align="center">-XX:G1NewSizePercent</td>
<td>新生代最小值，默认值是5%</td>
</tr>
<tr>
<td align="center">-XX:G1MaxNewSizePercent</td>
<td>新生代最大值，默认值是60%</td>
</tr>
<tr>
<td align="center">-XX:ConcGCThreads=n</td>
<td>并发标记、并发整理的执行线程数，对不同的收集器，根据其能够并发的阶段，有不同的含义</td>
</tr>
<tr>
<td align="center">-XX:InitiatingHeapOccupancyPercent</td>
<td>设置触发标记周期的Java堆占用率阈值。默认值是45%。这里的Java堆占比值的是non_young_capacity_bytes，包括old+humongous</td>
</tr>
<tr>
<td align="center">-XX:UseShenandoahGC</td>
<td>使用Shenandoah收集器。这个选项在OracleJDK中不被支持，只能在OpenJDK 12或者某些支持Shenandoah的Backport发行版本使用。目前仍然要配合-XX:+UnlockExperimentalVMOptions使用</td>
</tr>
<tr>
<td align="center">-XX:ShenandoahGCHeuristics</td>
<td>Shenandoah何时启动一次GC过程，其可选值有adaptive、static、compact、passive、aggressive</td>
</tr>
<tr>
<td align="center">-XX:UseZGC</td>
<td>使用ZGC收集器，目前仍然要配合-XX:+UnlockExperimentalVMOptions使用</td>
</tr>
<tr>
<td align="center">-XX:UseNUMA</td>
<td>启用NUMA内存分配支持，目前只有Parallel和ZGC支持，以后G1收集器可能也会支持该选项</td>
</tr>
</tbody></table>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>垃圾收集器在许多场景中都是影响系统停顿时间和吞吐能力的重要因素之一，虚拟机之所以提供多种不同的收集器以及大量的调节参数，就是因为只有根据实际应用需求、实现方式选择最优的收集方式才能获取最好的性能。没有固定收集器、参数组合，没有最优的调优方法，虚拟机也就没有什么必然的内存回收行为。如果要实践调优，就必须要了解每个具体收集器的行为、优势劣势、调节参数等。</p>
]]></content>
      <categories>
        <category>JVM笔记</category>
      </categories>
      <tags>
        <tag>JVM参数</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 虚拟机笔记</title>
    <url>/Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1gimfe2w3jrj30lx0amgrz.jpg"></p>
<a id="more"></a>

<h3 id="JVM-虚拟机笔记"><a href="#JVM-虚拟机笔记" class="headerlink" title="JVM 虚拟机笔记"></a>JVM 虚拟机笔记</h3><h4 id="JVM运行时数据区域"><a href="#JVM运行时数据区域" class="headerlink" title="JVM运行时数据区域"></a>JVM运行时数据区域</h4><p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghrbvdoy5jj30k70cpgqk.jpg"></p>
<h5 id="程序计数器（Program-Counter-Register）"><a href="#程序计数器（Program-Counter-Register）" class="headerlink" title="程序计数器（Program Counter Register）"></a>程序计数器（Program Counter Register）</h5><ul>
<li><p>内存大小：是一块比较小的内存空间</p>
</li>
<li><p>作用：当前线程所执行的字节码的行号指示器，在Java虚拟机的概念模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令</p>
</li>
<li><p>功能</p>
<ul>
<li>程序控制流的指示器</li>
<li>分支</li>
<li>循环</li>
<li>跳转</li>
<li>异常处理</li>
<li>线程恢复</li>
</ul>
</li>
<li><p>内存属性：各个线程之间计数器互不影响，“线程私有”</p>
</li>
</ul>
<h5 id="Java虚拟机栈（Java-Virtual-Machine-Stacks）"><a href="#Java虚拟机栈（Java-Virtual-Machine-Stacks）" class="headerlink" title="Java虚拟机栈（Java Virtual Machine Stacks）"></a>Java虚拟机栈（Java Virtual Machine Stacks）</h5><ul>
<li><p>描述</p>
<ul>
<li>Java方法执行的内存模型，每个方法执行时都会创建栈帧（Stack Frame）</li>
</ul>
</li>
<li><p>栈帧</p>
<ul>
<li>存储局部变量表<ul>
<li>基本数据类型（boolean、byte、char、short、int、float、double、long）</li>
<li>对象引用（reference类型）</li>
<li>returnAddress类型（字节码指令地址）</li>
</ul>
</li>
<li>操作数栈</li>
<li>动态连接</li>
<li>方法出口</li>
</ul>
</li>
<li><p>内存属性：线程私有，生命周期与线程相同</p>
</li>
<li><p>异常</p>
<ul>
<li>StackOverflowError<ul>
<li>线程请求的栈深度大于虚拟机所允许的深度，抛出StackOverflowError异常</li>
</ul>
</li>
<li>OutOfMemoryError<ul>
<li>如果虚拟机栈容量可扩展，当栈扩展时无法申请到足够内存，抛出OutOfMemoryError异常（Classic虚拟机栈可以动态扩展）</li>
<li>在HotSpot虚拟机的栈容量是不可动态扩展，所以不会因为动态扩展而OOM，只要线程申请栈空间成功了就不会有OOM，但是申请失败仍然会有OOM异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="本地方法栈（Native-Method-Stack）"><a href="#本地方法栈（Native-Method-Stack）" class="headerlink" title="本地方法栈（Native Method Stack）"></a>本地方法栈（Native Method Stack）</h5><ul>
<li>功能与虚拟机栈非常相似，区别：<ul>
<li>Java虚拟机栈为虚拟机执行Java方法（字节码）服务</li>
<li>本地方法栈为虚拟机使用Native方法服务</li>
</ul>
</li>
<li>异常<ul>
<li>StackOverflowError<ul>
<li>当栈深度溢出则抛出</li>
</ul>
</li>
<li>OutOfMemoryError<ul>
<li>当扩展失败时抛出</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Java堆（Java-Heap）"><a href="#Java堆（Java-Heap）" class="headerlink" title="Java堆（Java Heap）"></a>Java堆（Java Heap）</h5><ul>
<li><p>描述</p>
<ul>
<li>内存大小：Jvm所管理的内存中最大的一块</li>
<li>被所有线程所共享的区域</li>
<li>作用：存放对象实例，几乎所有的对象实例都在堆里分配内存，但随着JIT编译器的发展与逃逸分析技术逐渐成熟，栈上分配、标量替换优化技术会发生微妙变化</li>
<li>堆是垃圾收集器管理的主要区域，因此被称为GC堆</li>
<li>堆可以处于物理上不连续的内存空间中，只要逻辑上连续即可</li>
<li>Java堆既可以被实现成固定大小，也可以是可扩展的（通过参数-Xmx和-Xms设定）</li>
</ul>
</li>
<li><p>分类</p>
<ul>
<li>内存回收角度<ul>
<li>现在收集器基本采用分代收集算法<ul>
<li>以G1收集器为分界，都基于经典分代来设计（不适合当下情况）<ul>
<li>新生代<ul>
<li>Eden space</li>
<li>To Survivor space</li>
<li>From Survivor space</li>
</ul>
</li>
<li>老年代</li>
<li>永久代（PermGen）<ul>
<li>在Jdk8已经删除，替换成元空间（Metaspaces）</li>
</ul>
</li>
</ul>
</li>
<li>HotSpot目前采用不分代设计的新垃圾收集器</li>
</ul>
</li>
</ul>
</li>
<li>内存分配角度<ul>
<li>所有线程共享的Java堆中可以划分出多个线程私有的分配缓冲区（Thread Local Allocation Buffer， TLAB），以提升分配对象的效率</li>
</ul>
</li>
</ul>
</li>
<li><p>异常</p>
<ul>
<li>OutOfMemoryError<ul>
<li>堆没有内存完成实例分配，并且无法扩展时，抛出OOM异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="方法区（Method-Area）"><a href="#方法区（Method-Area）" class="headerlink" title="方法区（Method Area）"></a>方法区（Method Area）</h5><ul>
<li><p>描述</p>
<ul>
<li>和Java堆一样，被所有线程所共享，又称Non-Heap（非堆）</li>
<li>在JDK8以前，又把方法区称为“永久代”，其实两者不等价，只是使用永久代来实现方法区而已，这样HotSpot虚拟机就可以像管理堆一样管理这块内存</li>
<li>对于其他虚拟机是不存在永久代概念，在JDK7以前，是很容易导致OOM PermGen space内存溢出的问题</li>
<li>从JDK6开始HotSpot就有放弃永久代，逐步改为采用本地内存（Native Memory）来实现方法区</li>
<li>从JDK7开始，HotSpot把原来放在永久代的字符串常量池、静态变量等从方法区移出到堆里</li>
<li>到了JDK8已经完全废弃了，HotSpot把永久代剩余的类型信息全部移到元空间中</li>
</ul>
</li>
<li><p>作用：用来存储</p>
<ul>
<li>类信息</li>
<li>常量</li>
<li>静态变量</li>
<li>即时编译器编译后的代码缓存</li>
</ul>
</li>
<li><p>内存回收：</p>
<ul>
<li>对常量池对回收</li>
<li>对类型的卸载</li>
</ul>
</li>
<li><p>异常</p>
<ul>
<li>OutOfMemoryError<ul>
<li>当方法区无法满足内存分配需求时，抛出OOM异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="运行时常量池（Runtime-Constant-Pool）"><a href="#运行时常量池（Runtime-Constant-Pool）" class="headerlink" title="运行时常量池（Runtime Constant Pool）"></a>运行时常量池（Runtime Constant Pool）</h6><ul>
<li>描述<ul>
<li>方法区的一部分</li>
<li>Class文件中除了有类的版本信息、字段、方法、接口等描述信息外，还有一项是常量池表，用于存放编译期生成等各种字面量与符号引用，这部分内容在类加载后存放到方法区的运行时常量池中</li>
</ul>
</li>
<li>作用<ul>
<li>存储编译期生成的各种字面量</li>
<li>符号引用</li>
</ul>
</li>
<li>异常<ul>
<li>OutOfMemoryError<ul>
<li>当常量池无法申请内存时，抛出OOM异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="直接内存（堆外内存）"><a href="#直接内存（堆外内存）" class="headerlink" title="直接内存（堆外内存）"></a>直接内存（堆外内存）</h5><ul>
<li>并不是虚拟机运行时数据区的一部分，也不是JVM规范中定义的内存区域，是直接受操作系统管理</li>
<li>在NIO中的DirectByteBuffer对象就是进行堆外内存管理和使用的，它会在对象创建的时候就分配堆外内存。DirectByteBuffer类是在Java Heap外分配内存，对堆外内存的申请主要是通过成员变量Unsafe来操作</li>
<li>好处：能够在一定程度上减少垃圾回收对应用程序造成的影响</li>
<li>若忽略直接内存，会使各个内存区域总和大于物理内存限制，从而动态扩展时出现OOM异常</li>
</ul>
<h4 id="JVM-对象"><a href="#JVM-对象" class="headerlink" title="JVM 对象"></a>JVM 对象</h4><h5 id="对象创建"><a href="#对象创建" class="headerlink" title="对象创建"></a>对象创建</h5><p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1ghp7gu9418j31fk0b20w3.jpg" alt="WX20200813-151534@2x"></p>
<ul>
<li><p>检查指令参数是否在常量池定位到类的符号引用</p>
</li>
<li><p>检查符号引用的类是否已加载、解析、初始化</p>
</li>
<li><p>为新生对象分配内存</p>
<ul>
<li>堆内存规整，则用指针碰撞方式分配</li>
<li>堆内存不规整，则用空闲列表方式分配</li>
<li>堆内存规整与否，取决于采用的垃圾收集器是否带有空间压缩整理的能力</li>
<li>当使用Serial、ParNew等带有压缩整理过程的收集器，系统采用等是指针碰撞方式</li>
<li>使用CMS这种基于清除（Sweep）算法的收集器时，理论上只能采用较为复杂的空闲列表来实现分配</li>
<li>内存分配安全方式<ul>
<li>对分配对内存空间动作进行同步处理<ul>
<li>CAS+失败重试来保证更新操作对原子性</li>
</ul>
</li>
<li>内存分配对动作按照线程划分在不同对空间之中进行<ul>
<li>即每个线程在Java堆中预先分配一小块内存，称为本地线程分配缓冲（Thread Local Allocation Buffer, TLAP）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>将分配到的内存空间都初始化为0（不包括对象头）</p>
</li>
<li><p>为对象进行必要设置</p>
</li>
<li><p>执行init为对象初始化</p>
</li>
</ul>
<h5 id="对象的内存布局"><a href="#对象的内存布局" class="headerlink" title="对象的内存布局"></a>对象的内存布局</h5><ul>
<li><p>对象头（Header）</p>
<ul>
<li><p>存储对象自身的运行时数据，也被称为“Mark Word”</p>
<ul>
<li>哈希吗（HashCode）</li>
<li>GC分代年龄</li>
<li>锁状态标志</li>
<li>线程持有的锁</li>
<li>偏向线程ID</li>
<li>偏向时间戳</li>
</ul>
</li>
<li><p>类型指针</p>
<ul>
<li>对象指向它的类元数据的指针</li>
<li>虚拟机通过指针来确定对象是哪个实例</li>
</ul>
</li>
<li><p>对象若是数组，必须有一块记录数组长度的数据，普通对象JVM可以通过元数据信息获取对象大小，而数组的元数据无法确定大小</p>
</li>
</ul>
</li>
<li><p>实例数据（Instance Data）</p>
<ul>
<li>对象真正存储的有效信息，也是程序定义的各种类型的字段内容</li>
<li>HotSpot虚拟机分配策略是相同宽度的字段总是被分配在一起</li>
</ul>
</li>
<li><p>对齐填充（Padding）</p>
<ul>
<li>不是必要的，起着占位符的作用</li>
<li>HotSpot VM的自动内存管理系统要求对象起始地址必须是8字节的整数倍</li>
<li>当对象实例没有对齐时，就需要通过填充来补全</li>
</ul>
</li>
</ul>
<h5 id="对象的访问定位"><a href="#对象的访问定位" class="headerlink" title="对象的访问定位"></a>对象的访问定位</h5><ul>
<li><p>Java程序通过栈上的reference数据来操作堆上的具体对象，至于通过什么方式定位引用对象，通过以下两种主流方式</p>
</li>
<li><p>句柄</p>
<ul>
<li>堆分配一块内存作为句柄池，reference中存储对象的句柄地址</li>
<li>优势：reference存储句柄地址，对象移动时只会改变句柄中实例数据指针，而reference本身不用修改</li>
</ul>
</li>
<li><p>直接指针</p>
<ul>
<li>reference存储的直接就是对象地址</li>
<li>优势：速度更快，节省了一次指针定位的时间开销，由于对象的访问在Java非常频繁，因为节省的开销是非常可观的</li>
<li>HotSpot 就是使用直接指针方式定位对象</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>JVM笔记</category>
      </categories>
      <tags>
        <tag>JVM内存区域</tag>
        <tag>JVM对象</tag>
      </tags>
  </entry>
  <entry>
    <title>Java SPI</title>
    <url>/JavaSPI%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p><img src="https://tva3.sinaimg.cn/large/008aQ1h9ly1gin4nlxitej30p00dwaac.jpg"></p>
<a id="more"></a>

<h2 id="Java-SPI"><a href="#Java-SPI" class="headerlink" title="Java SPI"></a>Java SPI</h2><h3 id="什么是Java-SPI"><a href="#什么是Java-SPI" class="headerlink" title="什么是Java SPI"></a>什么是Java SPI</h3><p>Java SPI（服务提供者接口）是动态加载服务的机制。通过遵循特定的规则集，我们可以在我们的应用程序中实现Java SPI，并使用ServiceLoader类加载服务。</p>
<h3 id="Java-SPI-组件"><a href="#Java-SPI-组件" class="headerlink" title="Java SPI 组件"></a>Java SPI 组件</h3><p>SPI实现中包含四个组件：</p>
<ol>
<li>服务提供者接口：定义服务提供者实现类的协定的接口或抽象类</li>
<li>服务提供者：实际提供者的实现类</li>
<li>SPI配置文件：一个特殊的文件，用于提供查找服务实现的逻辑。文件名必须存在于<strong>META-INF/services</strong>目录中。文件名应与服务提供商接口标准名称完全相同。文件中的每一行都有一个实现服务类详细信息，再次是服务提供者类的完全限定名称。</li>
<li>ServiceLoader：Java SPI主类，用于为服务提供者接口加载服务。ServiceLoader中有多种实用方法可用于获取特定的实现，对其进行迭代或重新加载服务。</li>
</ol>
<h3 id="Java-服务提供者接口示例"><a href="#Java-服务提供者接口示例" class="headerlink" title="Java 服务提供者接口示例"></a>Java 服务提供者接口示例</h3><p><code>java.util.spi</code>软件包提供了许多服务提供者接口，可以将其实现以提供服务。</p>
<ol>
<li>ResourceBundleControlProvider：提供<code>ResourceBundle.Control</code>实现的服务提供者的接口。</li>
<li>LocaleServiceProvider，CalendarDataProvider，CalendarNameProvider，CurrencyNameProvider，TimeZoneNameProvider和LocaleNameProvider：用于实现特定于区域设置的服务提供者。</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1gin508rhxqj31wd0rlgp6.jpg"></p>
<h3 id="Java-SPI-示例"><a href="#Java-SPI-示例" class="headerlink" title="Java SPI 示例"></a>Java SPI 示例</h3><p>让我们创建SPI的实现，并使用ServiceLoader类加载一些服务。</p>
<h4 id="服务提供者接口"><a href="#服务提供者接口" class="headerlink" title="服务提供者接口"></a>服务提供者接口</h4><p>假设我们有一个<code>MessageServiceProvider</code>接口，用于定义服务提供者实现发送消息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息服务提供者接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-11 23:46:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageServiceProvider</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务提供者实现类"><a href="#服务提供者实现类" class="headerlink" title="服务提供者实现类"></a>服务提供者实现类</h4><p>我们希望支持电子邮件和推送通知消息。因此，我们将创建<code>MessageServiceProvider</code>接口的两个服务提供者实现<code>EmailServiceProvider</code>和<code>PushNotificationServiceProvider</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮件服务提供者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-11 23:47:38</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailServiceProvider</span> <span class="keyword">implements</span> <span class="title">MessageServiceProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Sending Email with Message = &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 推送通知服务提供者实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-11 23:48:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PushNotificationServiceProvider</span> <span class="keyword">implements</span> <span class="title">MessageServiceProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Sending Push Notification with Message = &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务提供者配置文件"><a href="#服务提供者配置文件" class="headerlink" title="服务提供者配置文件"></a>服务提供者配置文件</h4><p>必须在<strong>META-INF/services</strong>目录中创建配置文件。其名称应为“ <strong>com.chivalry.spi.message.MessageServiceProvider</strong> ”。我们将在此文件中指定两个实现类。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">com.chivalry.spi.message.EmailServiceProvider</span></span><br><span class="line"><span class="attr">com.chivalry.spi.message.PushNotificationServiceProvider</span></span><br></pre></td></tr></table></figure>

<h4 id="加载服务的ServiceLoader示例"><a href="#加载服务的ServiceLoader示例" class="headerlink" title="加载服务的ServiceLoader示例"></a>加载服务的ServiceLoader示例</h4><p>最后，我们必须使用ServiceLoader类加载服务。这是一个显示其用法的简单测试程序。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServiceLoader&#125; 加载服务示例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-11 23:53:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoaderTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ServiceLoader&lt;MessageServiceProvider&gt; serviceProviders = ServiceLoader.load(MessageServiceProvider.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历调用所有的实现类</span></span><br><span class="line">        <span class="keyword">for</span> (MessageServiceProvider serviceProvider : serviceProviders) &#123;</span><br><span class="line">            serviceProvider.sendMessage(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 Java 8 Optional 获取第一个 service，注意：findFirst()方法是JDK9版本提供的方法</span></span><br><span class="line">        Optional&lt;MessageServiceProvider&gt; firstService = serviceProviders.findFirst();</span><br><span class="line">        firstService.ifPresent(messageServiceProvider -&gt; messageServiceProvider.sendMessage(<span class="string">&quot;Hello Friend&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 Java 8 forEach() 方法</span></span><br><span class="line">        serviceProviders.forEach((service) -&gt; service.sendMessage(<span class="string">&quot;Have a Nice Day!&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 已加载服务总数</span></span><br><span class="line">        System.out.println(serviceProviders.stream().count());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们运行上面的程序时，我们得到以下输出：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Sending Email with Message = Hello</span><br><span class="line">Sending Push Notification with Message = Hello</span><br><span class="line">Sending Email with Message = Hello Friend</span><br><span class="line">Sending Email with Message = Have a Nice Day!</span><br><span class="line">Sending Push Notification with Message = Have a Nice Day!</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>下图显示了我们的最终项目结构和SPI组件：</p>
<p><img src="https://tva4.sinaimg.cn/large/008aQ1h9ly1gin5o6hmkuj30x40knwf4.jpg"></p>
<h3 id="ServiceLoader-结构"><a href="#ServiceLoader-结构" class="headerlink" title="ServiceLoader  结构"></a>ServiceLoader  结构</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JDK11 版本的 ServiceLoader，与JDK8的版本略有差异</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// The class or interface representing the service being loaded</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;S&gt; service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class of the service type</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String serviceName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The module layer used to locate providers; null when locating</span></span><br><span class="line">    <span class="comment">// providers using a class loader</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModuleLayer layer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class loader used to locate, load, and instantiate providers;</span></span><br><span class="line">    <span class="comment">// null when locating provider using a module layer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The access control context taken when the ServiceLoader is created</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessControlContext acc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The lazy-lookup iterator for iterator operations</span></span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; lookupIterator1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;S&gt; instantiatedProviders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The lazy-lookup iterator for stream operations</span></span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; lookupIterator2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Provider&lt;S&gt;&gt; loadedProviders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> loadedAllProviders; <span class="comment">// true when all providers loaded</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Incremented when reload is called</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> reloadCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaLangAccess LANG_ACCESS;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        LANG_ACCESS = SharedSecrets.getJavaLangAccess();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 可以看出 ServiceLoader 是延迟初始化服务接口实现类的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyClassPathLookupIterator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Provider</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">&quot;META-INF/services/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; providerNames = <span class="keyword">new</span> HashSet&lt;&gt;();  <span class="comment">// to avoid duplicates</span></span><br><span class="line">        Enumeration&lt;URL&gt; configs;</span><br><span class="line">        Iterator&lt;String&gt; pending;</span><br><span class="line"></span><br><span class="line">        Provider&lt;T&gt; nextProvider;</span><br><span class="line">        ServiceConfigurationError nextError;</span><br><span class="line"></span><br><span class="line">        LazyClassPathLookupIterator() &#123; &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们看一下ServiceLoader类的重要方法。</p>
<ul>
<li>load()：加载特定SPI服务的静态方法。</li>
<li>findFirst()：返回可用于该服务提供者的第一个服务。</li>
<li>forEach()：对于在此服务加载器实例中的每个服务提供者运行一些代码很有用。</li>
<li>stream()：返回此服务加载器中服务提供者的流。</li>
<li>iterator()：返回服务提供者的迭代器。</li>
<li>reload()：重新加载服务提供者实现类。当我们即时更改服务提供者实现类的配置并希望重新加载服务列表时，这很有用。</li>
</ul>
<h3 id="SPI-在开源框架中的应用"><a href="#SPI-在开源框架中的应用" class="headerlink" title="SPI 在开源框架中的应用"></a>SPI 在开源框架中的应用</h3><ul>
<li>数据库驱动加载接口实现类的加载：JDBC加载不同类型数据库的驱动</li>
<li>日志门面接口实现类加载：slf4j加载不同提供商的日志实现类</li>
<li>Spring中大量使用了SPI，比如：对servlet3.0规范对ServletContainerInitializer的实现、自动类型转换Type Conversion SPI(Converter SPI、Formatter SPI)等</li>
<li>Dubbo中也大量使用SPI的方式实现框架的扩展, 不过它对Java提供的原生SPI做了封装，允许用户扩展实现Filter接口</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Java SPI提供了一种在我们的应用程序中动态配置和加载服务的简便方法。但是，这在很大程度上取决于服务配置文件，并且文件中的任何更改都可能破坏应用程序。</p>
<p>使用Java SPI机制的优势是实现解耦，使得第三方服务模块的装配控制的逻辑与调用者的业务代码分离，而不是耦合在一起。应用程序可以根据实际业务情况启用框架扩展或替换框架组件。</p>
<p>相比使用提供接口jar包，供第三方服务模块实现接口的方式，SPI的方式使得源框架，不必关心接口的实现类的路径，可以不用通过下面的方式获取接口实现类。</p>
<ul>
<li>代码硬编码import 导入实现类</li>
<li>指定类全路径反射获取：例如在JDBC4.0之前，JDBC中获取数据库驱动类需要通过**Class.forName(“com.mysql.jdbc.Driver”)**，类似语句先动态加载数据库相关的驱动，然后再进行获取连接等的操作</li>
<li>第三方服务模块把接口实现类实例注册到指定地方，源框架从该处访问实例</li>
</ul>
<p>通过SPI的方式，第三方服务模块实现接口后，在第三方的项目代码的<code>META-INF/services</code>目录下的配置文件指定实现类的全路径名，框架即可找到实现类。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/ServiceLoader.html">ServiceLoader API文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Java技术</category>
      </categories>
      <tags>
        <tag>Java SPI</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring 事务</title>
    <url>/Spring%20%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1gimltdbhxjj30hs0b4750.jpg"></p>
<a id="more"></a>

<h2 id="Spring-事务"><a href="#Spring-事务" class="headerlink" title="Spring  事务"></a>Spring  事务</h2><h3 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h3><ul>
<li>原子性（Atomicity）：事务是一个原子操作，由一系列动作组成。事务的原子性确保动作要么全部完成，要么完全不起作用。</li>
<li>一致性（Consistency）：一旦事务完成（不管成功还是失败），系统必须确保它所建模的业务处于一致的状态，而不会是部分完成部分失败。在现实中的数据不应该被破坏。</li>
<li>隔离性（Isolation）：可能有许多事务会同时处理相同的数据，因此每个事务都应该与其他事务隔离开来，防止数据损坏。</li>
<li>持久性（Durability）：一旦事务完成，无论发生什么系统错误，它的结果都不应该受到影响，这样就能从任何系统崩溃中恢复过来。通常情况下，事务的结果被写到持久化存储器中。</li>
</ul>
<h3 id="Spring事务的配置方式"><a href="#Spring事务的配置方式" class="headerlink" title="Spring事务的配置方式"></a>Spring事务的配置方式</h3><p>Spring支持编程式事务管理以及声明式事务管理两种方式。</p>
<h4 id="编程式事务管理"><a href="#编程式事务管理" class="headerlink" title="编程式事务管理"></a>编程式事务管理</h4><p>编程式事务管理是侵入性事务管理，使用<code>TransactionTemplate</code>或者直接使用<code>PlatformTransactionManager</code>，对于编程式事务管理，Spring推荐使用<code>TransactionTemplate</code>。</p>
<h4 id="声明式事务管理"><a href="#声明式事务管理" class="headerlink" title="声明式事务管理"></a>声明式事务管理</h4><p>声明式事务管理建立在AOP之上，其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，执行完目标方法之后根据执行的情况提交或者回滚。编程式事务每次实现都要单独实现，但业务量大功能复杂时，使用编程式事务无疑是痛苦的，而声明式事务不同，声明式事务属于无侵入式，不会影响业务逻辑的实现，只需要在配置文件中做相关的事务规则声明或者通过注解的方式，便可以将事务规则应用到业务逻辑中。<br>显然声明式事务管理要优于编程式事务管理，这正是Spring倡导的非侵入式的编程方式。唯一不足的地方就是声明式事务管理的粒度是方法级别，而编程式事务管理是可以到代码块的，但是可以通过提取方法的方式完成声明式事务管理的配置。</p>
<h3 id="事务的传播机制"><a href="#事务的传播机制" class="headerlink" title="事务的传播机制"></a>事务的传播机制</h3><p>事务的传播性一般用在事务嵌套的场景，比如一个事务方法里面调用了另外一个事务方法，那么两个方法是各自作为独立的方法提交还是内层的事务合并到外层的事务一起提交，这就是需要事务传播机制的配置来确定怎么样执行。<br>常用的事务传播机制如下：</p>
<ul>
<li><code>PROPAGATION_REQUIRED</code><br>Spring默认的传播机制，能满足绝大部分业务需求，如果外层有事务，则当前事务加入到外层事务，一块提交，一块回滚。如果外层没有事务，新建一个事务执行</li>
<li><code>PROPAGATION_REQUES_NEW</code><br>该事务传播机制是每次都会新开启一个事务，同时把外层事务挂起，当当前事务执行完毕，恢复上层事务的执行。如果外层没有事务，执行当前新开启的事务即可</li>
<li><code>PROPAGATION_SUPPORT</code><br>如果外层有事务，则加入外层事务，如果外层没有事务，则直接使用非事务方式执行。完全依赖外层的事务</li>
<li><code>PROPAGATION_NOT_SUPPORT</code><br>该传播机制不支持事务，如果外层存在事务则挂起，执行完当前代码，则恢复外层事务，无论是否异常都不会回滚当前的代码</li>
<li><code> PROPAGATION_NEVER</code><br>该传播机制不支持外层事务，即如果外层有事务就抛出异常</li>
<li><code> PROPAGATION_MANDATORY</code><br>与NEVER相反，如果外层没有事务，则抛出异常</li>
<li><code>PROPAGATION_NESTED</code><br>该传播机制的特点是可以保存状态保存点，当前事务回滚到某一个点，从而避免所有的嵌套事务都回滚，即各自回滚各自的，如果子事务没有把异常吃掉，基本还是会引起全部回滚的。</li>
</ul>
<blockquote>
<p>传播规则回答了这样一个问题：一个新的事务应该被启动还是被挂起，或者是一个方法是否应该在事务性上下文中运行。</p>
</blockquote>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><p>事务的隔离级别定义：一个事务可能受其他并发事务活动影响的程度，可以把事务的隔离级别想象为这个事务对于事物处理数据的自私程度。</p>
<p>在一个典型的应用程序中，多个事务同时运行，经常会为了完成他们的工作而操作同一个数据。并发虽然是必需的，但是会导致以下问题：</p>
<ol>
<li><p>脏读（Dirty read）<br>脏读发生在一个事务读取了被另一个事务改写但尚未提交的数据时。如果这些改变在稍后被回滚了，那么第一个事务读取的数据就会是无效的。</p>
</li>
<li><p>不可重复读（Nonrepeatable read）<br>不可重复读发生在一个事务执行相同的查询两次或两次以上，但每次查询结果都不相同时。这通常是由于另一个并发事务在两次查询之间更新了数据。</p>
<blockquote>
<p>不可重复读重点在修改。</p>
</blockquote>
</li>
<li><p>幻读（Phantom reads）<br>幻读和不可重复读相似。当一个事务（T1）读取几行记录后，另一个并发事务（T2）插入了一些记录时，幻读就发生了。在后来的查询中，第一个事务（T1）就会发现一些原来没有的额外记录。</p>
<blockquote>
<p>幻读重点在新增或删除。</p>
</blockquote>
</li>
</ol>
<p>在理想状态下，事务之间将完全隔离，从而可以防止这些问题发生。然而，完全隔离会影响性能，因为隔离经常涉及到锁定在数据库中的记录（甚至有时是锁表）。完全隔离要求事务相互等待来完成工作，会阻碍并发。因此，可以根据业务场景选择不同的隔离级别。</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ISOLATION_DEFAULT</td>
<td>使用后端数据库默认的隔离级别</td>
</tr>
<tr>
<td>ISOLATION_READ_UNCOMMITTED</td>
<td>允许读取尚未提交的更改。可能导致脏读、幻读或不可重复读。</td>
</tr>
<tr>
<td>ISOLATION_READ_COMMITTED</td>
<td>（Oracle 默认级别）允许从已经提交的并发事务读取。可防止脏读，但幻读和不可重复读仍可能会发生。</td>
</tr>
<tr>
<td>ISOLATION_REPEATABLE_READ</td>
<td>（MYSQL默认级别）对相同字段的多次读取的结果是一致的，除非数据被当前事务本身改变。可防止脏读和不可重复读，但幻读仍可能发生。</td>
</tr>
<tr>
<td>ISOLATION_SERIALIZABLE</td>
<td>完全服从ACID的隔离级别，确保不发生脏读、不可重复读和幻影读。这在所有隔离级别中也是最慢的，因为它通常是通过完全锁定当前事务所涉及的数据表来完成的。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">事务的隔离级别</th>
<th align="center">脏读</th>
<th align="center">不可重复读</th>
<th align="center">幻读</th>
</tr>
</thead>
<tbody><tr>
<td align="center">读未提交（Read Uncommitted）</td>
<td align="center">✔</td>
<td align="center">✔</td>
<td align="center">✔</td>
</tr>
<tr>
<td align="center">读已提交（Read Committed）</td>
<td align="center"></td>
<td align="center">✔</td>
<td align="center">✔</td>
</tr>
<tr>
<td align="center">可重复读（Repeatable Read）</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">✔</td>
</tr>
<tr>
<td align="center">串行化（Serializable）</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Spring技术</category>
      </categories>
      <tags>
        <tag>Spring事务</tag>
      </tags>
  </entry>
  <entry>
    <title>gRPC 简单示例</title>
    <url>/gRPC%20%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B/</url>
    <content><![CDATA[<p><img src="https://tva4.sinaimg.cn/large/008aQ1h9ly1gimlo6iwmkj30lz0b03zk.jpg"></p>
<a id="more"></a>

<h2 id="gRPC-高性能的RPC框架简单示例"><a href="#gRPC-高性能的RPC框架简单示例" class="headerlink" title="gRPC  高性能的RPC框架简单示例"></a>gRPC  高性能的RPC框架简单示例</h2><h3 id="什么是-gRPC-？"><a href="#什么是-gRPC-？" class="headerlink" title="什么是 gRPC ？"></a>什么是 gRPC ？</h3><p>gRPC由 Google 开发，是一款跨语言、跨平台、开源的远程过程调用的(RPC)高性能框架。</p>
<p>在gRPC中，客户端应用程序可以直接在其他计算机上的服务器应用程序上调用方法，就好像它是本地对象一样，从而使您更轻松地创建分布式应用程序和服务。 与许多RPC系统一样，gRPC围绕定义服务的思想，指定可通过其参数和返回类型远程调用的方法。 在服务器端，服务器实现此接口并运行gRPC服务器以处理客户端调用。 在客户端，客户端具有一个存根（在某些语言中仅称为客户端），提供与服务器相同的方法。</p>
<h3 id="gRPC-示意图"><a href="#gRPC-示意图" class="headerlink" title="gRPC  示意图"></a>gRPC  示意图</h3><p><img src="http://wx3.sinaimg.cn/large/008aQ1h9ly1ghob5ynbfbj30kl0a2gm5.jpg" alt="image-20200812203844651"></p>
<p>gRPC 客户端和服务端可以在多种环境中运行和交互 - 从 Google 内部的服务器到你自己的笔记本，并且可以用任何 gRPC <a href="http://doc.oschina.net/grpc?t=58008#quickstart">支持的语言</a>来编写。所以，你可以很容易地用 Java 创建一个 gRPC 服务端，用 Go、Java、Python、Ruby等语言来创建客户端。此外，Google 最新 API 将有 gRPC 版本的接口，使你很容易地将 Google 的功能集成到你的应用里。</p>
<h3 id="使用-Protocol-buffers"><a href="#使用-Protocol-buffers" class="headerlink" title="使用  Protocol buffers"></a>使用  Protocol buffers</h3><p>gRPC 默认使用 <em>protocol buffers</em>，这是 Google 开源的一套成熟的结构数据序列化机制（当然也可以使用其他数据格式如 JSON）。正如你将在下方例子里所看到的，使用 <em>proto files</em> 创建 gRPC 服务，用 protocol buffers 消息类型来定义方法参数和返回类型。</p>
<h3 id="开始创建第一个-HelloRpc-proto-文件吧"><a href="#开始创建第一个-HelloRpc-proto-文件吧" class="headerlink" title="开始创建第一个 HelloRpc.proto  文件吧"></a>开始创建第一个 HelloRpc.proto  文件吧</h3><figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;com.chivalry.grpc.examples&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;HelloRpc&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> examples;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello service</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">HelloRpcService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> sayHello(HelloRpcRequest) <span class="keyword">returns</span> (HelloRpcReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gRPC request</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRpcRequest</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gRPC response</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRpcReply</span> </span>&#123;</span><br><span class="line">   <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven  依赖"></a>Maven  依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">grpc.version</span>&gt;</span>1.31.0<span class="tag">&lt;/<span class="name">grpc.version</span>&gt;</span><span class="comment">&lt;!-- CURRENT_GRPC_VERSION --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">protobuf.version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">protobuf.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">protoc.version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">protoc.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;protobuf.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span> <span class="comment">&lt;!-- not needed at runtime --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-testing<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.errorprone<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>error_prone_annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!-- prefer to use 2.3.3 or later --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mockito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mockito-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.28.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- gRPC 提供的生成Java代码的插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:$&#123;protoc.version&#125;:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:$&#123;grpc.version&#125;:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-enforcer-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>enforce<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>enforce<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">requireUpperBoundDeps</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="生成-RPC-Java-代码"><a href="#生成-RPC-Java-代码" class="headerlink" title="生成  RPC  Java 代码"></a>生成  RPC  Java 代码</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<p><img src="https://tva4.sinaimg.cn/large/008aQ1h9ly1ghqcyfhe5yj30q80m6jtr.jpg" alt="WX20200814-151102@2x"></p>
<h3 id="创建-RpcServer-端"><a href="#创建-RpcServer-端" class="headerlink" title="创建  RpcServer  端"></a>创建  RpcServer  端</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello Rpc Service examples</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-12 19:54:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloRpcServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(HelloRpcServer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务端监听端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port = <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Server server;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloRpcServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.server = ServerBuilder.forPort(port)</span><br><span class="line">                .addService(<span class="keyword">new</span> HelloRpcServerImpl())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.server.start();</span><br><span class="line">        logger.info(<span class="string">&quot;gRPC Server started, listening on &quot;</span> + port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Jvm shutdown sync off gRPC server</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;*** shutting down gRPC server since JVM is shutting down&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                HelloRpcServer.<span class="keyword">this</span>.stop();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace(System.err);</span><br><span class="line">            &#125;</span><br><span class="line">            System.err.println(<span class="string">&quot;*** server shut down&quot;</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</span><br><span class="line">            server.awaitTermination(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Await termination on the main thread since the grpc library uses daemon threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">blockUntilShutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</span><br><span class="line">            server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HelloRpcService implement</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloRpcServerImpl</span> <span class="keyword">extends</span> <span class="title">HelloRpcServiceGrpc</span>.<span class="title">HelloRpcServiceImplBase</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(HelloRpcRequest request, StreamObserver&lt;HelloRpcReply&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">            HelloRpcReply reply = HelloRpcReply.newBuilder().setName(<span class="string">&quot;Hello &quot;</span> + request.getName()).build();</span><br><span class="line">            <span class="comment">// StreamObserver 应答观察者，一个特殊的接口，服务器用应答来调用它</span></span><br><span class="line">            <span class="comment">// HelloReply 返回给客户端，然后表明我们已经完成了对 RPC 的处理。</span></span><br><span class="line">            responseObserver.onNext(reply);</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//  Main launches the server from the command line.</span></span><br><span class="line">        HelloRpcServer rpcService = <span class="keyword">new</span> HelloRpcServer();</span><br><span class="line">        rpcService.start();</span><br><span class="line">        rpcService.blockUntilShutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建-RpcClient-端"><a href="#创建-RpcClient-端" class="headerlink" title="创建 RpcClient  端"></a>创建 RpcClient  端</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello Rpc Client examples.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-12 20:16:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloRpcClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(HelloRpcClient.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HelloRpcServiceGrpc.HelloRpcServiceBlockingStub blockingStub;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloRpcClient</span><span class="params">(Channel channel)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将通道传递给代码可以使代码更易于测试，并且更易于重用通道。</span></span><br><span class="line">        <span class="keyword">this</span>.blockingStub = HelloRpcServiceGrpc.newBlockingStub(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用 RPC server</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Will try to greet &quot;</span> + name + <span class="string">&quot; ...&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建并填充一个 HelloRequest 发送给服务。</span></span><br><span class="line">        HelloRpcRequest request = HelloRpcRequest.newBuilder().setName(name).build();</span><br><span class="line">        HelloRpcReply rpcReply = blockingStub.sayHello(request);</span><br><span class="line">        logger.info(<span class="string">&quot;result: &quot;</span> + rpcReply.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// rpc服务地址</span></span><br><span class="line">        String target = <span class="string">&quot;localhost:8000&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建到服务器的通信通道，称为通道。 通道是线程安全的并且可重用。</span></span><br><span class="line">        <span class="comment">// 通常在应用程序的开头创建通道并重复使用它们，直到应用程序关闭.</span></span><br><span class="line">        ManagedChannel managedChannel = ManagedChannelBuilder</span><br><span class="line">                .forTarget(target)</span><br><span class="line">                <span class="comment">// 默认情况下，通道是安全的（通过SSL / TLS）。 对于该示例，我们禁用TLS以避免需要证书。</span></span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HelloRpcClient rpcClient = <span class="keyword">new</span> HelloRpcClient(managedChannel);</span><br><span class="line">            rpcClient.send(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// ManagedChannels使用诸如线程和TCP连接之类的资源。 </span></span><br><span class="line">            <span class="comment">// 为防止泄漏这些资源，当不再使用该通道时，应将其关闭。 </span></span><br><span class="line">            <span class="comment">// 如果可以再次使用，请使其运行。</span></span><br><span class="line">            managedChannel.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="跨平台扩展"><a href="#跨平台扩展" class="headerlink" title="跨平台扩展"></a>跨平台扩展</h3><p>你可以尝试用不同语言在客户端和服务端构建并运行例子。或者你可以尝试 gRPC 最有用的一个功能，不同的语言间的互操作性，即在不同的语言运行客户端和服务端。每个服务端和客户端使用从同一过 proto 文件生成的接口代码，则意味着任何 <code>HelloRpc</code> 客户端可以与任何 <code>HelloRpc</code> 服务端对话。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>gRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。</p>
]]></content>
      <categories>
        <category>Java技术</category>
      </categories>
      <tags>
        <tag>gRPC</tag>
        <tag>RPC框架</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之单例模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之单例模式"><a href="#每天一个设计模式之单例模式" class="headerlink" title="每天一个设计模式之单例模式"></a>每天一个设计模式之单例模式</h2><h3 id="经典的延迟实例化（懒加载）的单例模式实现"><a href="#经典的延迟实例化（懒加载）的单例模式实现" class="headerlink" title="经典的延迟实例化（懒加载）的单例模式实现"></a>经典的延迟实例化（懒加载）的单例模式实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 经典的单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 21:17:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton uniqueInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义单例模式"><a href="#定义单例模式" class="headerlink" title="定义单例模式"></a>定义单例模式</h3><p>单例模式确保一个类只有一个实例，并提供一个全局访问点。</p>
<h3 id="多线程下，经典的实现就不一定是唯一实例，通过加锁保证唯一实例"><a href="#多线程下，经典的实现就不一定是唯一实例，通过加锁保证唯一实例" class="headerlink" title="多线程下，经典的实现就不一定是唯一实例，通过加锁保证唯一实例"></a>多线程下，经典的实现就不一定是唯一实例，通过加锁保证唯一实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多线程下安全的经典的单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 21:17:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton uniqueInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不延迟实例化的单例模式"><a href="#不延迟实例化的单例模式" class="headerlink" title="不延迟实例化的单例模式"></a>不延迟实例化的单例模式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不延迟实例化的单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 21:17:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="comment">// JVM在加载这个类的时候，就会创建此实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用双重检查的单例模式"><a href="#使用双重检查的单例模式" class="headerlink" title="使用双重检查的单例模式"></a>使用双重检查的单例模式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双重检查的单例模式，使用volatile保证多线程之间实例初始化后保持可见</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 21:17:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton uniqueInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>单例模式确保程序中一个类最多只有一个实例</li>
<li>单例模式也提供访问这个实例的全局点</li>
<li>在Java中实现单例模式需要私有的构造器、一个静态方法和一个静态变量</li>
<li>确定在性能和资源上的限制，然后小心地选择适当的方案来实现单例，以解决多线程的安全问题</li>
<li>注意：如果使用多个类加载器，可能会导致单例失效而产生多个实例</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>单例模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之命令模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之命令模式"><a href="#每天一个设计模式之命令模式" class="headerlink" title="每天一个设计模式之命令模式"></a>每天一个设计模式之命令模式</h2><h3 id="第一个命令对象"><a href="#第一个命令对象" class="headerlink" title="第一个命令对象"></a>第一个命令对象</h3><p>实现命令接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 命令接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:42:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行命令接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现一个打开电灯的命令"><a href="#实现一个打开电灯的命令" class="headerlink" title="实现一个打开电灯的命令"></a>实现一个打开电灯的命令</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 电灯类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:44:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Light</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Light is on&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Light is off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;z</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开电灯的命令</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:43:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOnCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Light light;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightOnCommand</span><span class="params">(Light light)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.light = light;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        light.on();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建一个简单遥控器"><a href="#创建一个简单遥控器" class="headerlink" title="创建一个简单遥控器"></a>创建一个简单遥控器</h3><p>设计一个遥控器对象，它只有一个按钮和对应的插槽，可以控制一个简单装置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单的遥控器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:47:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleRemoteControl</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一个插槽</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Command slot;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置插槽控制的命令</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommand</span><span class="params">(Command command)</span> </span>&#123;</span><br><span class="line">        slot = command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按下按钮的功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buttonWasPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        slot.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="遥控器使用的简单测试"><a href="#遥控器使用的简单测试" class="headerlink" title="遥控器使用的简单测试"></a>遥控器使用的简单测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遥控器简单测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:49:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteControlTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化一个简单遥控器装置</span></span><br><span class="line">        SimpleRemoteControl remote = <span class="keyword">new</span> SimpleRemoteControl();</span><br><span class="line">        <span class="comment">// 创建一个电灯</span></span><br><span class="line">        Light light = <span class="keyword">new</span> Light();</span><br><span class="line">        <span class="comment">// 创建一个命令</span></span><br><span class="line">        LightOnCommand lightOnCommand = <span class="keyword">new</span> LightOnCommand(light);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把命令传给调用者</span></span><br><span class="line">        remote.setCommand(lightOnCommand);</span><br><span class="line">        <span class="comment">// 执行命令</span></span><br><span class="line">        remote.buttonWasPressed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义命令模式"><a href="#定义命令模式" class="headerlink" title="定义命令模式"></a>定义命令模式</h3><p>命令模式将“请求”封装成对象，以便使用不同的请求、队列或者日志来参数化其他对象。命令模式也支持可撤销的操作。</p>
<h3 id="定义命令模式类图"><a href="#定义命令模式类图" class="headerlink" title="定义命令模式类图"></a>定义命令模式类图</h3><p><img src="http://wx1.sinaimg.cn/large/008aQ1h9ly1ght0jhsvzdj30rq0mqqi2.jpg"></p>
<h3 id="实现一个复杂遥控器"><a href="#实现一个复杂遥控器" class="headerlink" title="实现一个复杂遥控器"></a>实现一个复杂遥控器</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遥控器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:59:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteControl</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一组打开命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Command[] onCommands;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一组关闭命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Command[] offCommands;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 撤销命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Command undoCommand;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoteControl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onCommands = <span class="keyword">new</span> Command[<span class="number">7</span>];</span><br><span class="line">        <span class="keyword">this</span>.offCommands = <span class="keyword">new</span> Command[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 预先设置无命令的Command</span></span><br><span class="line">        Command noCommand = <span class="keyword">new</span> NoCommand();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.onCommands[i] = noCommand;</span><br><span class="line">            <span class="keyword">this</span>.offCommands[i] = noCommand;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.undoCommand = noCommand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定插槽设置开和关命令</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slot</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> onCommand</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offCommand</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommand</span><span class="params">(<span class="keyword">int</span> slot, Command onCommand, Command offCommand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onCommands[slot] = onCommand;</span><br><span class="line">        <span class="keyword">this</span>.offCommands[slot] = offCommand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onButtonWasPushed</span><span class="params">(<span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onCommands[slot].execute();</span><br><span class="line">        <span class="keyword">this</span>.undoCommand = onCommands[slot];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offButtonWasPushed</span><span class="params">(<span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.offCommands[slot].execute();</span><br><span class="line">        <span class="keyword">this</span>.undoCommand = offCommands[slot];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undoButtonWasPushed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.undoCommand.undo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        buffer.append(<span class="string">&quot;\n------- Remote Control-------\n&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.onCommands.length; i++) &#123;</span><br><span class="line">            buffer.append(<span class="string">&quot;[slot &quot;</span>)</span><br><span class="line">                    .append(i)</span><br><span class="line">                    .append(<span class="string">&quot; ]&quot;</span>)</span><br><span class="line">                    .append(<span class="keyword">this</span>.onCommands[i].getClass().getName())</span><br><span class="line">                    .append(<span class="string">&quot;    &quot;</span>)</span><br><span class="line">                    .append(<span class="keyword">this</span>.offCommands[i].getClass().getName())</span><br><span class="line">                    .append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现其他命令"><a href="#实现其他命令" class="headerlink" title="实现其他命令"></a>实现其他命令</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开电灯的命令</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:43:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOnCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Light light;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightOnCommand</span><span class="params">(Light light)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.light = light;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        light.on();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        light.off();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭电灯的命令</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 20:43:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOffCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Light light;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightOffCommand</span><span class="params">(Light light)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.light = light;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        light.off();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        light.on();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 音响类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 21:09:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stereo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stereo</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s stereo is on\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s stereo is off\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s stereo is et for CD input\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVolume</span><span class="params">(<span class="keyword">int</span> volume)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s stereo volume se to 11\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 音响命令对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 21:09:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StereoOnWithCDCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Stereo stereo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StereoOnWithCDCommand</span><span class="params">(Stereo stereo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stereo = stereo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stereo.on();</span><br><span class="line">        stereo.setCD();</span><br><span class="line">        stereo.setVolume(<span class="number">11</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stereo.off();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 音响命令对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 21:09:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StereoOffWithCDCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Stereo stereo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StereoOffWithCDCommand</span><span class="params">(Stereo stereo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stereo = stereo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stereo.off();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stereo.on();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试我们的遥控器"><a href="#测试我们的遥控器" class="headerlink" title="测试我们的遥控器"></a>测试我们的遥控器</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RemoteControl remoteControl = <span class="keyword">new</span> RemoteControl();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将所有装置创建在合适的位置</span></span><br><span class="line">        Light livingRoomLight = <span class="keyword">new</span> Light(<span class="string">&quot;Living Room&quot;</span>);</span><br><span class="line">        Light kitchenLight = <span class="keyword">new</span> Light(<span class="string">&quot;Kitchen&quot;</span>);</span><br><span class="line">        Stereo stereo = <span class="keyword">new</span> Stereo(<span class="string">&quot;Living Room&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建所有电灯命令对象</span></span><br><span class="line">        LightOnCommand livingRoomLightOn = <span class="keyword">new</span> LightOnCommand(livingRoomLight);</span><br><span class="line">        LightOnCommand kitchenLightLightOn = <span class="keyword">new</span> LightOnCommand(kitchenLight);</span><br><span class="line">        LightOffCommand livingRoomLightOff = <span class="keyword">new</span> LightOffCommand(livingRoomLight);</span><br><span class="line">        LightOffCommand kitchenLightLightOff = <span class="keyword">new</span> LightOffCommand(kitchenLight);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建音响的开与关命令</span></span><br><span class="line">        StereoOnWithCDCommand stereoOnWithCD = <span class="keyword">new</span> StereoOnWithCDCommand(stereo);</span><br><span class="line">        StereoOffWithCDCommand stereoOffWithCD = <span class="keyword">new</span> StereoOffWithCDCommand(stereo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将各命令装置在指定的插槽</span></span><br><span class="line">        remoteControl.setCommand(<span class="number">0</span>, livingRoomLightOn, livingRoomLightOff);</span><br><span class="line">        remoteControl.setCommand(<span class="number">1</span>, kitchenLightLightOn, kitchenLightLightOff);</span><br><span class="line">        remoteControl.setCommand(<span class="number">2</span>, stereoOnWithCD, stereoOffWithCD);</span><br><span class="line">        System.out.println(remoteControl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行遥控器的按钮</span></span><br><span class="line">        remoteControl.onButtonWasPushed(<span class="number">0</span>);</span><br><span class="line">        remoteControl.offButtonWasPushed(<span class="number">0</span>);</span><br><span class="line">        remoteControl.undoButtonWasPushed();</span><br><span class="line"></span><br><span class="line">        remoteControl.onButtonWasPushed(<span class="number">1</span>);</span><br><span class="line">        remoteControl.offButtonWasPushed(<span class="number">1</span>);</span><br><span class="line">        remoteControl.undoButtonWasPushed();</span><br><span class="line"></span><br><span class="line">        remoteControl.onButtonWasPushed(<span class="number">2</span>);</span><br><span class="line">        remoteControl.offButtonWasPushed(<span class="number">2</span>);</span><br><span class="line">        remoteControl.undoButtonWasPushed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用宏命令"><a href="#使用宏命令" class="headerlink" title="使用宏命令"></a>使用宏命令</h3><p>每个遥控器都应该具备“Party模式”</p>
<ul>
<li>先创建想要进入宏的命令集合：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建所有的装置，电灯、电视、音响和热水器</span></span><br><span class="line">Light light = <span class="keyword">new</span> Light(<span class="string">&quot;Living Room&quot;</span>);</span><br><span class="line">TV tv = <span class="keyword">new</span> TV(<span class="string">&quot;Living Room&quot;</span>);</span><br><span class="line">Stereo stereo = <span class="keyword">new</span> Stereo(<span class="string">&quot;Living Room&quot;</span>);</span><br><span class="line">Hottub hottub = <span class="keyword">new</span> Hottub();</span><br><span class="line"><span class="comment">// 创建所有的On来控制它们</span></span><br><span class="line">LightOnCommand lightOn = <span class="keyword">new</span> LightOnCommand(light);</span><br><span class="line">StereoOnCommand sterenOn = <span class="keyword">new</span> StereoOnCommand(stereo);</span><br><span class="line">TVOnCommand tvOn = <span class="keyword">new</span> TVOnCommand(tv);</span><br><span class="line">HottubOnCommand hottubOn = <span class="keyword">new</span> HottubOnCommand(hottub);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建所有的off来控制它们</span></span><br><span class="line">LightOffCommand lightOff = <span class="keyword">new</span> LightOffCommand(light);</span><br><span class="line">StereoOffCommand sterenOff = <span class="keyword">new</span> StereoOffCommand(stereo);</span><br><span class="line">TVOffCommand tvOff = <span class="keyword">new</span> TVOnCffmmand(tv);</span><br><span class="line">HottubOffCommand hottubOff = <span class="keyword">new</span> HottubOnCffmmand(hottub);</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来创建两个数组，其中记录开启命令，另一个记录关闭命令，并在数组内放入对应的命令</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 宏命令，一组命令</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-16 21:45:21</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MacroCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Command[] commands;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MacroCommand</span><span class="params">(Command[] commands)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.commands = commands;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Command command : commands) &#123;</span><br><span class="line">            command.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Command command : commands) &#123;</span><br><span class="line">            command.undo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 数组用来记录开启命令，另一个数组用来记录关闭命令</span></span><br><span class="line">Command[] partyOn = &#123; lightOn, stereoOn, tvOn, hottubOn &#125;;</span><br><span class="line">Command[] partyOff = &#123; lightOff, sterenOff, tvOff, hottubOff &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建对应的宏持有它们</span></span><br><span class="line">MacroCommand partyOnMacro = <span class="keyword">new</span> MacroCommand(partyOn);</span><br><span class="line">MacroCommand partyOffMacro = <span class="keyword">new</span> MacroCommand(partyOff);</span><br></pre></td></tr></table></figure>

<ul>
<li>然后将宏命令指定给我们所希望的按钮：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将宏命令指定给一个按钮</span></span><br><span class="line">remoteControl.setCommand(<span class="number">4</span>, partyOnMacro, partyOffMacro);</span><br></pre></td></tr></table></figure>

<ul>
<li>最后，只需按下一些按钮，测试即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(remoteControl);</span><br><span class="line">System.out.println(<span class="string">&quot;--- Pushing Macro On ---&quot;</span>);</span><br><span class="line">remoteControl.onButtonWasPushed(<span class="number">4</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;--- Pushing Macro Off ---&quot;</span>);</span><br><span class="line">remoteControl.offButtonWasPushed(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>命令模式将发出请求的对象和执行请求的对象解耦</li>
<li>在被解耦的两者之间是通过命令对象进行沟通的。命令对象封装了接收者和一个或一组动作</li>
<li>调用者通过命令对象的execute()发出请求，这会使得接收者的动作被调用</li>
<li>调用者可以接受命令当做参数，甚至在运行时动态地进行</li>
<li>命令可以支持撤销，做法是实现一个undo()方法来回到execute()被执行的状态</li>
<li>宏命令是命令的一种简单的延伸，允许调用多个命令。宏方法也可以支持撤销</li>
<li>实际操作时，很常见使用“聪明”命令对象，也就是直接实现了请求，而不是将工作委托给接收者</li>
<li>命令也可以用来实习日志和事务系统</li>
</ol>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>命令模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之外观模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之外观模式"><a href="#每天一个设计模式之外观模式" class="headerlink" title="每天一个设计模式之外观模式"></a>每天一个设计模式之外观模式</h2><h3 id="甜蜜的家庭影院"><a href="#甜蜜的家庭影院" class="headerlink" title="甜蜜的家庭影院"></a>甜蜜的家庭影院</h3><p>在我们进入外观模式的细节之前，让我们看一个风行全美的热潮：建立自己的家庭影院。你组装了一套杀手级的系统，内含DVD播放器、投影机、自动屏幕、环绕立体声，甚至还有爆米花机。</p>
<p>看看我们的组件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功放</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-24 20:59:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Amplifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Tuner tuner;</span><br><span class="line">    <span class="keyword">private</span> DvdPlayer dvdPlayer;</span><br><span class="line">    <span class="keyword">private</span> CdPlayer cdPlayer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier on&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier setCd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDvd</span><span class="params">(DvdPlayer dvdPlayer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dvdPlayer = dvdPlayer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStereoSound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier setStereoSound&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSurroundSound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier setSurroundSound&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTuner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier setTuner&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVolume</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Amplifier setVolume &quot;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DVD播放机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-24 21:02:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DvdPlayer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Amplifier amplifier;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer on&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer eject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer pause&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(String movie)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer play &quot;</span> + movie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSurroundAudio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer setSurroundAudio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTwoChannelAudio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer setTwoChannelAudio&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DvdPlayer stop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 投影仪</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-24 21:04:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Projector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DvdPlayer dvdPlayer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Projector on&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Projector off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tvMode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Projector tvMode&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wideScreenMode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Projector wideScreenMode&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 剧院灯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-24 21:06:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheaterLights</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TheaterLights on&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TheaterLights off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dim</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TheaterLights dim &quot;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 爆米花</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-24 21:05:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PopcornPopper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PopcornPopper on&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PopcornPopper off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PopcornPopper pop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你花了几个星期布线、挂上投影机、连接所有的装置并进行微调。现在，你准备开始享受一部电影……</p>
<h3 id="观赏电影（用困难的方式）"><a href="#观赏电影（用困难的方式）" class="headerlink" title="观赏电影（用困难的方式）"></a>观赏电影（用困难的方式）</h3><p>挑选一部DVD影片，然后先执行一些任务。</p>
<p>打开爆米花机、开始爆米花、将灯光调暗、放下屏幕、打开投影机、将投影机 的输入切换到DVD、将投影机设置在宽屏模式、打开功放、将功放的输入设置为DVD、将功放设置为环绕立体声、调节功放音量、打开DVD播放器、开始播放DVD。。。</p>
<p>累死人了，打开这么多开关。。。。没错看完电影还要将这些关掉。让我们看看外观模式如何来解决这团混乱，好让你能轻易的享受电影。。。</p>
<h3 id="构造家庭影院的外观"><a href="#构造家庭影院的外观" class="headerlink" title="构造家庭影院的外观"></a>构造家庭影院的外观</h3><p>让我们逐步构造家庭影院外观：第一步是使用组合让外观能够访问子系统中所有的组件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 家庭影院</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-24 21:09:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeTheaterFacade</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Amplifier amplifier;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tuner tuner;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DvdPlayer dvdPlayer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CdPlayer cdPlayer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Projector projector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TheaterLights theaterLights;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Screen screen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PopcornPopper popcornPopper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HomeTheaterFacade</span><span class="params">(Amplifier amplifier, Tuner tuner, DvdPlayer dvdPlayer,</span></span></span><br><span class="line"><span class="function"><span class="params">                             CdPlayer cdPlayer, Projector projector,</span></span></span><br><span class="line"><span class="function"><span class="params">                             TheaterLights theaterLights, Screen screen,</span></span></span><br><span class="line"><span class="function"><span class="params">                             PopcornPopper popcornPopper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.amplifier = amplifier;</span><br><span class="line">        <span class="keyword">this</span>.tuner = tuner;</span><br><span class="line">        <span class="keyword">this</span>.dvdPlayer = dvdPlayer;</span><br><span class="line">        <span class="keyword">this</span>.cdPlayer = cdPlayer;</span><br><span class="line">        <span class="keyword">this</span>.projector = projector;</span><br><span class="line">        <span class="keyword">this</span>.theaterLights = theaterLights;</span><br><span class="line">        <span class="keyword">this</span>.screen = screen;</span><br><span class="line">        <span class="keyword">this</span>.popcornPopper = popcornPopper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将我们之前手动进行的每项任务依次处理。请注意，每项任务都是委托子系统中相应的组件处理的</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watchMovie</span><span class="params">(String movie)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Get Ready to watch a movie....&quot;</span>);</span><br><span class="line">        popcornPopper.on();</span><br><span class="line">        popcornPopper.pop();</span><br><span class="line">        theaterLights.dim(<span class="number">10</span>);</span><br><span class="line">        screen.down();</span><br><span class="line">        projector.on();</span><br><span class="line">        projector.wideScreenMode();</span><br><span class="line">        amplifier.on();</span><br><span class="line">        amplifier.setDvd(dvdPlayer);</span><br><span class="line">        amplifier.setSurroundSound();</span><br><span class="line">        amplifier.setVolume(<span class="number">5</span>);</span><br><span class="line">        dvdPlayer.on();</span><br><span class="line">        dvdPlayer.play(movie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭一切</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endMovie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Shutting movie theater down...&quot;</span>);</span><br><span class="line">        popcornPopper.off();</span><br><span class="line">        theaterLights.on();</span><br><span class="line">        screen.up();</span><br><span class="line">        projector.off();</span><br><span class="line">        amplifier.off();</span><br><span class="line">        dvdPlayer.stop();</span><br><span class="line">        dvdPlayer.eject();</span><br><span class="line">        dvdPlayer.off();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="观赏电影（用轻松的方式）"><a href="#观赏电影（用轻松的方式）" class="headerlink" title="观赏电影（用轻松的方式）"></a>观赏电影（用轻松的方式）</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeTheaterTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化各组件</span></span><br><span class="line">        Amplifier amplifier = <span class="keyword">new</span> Amplifier();</span><br><span class="line">        Tuner tuner = <span class="keyword">new</span> Tuner();</span><br><span class="line">        DvdPlayer dvdPlayer = <span class="keyword">new</span> DvdPlayer();</span><br><span class="line">        CdPlayer cdPlayer = <span class="keyword">new</span> CdPlayer();</span><br><span class="line">        Projector projector = <span class="keyword">new</span> Projector();</span><br><span class="line">        TheaterLights theaterLights = <span class="keyword">new</span> TheaterLights();</span><br><span class="line">        Screen screen = <span class="keyword">new</span> Screen();</span><br><span class="line">        PopcornPopper popcornPopper = <span class="keyword">new</span> PopcornPopper();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据子系统所有的组件来实例化外观</span></span><br><span class="line">        HomeTheaterFacade homeTheaterFacade = <span class="keyword">new</span> HomeTheaterFacade(amplifier, tuner, dvdPlayer, </span><br><span class="line">                                           cdPlayer, projector, theaterLights, screen, popcornPopper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用简化接口来开启电影</span></span><br><span class="line">        homeTheaterFacade.watchMovie(<span class="string">&quot;Raiders of the Lost Ark&quot;</span>);</span><br><span class="line">        <span class="comment">// 然后关闭电影</span></span><br><span class="line">        homeTheaterFacade.endMovie();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义外观模式"><a href="#定义外观模式" class="headerlink" title="定义外观模式"></a>定义外观模式</h3><p><strong>外观模式</strong>提供了一个统一的接口，用来访问子系统中的一群接口。外观定义了一个高层接口，让子系统更容易使用。</p>
<h3 id="“最少知识”原则"><a href="#“最少知识”原则" class="headerlink" title="“最少知识”原则"></a>“最少知识”原则</h3><p>最少知识原则告诉我们要减少对象之间的交互，只留下几个“密友”。这个原则通常是这么说的：</p>
<p>最少知识原则：只和你的密友谈话。</p>
<p>这个原则希望我们在设计中，不要让太多的类耦合在一起，免得修改系统中的一部分，会影响到其他部分。如果许多类之间相互依赖，那么这个系统就会变成一个易碎的系统，它需要花许多成本维护，也会因为太复杂而不容易被其他人理解。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>当需要简化并统一一个很大的接口或则一群复杂的接口时，使用外观</li>
<li>外观将客户从一个复杂的子系统中解耦</li>
<li>实现一个外观，需要将子系统组合进外观中，然后将工作委托给子系统执行</li>
<li>你可以为一个子系统实现一个以上的外观</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>外观模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之模板方法模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之模板方法模式"><a href="#每天一个设计模式之模板方法模式" class="headerlink" title="每天一个设计模式之模板方法模式"></a>每天一个设计模式之模板方法模式</h2><p>封装算法，好让子类可以在任何时候都可以将自己挂接近运算里。</p>
<h3 id="咖啡示例"><a href="#咖啡示例" class="headerlink" title="咖啡示例"></a>咖啡示例</h3><p>咖啡师傅训练手册：各位师傅！准备饮料时，请精确地遵循下面的冲泡法</p>
<p>咖啡冲泡法：</p>
<ol>
<li>把水煮沸</li>
<li>用沸水冲泡咖啡</li>
<li>把咖啡倒进杯子</li>
<li>加糖和牛奶</li>
</ol>
<p>茶冲泡法：</p>
<ol>
<li>把水煮沸</li>
<li>用沸水冲泡茶叶</li>
<li>把茶倒进杯子</li>
<li>加柠檬</li>
</ol>
<h3 id="快速搞定咖啡和茶的类"><a href="#快速搞定咖啡和茶的类" class="headerlink" title="快速搞定咖啡和茶的类"></a>快速搞定咖啡和茶的类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 咖啡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:38:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Coffee</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 制作咖啡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareRecipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 烧水</span></span><br><span class="line">        boilWater();</span><br><span class="line">        <span class="comment">// 冲泡咖啡粉</span></span><br><span class="line">        brewCoffeeGrinds();</span><br><span class="line">        <span class="comment">// 倒入杯子</span></span><br><span class="line">        pourInCup();</span><br><span class="line">        <span class="comment">// 加糖和牛奶</span></span><br><span class="line">        addSugarAndMilk();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addSugarAndMilk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding Sugar and Milk&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pourInCup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Pouring into cup&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">brewCoffeeGrinds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dripping Coffee through filter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">boilWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Boiling water&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 茶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:41:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tea</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 制作茶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareRecipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 烧水</span></span><br><span class="line">        boilWater();</span><br><span class="line">        <span class="comment">// 冲泡茶包</span></span><br><span class="line">        steepTeaBag();</span><br><span class="line">        <span class="comment">// 倒入杯子</span></span><br><span class="line">        pourInCup();</span><br><span class="line">        <span class="comment">// 加柠檬</span></span><br><span class="line">        addLemon();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addLemon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding Lemon&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pourInCup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Pouring into cup&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">steepTeaBag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Steeping the tea&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">boilWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Boiling water&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="抽象-prepareRecipe"><a href="#抽象-prepareRecipe" class="headerlink" title="抽象 prepareRecipe()"></a>抽象 prepareRecipe()</h3><p>将咖啡和茶的制作共同点抽取出来，让我们每个子类中逐步抽象prepareRecipe()…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 咖啡因饮料抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:52:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CaffeineBeverage</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们不希望子类修改这个方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">prepareRecipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        boilWater();</span><br><span class="line">        brew();</span><br><span class="line">        pourInCup();</span><br><span class="line">        addCondiments();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 冲泡，因为咖啡和茶的冲泡方法不一样，交给子类去实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加调味品，子类可以自定义添加调味品</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 装杯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pourInCup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Pouring into cup&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 烧水</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">boilWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Boiling water&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改造我们的咖啡和茶类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 咖啡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:38:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Coffee</span> <span class="keyword">extends</span> <span class="title">CaffeineBeverage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dripping Coffee through filter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding Sugar and Milk&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 茶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:41:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tea</span> <span class="keyword">extends</span> <span class="title">CaffeineBeverage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Steeping the tea&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding Lemon&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="认识模板方法"><a href="#认识模板方法" class="headerlink" title="认识模板方法"></a>认识模板方法</h3><p>基本上，我们刚刚实现的就是模板方法模式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CaffeineBeverage</span> </span>&#123;</span><br><span class="line">    <span class="comment">// prepareRecipe() 就是我们的模板方法，该模板方法里的有些方法是超类处理，有些是子类处理</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">prepareRecipe</span><span class="params">()</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        boilWater();</span><br><span class="line">        brew();</span><br><span class="line">        pourInCup();</span><br><span class="line">        addCondiments();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 需要由子类提供的方法，必须在超类中声明为抽象</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pourInCup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">boilWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 实现</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>模板方法定义了一个算法的步骤，并允许子类为一个或多个步骤提供实现。</strong></p>
<h3 id="走，泡茶去…"><a href="#走，泡茶去…" class="headerlink" title="走，泡茶去….."></a>走，泡茶去…..</h3><ol>
<li><p>首先我们需要一个茶对象… </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Tea myTea = <span class="keyword">new</span> Tea();</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后我们调用这个模板方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">myTea.prepareRecipe();</span><br></pre></td></tr></table></figure>
</li>
<li><p>首先，把水煮沸，由超类进行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">boilWater();</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来，我们需要泡茶，这件事情只有子类才知道怎么做</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">brew();</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在把茶倒进杯子中，所有的饮料做法都一样，所以这件事情发生在超类中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">pourInCup();</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，我们加紧调料，由于调料是各个饮料独有的，所以由子类来实现它</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">addCondiments();</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="定义模板方法模式"><a href="#定义模板方法模式" class="headerlink" title="定义模板方法模式"></a>定义模板方法模式</h3><p><strong>模板方法模式</strong>在一个方法中定义一个算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以在不改变算法结构的情况下，重新定义算法中的某些步骤。</p>
<h3 id="对模板方法进行挂钩"><a href="#对模板方法进行挂钩" class="headerlink" title="对模板方法进行挂钩"></a>对模板方法进行挂钩</h3><p>钩子是一种被声明在抽象类中的方法，但只有空的或者默认的实现。钩子的存在，可以让子类有能力对算法的不同点进行挂钩。要不要挂钩，由子类来决定。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 咖啡因饮料抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:52:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CaffeineBeverageWithHook</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们不希望子类修改这个方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">prepareRecipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        boilWater();</span><br><span class="line">        brew();</span><br><span class="line">        pourInCup();</span><br><span class="line">        <span class="comment">// 如果顾客想要调料，才调用添加调料的方法</span></span><br><span class="line">        <span class="keyword">if</span> (customerWantsCondiments()) &#123;</span><br><span class="line">            addCondiments();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 冲泡，因为咖啡和茶的冲泡方法不一样，交给子类去实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加调味品，子类可以自定义添加调味品</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 装杯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pourInCup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Pouring into cup&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 烧水</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">boilWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Boiling water&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这是一个钩子，子类可以覆盖这个方法， 但不见得要这么做</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">customerWantsCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用钩子"><a href="#使用钩子" class="headerlink" title="使用钩子"></a>使用钩子</h3><p>为了使用钩子，我们在子类中覆盖它。在这里，钩子控制了咖啡因饮料是否执行某部分算法；说得更明确一些，就是饮料中是否要加进调料。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 茶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-25 21:41:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TeaWithHook</span> <span class="keyword">extends</span> <span class="title">CaffeineBeverageWithHook</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Steeping the tea&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding Lemon&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 覆盖钩子，实现自己的功能，根据用户输入，是否需要添加配料</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">customerWantsCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getUserInput().toLowerCase().startsWith(<span class="string">&quot;y&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户是否要加调料</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getUserInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;Would you like lemon with your tea (y/n)?&quot;</span>);</span><br><span class="line"></span><br><span class="line">        BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> in.readLine();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;no&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行测试程序"><a href="#执行测试程序" class="headerlink" title="执行测试程序"></a>执行测试程序</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeverageTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TeaWithHook teaWithHook = <span class="keyword">new</span> TeaWithHook();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Make tea...&quot;</span>);</span><br><span class="line">        teaWithHook.prepareRecipe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Make tea...</span><br><span class="line">Boiling water</span><br><span class="line">Steeping the tea</span><br><span class="line">Pouring into cup</span><br><span class="line">Would you like lemon with your tea (y/n)? y</span><br><span class="line">Adding Lemon</span><br></pre></td></tr></table></figure>

<h3 id="好莱坞原则"><a href="#好莱坞原则" class="headerlink" title="好莱坞原则"></a>好莱坞原则</h3><p>我们有一个新的设计原则，称为好莱坞原则：</p>
<p><strong>好莱坞原则</strong>：别调用（打电话给）我们，我们会调用（打电话给）你。</p>
<h3 id="好莱坞原则和模板方法"><a href="#好莱坞原则和模板方法" class="headerlink" title="好莱坞原则和模板方法"></a>好莱坞原则和模板方法</h3><p>好莱坞原则和模板方法之间的连接还算明细：当我们设计模板方法模式时，我们告诉子类，“不要调用我们，我们会调用你”。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>模板方法定义了算法的步骤，把这些步骤的实现延迟到了子类</li>
<li>模板方法模式为我们提供了一种代码复用的重要技巧</li>
<li>模板方法的抽象类可以定义具体方法、抽象方法和钩子</li>
<li>抽象方法由子类实现</li>
<li>钩子是一种方法，它在抽象类中不做事，或者只做默认的事情，子类可以选择要不要去覆盖它</li>
<li>为了防止子类改变模板方法中的算法，可以将模板方法声明为final</li>
<li>好莱坞原则告诉我们，将决策权放在高层模块中，以便决定如何以及何时调用底层模块</li>
<li>你将在真实世界代码中看到模板方法模式的许多变体，不要期待它们全都是一眼就可以被你认出的</li>
<li>策略模式和模板方法模式都封装算法，一个用组合，一个用继承</li>
<li>工厂方法是模板方法的一种特殊版本</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>模板方法模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之状态模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之状态模式"><a href="#每天一个设计模式之状态模式" class="headerlink" title="每天一个设计模式之状态模式"></a>每天一个设计模式之状态模式</h2><h3 id="糖果机的需求"><a href="#糖果机的需求" class="headerlink" title="糖果机的需求"></a>糖果机的需求</h3><p>我们公司接到糖果公司的需求，要设计一个糖果机的程序，糖果机有四个状态，未投币，已投币，售出，售罄这四个状态，当客户投币后，就开始转动曲柄，然后发放糖果。当糖果售罄时，就不在允许投入币了。所以希望我们设计能够尽量有弹性而且好维护的程序，在将来有可能增加更多的行为。</p>
<h3 id="糖果机初版代码实现"><a href="#糖果机初版代码实现" class="headerlink" title="糖果机初版代码实现"></a>糖果机初版代码实现</h3><p>现在我们来实现糖果机。我们知道要利用实例变量持有当前的状态，然后需要处理所有可能发生的动作、行为和状态的转换。我们需要实现的工作包括：投币、退币、转动曲柄和发放糖果；也需要检查糖果是否售罄。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 糖果机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 21:18:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GumballMachine</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 售罄</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOLD_OUT = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 没有投币</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_QUARTER = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 已投币</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HAS_QUARTER = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 售出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SOLD = <span class="number">3</span>;</span><br><span class="line">    <span class="comment">// 当前状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state = SOLD_OUT;</span><br><span class="line">    <span class="comment">// 糖果数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GumballMachine</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            state = NO_QUARTER;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投币方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state == HAS_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You can&#x27;t insert another quarter.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == NO_QUARTER) &#123;</span><br><span class="line">            state = HAS_QUARTER;</span><br><span class="line">            System.out.println(<span class="string">&quot;You inserted a quarter.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SOLD_OUT) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You cant&#x27;t insert a quarter, the machine is sold out.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SOLD) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Please wait, we&#x27;re already giving you a gumball.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退币方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state == HAS_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Quarter returned.&quot;</span>);</span><br><span class="line">            state = NO_QUARTER;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == NO_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You haven&#x27;t inserted a quarter.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SOLD) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Sorry, you already turned the crank.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SOLD_OUT) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You can&#x27;t eject, you haven&#x27;t inserted a quarter yet.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转动曲柄方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state == SOLD) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Turning twice doesn&#x27;t get you another gumball.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == NO_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You turned but there&#x27;s no quarter.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SOLD_OUT) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You turned, but there are no gumballs.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == HAS_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You turned...&quot;</span>);</span><br><span class="line">            state = SOLD;</span><br><span class="line">            dispense();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发放糖果方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state == SOLD) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;A gumball comes rolling out the solt.&quot;</span>);</span><br><span class="line">            count--;</span><br><span class="line">            <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Oops, out of gumballs.&quot;</span>);</span><br><span class="line">                state = SOLD_OUT;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                state = NO_QUARTER;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == NO_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;You need to pay first.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SOLD_OUT) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;No gumball dispensed.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == HAS_QUARTER) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;No gumball dispensed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;GumballMachine&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;state=&quot;</span> + state +</span><br><span class="line">                <span class="string">&quot;, count=&quot;</span> + count +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试糖果机"><a href="#测试糖果机" class="headerlink" title="测试糖果机"></a>测试糖果机</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GumballMachineTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建装有5个糖果的糖果机</span></span><br><span class="line">        GumballMachine gumballMachine = <span class="keyword">new</span> GumballMachine(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印机器状态</span></span><br><span class="line">        System.out.println(gumballMachine);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 投币</span></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        <span class="comment">// 转动曲柄</span></span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次打印机器状态</span></span><br><span class="line">        System.out.println(gumballMachine);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 投币</span></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        <span class="comment">// 退币</span></span><br><span class="line">        gumballMachine.ejectQuarter();</span><br><span class="line">        <span class="comment">// 转动曲柄</span></span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 再次打印机器状态</span></span><br><span class="line">        System.out.println(gumballMachine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="新的需求"><a href="#新的需求" class="headerlink" title="新的需求"></a>新的需求</h3><p>糖果公司在程序运行一段时间后，想要新增一个功能，有一个幸运玩家，就是售出糖果的时候，有10%的几率会掉出2课糖果，而不是一颗。</p>
<p>面对原有的程序，我们就必须要新增一个状态，称为“赢家”。还不太麻烦，不过在每个方法的条件判断里处理“赢家”状态；这可有的忙了。随着新的行为出现，这个程序越来越难以适用。</p>
<h3 id="新的设计"><a href="#新的设计" class="headerlink" title="新的设计"></a>新的设计</h3><p>我们的计划是：不要维护我们现有的代码，我们重写它以便于将状态对象封装在各自的类中，然后在动作发生时委托给当前状态。</p>
<ol>
<li>首先，我们定义一个State接口。在这个接口内，糖果机的每个动作都有一个对应的方法。</li>
<li>然后为机器中的每个状态实现状态类。这些类将负责对应的状态下进行机器的行为</li>
<li>最后，我们要摆脱旧的条件代码，取而代之的方式是，将动作委托到状态类。</li>
</ol>
<h3 id="定义状态模式"><a href="#定义状态模式" class="headerlink" title="定义状态模式"></a>定义状态模式</h3><p><strong>状态模式</strong>：允许对象在内部状态改变时改变它的行为，对象看起来好像修改了它的类。</p>
<h3 id="实现状态类"><a href="#实现状态类" class="headerlink" title="实现状态类"></a>实现状态类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 状态接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 22:00:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投币</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退币方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转动曲柄方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发放糖果方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 未投币状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 22:01:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoQuarterState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NoQuarterState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You inserted a quarter.&quot;</span>);</span><br><span class="line">        gumballMachine.setState(gumballMachine.getHasQuarterState());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You haven&#x27;t inserted a quarter.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You turned, but there&#x27;s no quarter.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You need to pay first.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 已投币状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 22:09:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HasQuarterState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HasQuarterState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You can&#x27;t insert another quarter.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Quarter returned.&quot;</span>);</span><br><span class="line">        gumballMachine.setState(gumballMachine.getNoQuarterState());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You turned...&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> winner = random.nextInt(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (winner == <span class="number">0</span> &amp;&amp; gumballMachine.getCount() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            gumballMachine.setState(gumballMachine.getWinnerState());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            gumballMachine.setState(gumballMachine.getSoldState());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;No gumball dispensed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 售罄状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 22:08:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoldOutState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldOutState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You can&#x27;t insert a quarter, the machine is sold out.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You can&#x27;t eject, you haven&#x27;t inserted a quarter yet.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;You turned, but there are no gumballs.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;No gumball dispensed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 售出状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 22:09:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoldState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Please wait, we&#x27;re already giving you a gumball.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Sorry, you already turned the crank.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Turning twice doesn&#x27;t get you another gumball.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        gumballMachine.releaseBall();</span><br><span class="line">        <span class="keyword">if</span> (gumballMachine.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            gumballMachine.setState(gumballMachine.getNoQuarterState());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Oops, out of gumballs!&quot;</span>);</span><br><span class="line">            gumballMachine.setState(gumballMachine.getSoldOutState());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幸运玩家状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 22:20:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WinnerState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WinnerState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;YOU&#x27;RE A WINNER! You get two gumballs for you quarter.&quot;</span>);</span><br><span class="line">        gumballMachine.releaseBall();</span><br><span class="line">        <span class="keyword">if</span> (gumballMachine.getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">             gumballMachine.setState(gumballMachine.getSoldOutState());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            gumballMachine.releaseBall();</span><br><span class="line">            <span class="keyword">if</span> (gumballMachine.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                gumballMachine.setState(gumballMachine.getNoQuarterState());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Oops, out of gumballs！&quot;</span>);</span><br><span class="line">                gumballMachine.setState(gumballMachine.getSoldOutState());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="改造糖果机"><a href="#改造糖果机" class="headerlink" title="改造糖果机"></a>改造糖果机</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 糖果机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-06 21:18:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GumballMachine</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 售罄</span></span><br><span class="line">    <span class="keyword">private</span> State soldOutState;</span><br><span class="line">    <span class="comment">// 没有投币</span></span><br><span class="line">    <span class="keyword">private</span> State noQuarterState;</span><br><span class="line">    <span class="comment">// 已投币</span></span><br><span class="line">    <span class="keyword">private</span> State hasQuarterState;</span><br><span class="line">    <span class="comment">// 售出</span></span><br><span class="line">    <span class="keyword">private</span> State soldState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赢家</span></span><br><span class="line">    <span class="keyword">private</span> State winnerState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前状态</span></span><br><span class="line">    <span class="keyword">private</span> State state = soldOutState;</span><br><span class="line">    <span class="comment">// 糖果数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GumballMachine</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        soldOutState = <span class="keyword">new</span> SoldOutState(<span class="keyword">this</span>);</span><br><span class="line">        noQuarterState = <span class="keyword">new</span> NoQuarterState(<span class="keyword">this</span>);</span><br><span class="line">        hasQuarterState = <span class="keyword">new</span> HasQuarterState(<span class="keyword">this</span>);</span><br><span class="line">        soldState = <span class="keyword">new</span> SoldState(<span class="keyword">this</span>);</span><br><span class="line">        winnerState = <span class="keyword">new</span> WinnerState(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            state = noQuarterState;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投币方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.insertQuarter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退币方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.ejectQuarter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转动曲柄方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.turnCrank();</span><br><span class="line">        state.dispense();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发放糖果方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.dispense();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseBall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;A gumball comes rolling out the slot.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (count != <span class="number">0</span>) &#123;</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getSoldOutState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> soldOutState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getNoQuarterState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> noQuarterState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getHasQuarterState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasQuarterState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getSoldState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> soldState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getWinnerState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> winnerState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="展示新程序"><a href="#展示新程序" class="headerlink" title="展示新程序"></a>展示新程序</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GumballMachineTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GumballMachine gumballMachine = <span class="keyword">new</span> GumballMachine(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">// 打印机器状态</span></span><br><span class="line">        System.out.println(gumballMachine);</span><br><span class="line">        </span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        <span class="comment">// 打印机器状态</span></span><br><span class="line">        System.out.println(gumballMachine);</span><br><span class="line"></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        <span class="comment">// 打印机器状态</span></span><br><span class="line">        System.out.println(gumballMachine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>状态模式允许一个对象基于内部状态而拥有不同的行为</li>
<li>和程序状态机不同，状态模式用类代表状态</li>
<li>Context会将行为委托给当前状态对象</li>
<li>通过将每个状态封装进一个类，我们把以后需要做的任何改变局部化了</li>
<li>状态模式和策略模式有不同的类图，但是它们的意图不同</li>
<li>策略模式通常会用行为或算法来配置Context类</li>
<li>状态模式允许Context随着状态的改变而改变行为</li>
<li>状态模式可以由State类或Context类控制</li>
<li>使用状态模式通常会导致设计中的类数目大量增加</li>
<li>状态类可以被多个Context实例共享</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>状态模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之策略模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之策略模式"><a href="#每天一个设计模式之策略模式" class="headerlink" title="每天一个设计模式之策略模式"></a>每天一个设计模式之策略模式</h2><h3 id="什么是策略模式-？"><a href="#什么是策略模式-？" class="headerlink" title="什么是策略模式 ？"></a>什么是策略模式 ？</h3><ul>
<li>定义一系列算法，封装每个算法，并使它们可互换。策略模式使算法独立于使用该算法的客户端而变化。</li>
</ul>
<h3 id="先简单的模拟鸭子的应用做起"><a href="#先简单的模拟鸭子的应用做起" class="headerlink" title="先简单的模拟鸭子的应用做起"></a>先简单的模拟鸭子的应用做起</h3><p>   系统的内部设计使用标准的OOP技术，设计了一个鸭子的超类（Superclass），并让各种鸭子继承此超类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子超类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 嘎嘎叫</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;嘎嘎叫...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游泳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;游泳...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由于每种鸭子外观不同，提供抽象方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// other method...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绿头鸭</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallardDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;头是绿色的.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 红头鸭</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedheadDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;头是红色的.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后来新增了需求，让鸭子飞起来。于是在Duck超类加上fly()方法，然后所有的鸭子继承fly()。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子超类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line">    <span class="comment">// other method ...</span></span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;鸭子飞起来...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，可怕的问题发生了….</p>
<p>由于并发所有的Duck类都会飞，在超类加上新的行为，会使得某些并不合适该行为的子类也具有该行为。当涉及维护时，为了复用目的而使用继承并不完美。</p>
<h3 id="利用接口改造"><a href="#利用接口改造" class="headerlink" title="利用接口改造"></a>利用接口改造</h3><p>可以把fly()从超类中提取出来，放进“Flyable接口”中，这么一来，只有会飞的鸭子才实行此接口。同样方式，也可以用设计一个“Quackable接口”，因为不是所有的鸭子都会叫。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 飞行行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 叫声行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Quackable</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子超类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游泳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;游泳...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由于每种鸭子外观不同，提供抽象方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// other method ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绿头鸭，既会飞，又会发出叫声</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallardDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> <span class="keyword">implements</span> <span class="title">Flyable</span>, <span class="title">Quackable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;头是绿色的.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;嘎嘎叫...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;飞行...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 红头鸭，既会飞，又会发出叫声</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedheadDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> <span class="keyword">implements</span> <span class="title">Flyable</span>, <span class="title">Quackable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;头是红色的.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;嘎嘎叫...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;飞行...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 橡皮鸭，不会飞，只会发出叫声</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RubberDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> <span class="keyword">implements</span> <span class="title">Quackable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;橡皮鸭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;橡皮鸭吱吱叫...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 诱饵鸭，既不会飞，也不会叫</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecoyDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;诱饵鸭五颜六色&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，并非所有的子类都具有飞行和呱呱叫的行为，所以“继承”并不是适当的解决方式。虽然Flyable和Quackable可以解决一部分问题，但是造成代码无法复用，而且对于很多Duck的子类都要稍微修改一下飞行的行为，是非常痛苦的。以上的实现都很糟糕。</p>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><ul>
<li>找出应用中可能需要变化之处，把它们独立出来，不要和那些不需要变化的代码混在一起。</li>
<li>把会变化的部分取出来，并“封装”起来，好让其他部分不会受到影响</li>
</ul>
<h3 id="重构原有的结构"><a href="#重构原有的结构" class="headerlink" title="重构原有的结构"></a>重构原有的结构</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子超类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 飞行行为</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> FlyBehavior flyBehavior;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 叫声行为</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> QuackBehavior quackBehavior;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performQuack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        quackBehavior.quack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flyBehavior.fly();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游泳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;All ducks float, even decoys...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由于每种鸭子外观不同，提供抽象方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// other method...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 飞行行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyWithWings</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I&#x27;m flying...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyNoWay</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 什么都不做，不会飞</span></span><br><span class="line">        System.out.println(<span class="string">&quot;I can&#x27;t fly&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 叫声行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Squeak</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;squeak&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;quack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MuteQuack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 什么都不做，不会叫</span></span><br><span class="line">        System.out.println(<span class="string">&quot;silence&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallardDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MallardDuck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 嘎嘎叫</span></span><br><span class="line">        <span class="keyword">super</span>.quackBehavior = <span class="keyword">new</span> Quack();</span><br><span class="line">        <span class="comment">// 会飞行</span></span><br><span class="line">        <span class="keyword">super</span>.flyBehavior = <span class="keyword">new</span> FlyWithWings();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I&#x27;m a green head duck.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelDuck</span> <span class="keyword">extends</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ModelDuck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置模型鸭的行为，不会飞的行为</span></span><br><span class="line">        <span class="keyword">super</span>.flyBehavior = <span class="keyword">new</span> FlyNoWay();</span><br><span class="line">        <span class="keyword">super</span>.quackBehavior = <span class="keyword">new</span> Quack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I&#x27;m a model duck.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态设定行为"><a href="#动态设定行为" class="headerlink" title="动态设定行为"></a>动态设定行为</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子超类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDuck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他实例...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlyBehavior</span><span class="params">(FlyBehavior flyBehavior)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flyBehavior = flyBehavior;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQuackBehavior</span><span class="params">(QuackBehavior quackBehavior)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.quackBehavior = quackBehavior;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// other method...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniDuckSimulator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AbstractDuck duck = <span class="keyword">new</span> MallardDuck();</span><br><span class="line">        duck.performFly();</span><br><span class="line">        <span class="comment">// 动态的改变行为</span></span><br><span class="line">        duck.setQuackBehavior(<span class="keyword">new</span> Squeak());</span><br><span class="line">        duck.performQuack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在运行时改变行为，只需要调用父类的setter方法就可以了。我们通过策略模式来应对任何的改变，使得程序变得更简易健壮。</p>
<h3 id="设计原则-1"><a href="#设计原则-1" class="headerlink" title="设计原则"></a>设计原则</h3><p>多用组合，少用继承。    </p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>策略模式，定义了算法族，分别封装起来，让它们之间可以互相替换，此模式让算法的变化独立于使用算法的客户。</p>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>策略模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之装饰者模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之装饰者模式"><a href="#每天一个设计模式之装饰者模式" class="headerlink" title="每天一个设计模式之装饰者模式"></a>每天一个设计模式之装饰者模式</h2><h3 id="定义装饰者模式"><a href="#定义装饰者模式" class="headerlink" title="定义装饰者模式"></a>定义装饰者模式</h3><p>装饰者模式动态地将责任附加到对象上。若要扩展功能，装饰者提供了比继承更有弹性的替代方案。</p>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><p>类应该对扩展开发，对修改关闭</p>
<h3 id="装饰者模式类图"><a href="#装饰者模式类图" class="headerlink" title="装饰者模式类图"></a>装饰者模式类图</h3><p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghpiqdpnelj30vs0l1jx2.jpg"></p>
<h3 id="用装饰者来设计我们的饮料"><a href="#用装饰者来设计我们的饮料" class="headerlink" title="用装饰者来设计我们的饮料"></a>用装饰者来设计我们的饮料</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 饮料抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 20:48:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String description = <span class="string">&quot;Unknown Beverage&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取饮料描述</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 饮料成本抽象方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调味品装饰器，继承自饮料抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 20:50:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CondimentDecorator</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取调味品描述</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设计饮料的对象"><a href="#设计饮料的对象" class="headerlink" title="设计饮料的对象"></a>设计饮料的对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 浓咖啡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 20:52:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Espresso</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Espresso</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 浓咖啡描述</span></span><br><span class="line">        <span class="keyword">super</span>.description = <span class="string">&quot;Espresso&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 20:54:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HouseBlend</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HouseBlend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.description = <span class="string">&quot;House Blend Coffee&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.89</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设计调料的对象"><a href="#设计调料的对象" class="headerlink" title="设计调料的对象"></a>设计调料的对象</h3><p>我们已经完成了抽象组件（<code>Beverage</code>），有了具体组件（<code>HouseBlend</code>），也有了抽象装饰者（<code>CondimentDecorator</code>）。现在就来实现具体装饰者。先从摩卡下手：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 摩卡咖啡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 20:56:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mocha</span> <span class="keyword">extends</span> <span class="title">CondimentDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1) 用一个实例变量记录饮料，也就是被装饰者。</span></span><br><span class="line"><span class="comment">     * 2) 想办法让装饰者（饮料）被记录到实例变量中。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Beverage beverage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mocha</span><span class="params">(Beverage beverage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取完整的调料描述</span></span><br><span class="line">        <span class="keyword">return</span> beverage.getDescription() + <span class="string">&quot;, Mocha&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 首先把调用委托给被装饰对象，以计算价格，然后加上 Mocha的价格，得到最后的结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.20</span> + beverage.cost();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 21:26:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Whip</span> <span class="keyword">extends</span> <span class="title">CondimentDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Beverage beverage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Whip</span><span class="params">(Beverage beverage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.5</span> + beverage.cost();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.getDescription() +<span class="string">&quot;, Whip&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 21:20:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StarbuzzCoffee</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建一个 Espress，不需要调料，打印价格和描述</span></span><br><span class="line">        Beverage beverage = <span class="keyword">new</span> Espresso();</span><br><span class="line">        System.out.println(beverage.getDescription() + <span class="string">&quot; $&quot;</span> + beverage.cost());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一各 DarkRost对象</span></span><br><span class="line">        Beverage beverage2 = <span class="keyword">new</span> DarkRoast();</span><br><span class="line">        <span class="comment">// 用Mocha 装饰它</span></span><br><span class="line">        beverage2 = <span class="keyword">new</span> Mocha(beverage2);</span><br><span class="line">        <span class="comment">// 用第二个Mocha 装饰它</span></span><br><span class="line">        beverage2 = <span class="keyword">new</span> Mocha(beverage2);</span><br><span class="line">        <span class="comment">// 用Whip 装饰它</span></span><br><span class="line">        beverage2 = <span class="keyword">new</span> Whip(beverage2);</span><br><span class="line">        <span class="comment">// 输出价格和描述</span></span><br><span class="line">        System.out.println(beverage2.getDescription() + <span class="string">&quot; $&quot;</span> + beverage2.cost());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="来看看结果"><a href="#来看看结果" class="headerlink" title="来看看结果"></a>来看看结果</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Espresso $<span class="number">1.99</span></span><br><span class="line">Dark Roast, Mocha, Mocha, Whip $<span class="number">1.79</span></span><br></pre></td></tr></table></figure>

<h3 id="让我们来看看Java-I-O里的装饰者"><a href="#让我们来看看Java-I-O里的装饰者" class="headerlink" title="让我们来看看Java I/O里的装饰者"></a>让我们来看看Java I/O里的装饰者</h3><h4 id="装饰的-java-io-类"><a href="#装饰的-java-io-类" class="headerlink" title="装饰的 java.io 类"></a>装饰的 java.io 类</h4><p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghpj9dhmooj30ue0fjdiz.jpg"></p>
<h4 id="编写自己的Java-I-O-装饰者"><a href="#编写自己的Java-I-O-装饰者" class="headerlink" title="编写自己的Java I/O 装饰者"></a>编写自己的Java I/O 装饰者</h4><p>编写一个装饰者，把输入流内的所有大写字符转成小写。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.decorator.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FilterInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将大写转成小写的装饰者对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 22:05:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LowerCaseInputStream</span> <span class="keyword">extends</span> <span class="title">FilterInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a &lt;code&gt;FilterInputStream&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * by assigning the  argument &lt;code&gt;in&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * to the field &lt;code&gt;this.in&lt;/code&gt; so as</span></span><br><span class="line"><span class="comment">     * to remember it for later use.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in the underlying input stream, or &lt;code&gt;null&lt;/code&gt; if</span></span><br><span class="line"><span class="comment">     *           this instance is to be created without an underlying stream.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LowerCaseInputStream</span><span class="params">(InputStream in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = <span class="keyword">super</span>.read();</span><br><span class="line">        <span class="keyword">return</span> c == -<span class="number">1</span> ? c : Character.toLowerCase((<span class="keyword">char</span>) c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="keyword">super</span>.read(b, off, len);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = off; i &lt; off + result; i++) &#123;</span><br><span class="line">            b[i] = (<span class="keyword">byte</span>) Character.toLowerCase((<span class="keyword">char</span>) b[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试我们新的Java-I-O装饰者"><a href="#测试我们新的Java-I-O装饰者" class="headerlink" title="测试我们新的Java I/O装饰者"></a>测试我们新的Java I/O装饰者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试新的Java I/O 装饰者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-13 22:10:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InputTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置输入流 InputStream，先用 BufferedInputStream装饰它，再用我们新的 LowerCaseInputStream过滤器装饰</span></span><br><span class="line">            in = <span class="keyword">new</span> LowerCaseInputStream(<span class="keyword">new</span> BufferedInputStream(System.in));</span><br><span class="line">            <span class="keyword">int</span> c;</span><br><span class="line">            <span class="keyword">while</span> ((c = in.read()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.print((<span class="keyword">char</span>) c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">运行结果：</span></span><br><span class="line"><span class="attr">HELLO</span></span><br><span class="line"><span class="attr">hello</span></span><br><span class="line"><span class="attr">HI</span></span><br><span class="line"><span class="attr">hi</span></span><br><span class="line"><span class="attr">HELLO</span> <span class="string">WORLD</span></span><br><span class="line"><span class="attr">hello</span> <span class="string">world</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>继承属于扩展形式之一，但不见得达到弹性设计的最佳方式</li>
<li>在我们的设计中，应该允许行为可以被扩展，而无须修改现有的代码</li>
<li>组合和委托可用于在运行时动态地加上新的行为</li>
<li>除了继承，装饰者模式也可以让我们扩展行为</li>
<li>装饰者模式意味着一群装饰者类，这些类用来包装具体组件</li>
<li>装饰者类反映出被装饰的组件类型</li>
<li>装饰者可以在被修饰者的行为前面与/或后面加上自己的行为，甚至将被装饰者的行为整个取代掉，而达到特定的目的</li>
<li>你可以用无所个装饰者包装一个组件</li>
<li>装饰者一般对组件的客户是透明的，除非客户程序依赖于组件的具体类型</li>
<li>装饰者会导致设计中出现许多小装饰对象，如果过度使用，会让程序变得很复杂</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>装饰者模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之观察者模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之观察者模式"><a href="#每天一个设计模式之观察者模式" class="headerlink" title="每天一个设计模式之观察者模式"></a>每天一个设计模式之观察者模式</h2><h3 id="让你的对象知悉现况"><a href="#让你的对象知悉现况" class="headerlink" title="让你的对象知悉现况"></a>让你的对象知悉现况</h3><p>有一个模式可以帮你的对象知悉现况，不会错过该对象感兴趣的事。对象甚至在运行时可决定是否需要继续被通知。观察者模式是JDK中使用最多的模式之一，非常有用。我们会一并介绍一对多关系，以及松耦合。有了观察者，你将会消息灵通。</p>
<h3 id="让我们来模拟一个气象监测应用"><a href="#让我们来模拟一个气象监测应用" class="headerlink" title="让我们来模拟一个气象监测应用"></a>让我们来模拟一个气象监测应用</h3><p>此系统中的三个部分是气象站（获取实际气象数据的物理装置）、WeatherData对象（追踪来自气象站的数据）和公告板（显示目前天气状况给用户看）。</p>
<p>我们的工作就是建立一个应用，利用WeatherData对象取得数据，并更新三个公告板：目前状况、气象统计和天气预报。</p>
<h3 id="瞧瞧WeatherData类"><a href="#瞧瞧WeatherData类" class="headerlink" title="瞧瞧WeatherData类"></a>瞧瞧WeatherData类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherData</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 实例变量声明</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取温度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">getTemperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取湿度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">getHumidity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取气压</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">getPressure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一旦气象测量更新，此方法就会被调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">measurementsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取温度、湿度、气压</span></span><br><span class="line">        <span class="keyword">float</span> temperature = getTemperature();</span><br><span class="line">        <span class="keyword">float</span> humidity = getHumidity();</span><br><span class="line">        <span class="keyword">float</span> pressure = getPressure();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用每个公告板更新显示，传入最新的测量值</span></span><br><span class="line">        currentConditionsDisplay.update(temperature, humidity, pressure);</span><br><span class="line">        statisticsDisplay.update(temperature, humidity, pressure);</span><br><span class="line">        forecastDisplay.update(temperature, humidity, pressure);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义观察者模式"><a href="#定义观察者模式" class="headerlink" title="定义观察者模式"></a>定义观察者模式</h3><p>观察者模式定义了对象之间的一对多依赖，这样一来，当一个对象改变状态时，它的所有依赖者都会收到通知并自动更新。</p>
<h3 id="定义观察者模式类图"><a href="#定义观察者模式类图" class="headerlink" title="定义观察者模式类图"></a>定义观察者模式类图</h3><p><img src="http://wx1.sinaimg.cn/large/008aQ1h9ly1ghn6xy61myj30t50j8teb.jpg" alt="image-20200811212308343"></p>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><p>为了交互对象之间的松耦合设计而努力。</p>
<h3 id="使用观察者来改造气象监测应用"><a href="#使用观察者来改造气象监测应用" class="headerlink" title="使用观察者来改造气象监测应用"></a>使用观察者来改造气象监测应用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主题接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册观察者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除观察者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当主题状态改变时，该方法被调用，以通知所有观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新气象值改变时，传递给观察者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> temperature</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> humidity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pressure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 公告板显示调用的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherData</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Observer&gt; observers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> pressure;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.observers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一旦气象测量更新，此方法就会被调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMeasurements</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取温度、湿度、气压</span></span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        <span class="keyword">this</span>.pressure = pressure;</span><br><span class="line">        <span class="comment">// 通知观察者</span></span><br><span class="line">        notifyObservers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注册新的观察者</span></span><br><span class="line">        observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 移除观察者</span></span><br><span class="line">        <span class="keyword">int</span> i = observers.indexOf(observer);</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            observers.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通知已注册的观察者</span></span><br><span class="line">        <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">            observer.update(temperature, humidity, pressure);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-11 20:51:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Current Conditions: %s F degrees and %s %% humidity.\n&quot;</span>, temperature, humidity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-11 20:51:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatisticsDisplay</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Current Conditions: %s F degrees and %s %% humidity.\n&quot;</span>, temperature, humidity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-11 20:51:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForecastDisplay</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Current Conditions: %s F degrees and %s %% humidity.\n&quot;</span>, temperature, humidity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动气象站"><a href="#启动气象站" class="headerlink" title="启动气象站"></a>启动气象站</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherStation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 气象主题，管理观察者，当有数据就通知已注册的观察者</span></span><br><span class="line">        WeatherData weatherData = <span class="keyword">new</span> WeatherData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 观察者1</span></span><br><span class="line">        CurrentConditionsDisplay currentDisplay = <span class="keyword">new</span> CurrentConditionsDisplay();</span><br><span class="line">        <span class="comment">// 观察者2</span></span><br><span class="line">        StatisticsDisplay statisticsDisplay = <span class="keyword">new</span> StatisticsDisplay();</span><br><span class="line">        <span class="comment">// 观察者3</span></span><br><span class="line">        ForecastDisplay forecastDisplay = <span class="keyword">new</span> ForecastDisplay();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册观察者</span></span><br><span class="line">        weatherData.registerObserver(currentDisplay);</span><br><span class="line">        weatherData.registerObserver(statisticsDisplay);</span><br><span class="line">        weatherData.registerObserver(forecastDisplay);</span><br><span class="line"></span><br><span class="line">        weatherData.setMeasurements(<span class="number">80</span>, <span class="number">56</span>, <span class="number">29.4f</span>);</span><br><span class="line">        weatherData.setMeasurements(<span class="number">82</span>, <span class="number">70</span>, <span class="number">39.2f</span>);</span><br><span class="line">        weatherData.setMeasurements(<span class="number">75</span>, <span class="number">90</span>, <span class="number">20.1f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用JDK-内置观察者模式来改造应用"><a href="#使用JDK-内置观察者模式来改造应用" class="headerlink" title="使用JDK 内置观察者模式来改造应用"></a>使用JDK 内置观察者模式来改造应用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">&#x2F;**</span><br><span class="line"> * 可观察者主题对象</span><br><span class="line"> * @author Mr.zxb</span><br><span class="line"> * @date 2020-08-11 20:11:46</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class WeatherDataObservable extends Observable &#123;</span><br><span class="line">    private float temperature;</span><br><span class="line">    private float humidity;</span><br><span class="line">    private float pressure;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 一旦气象测量更新，此方法就会被调用</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void setMeasurements(float temperature, float humidity, float pressure) &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取温度、湿度、气压</span><br><span class="line">        this.temperature &#x3D; temperature;</span><br><span class="line">        this.humidity &#x3D; humidity;</span><br><span class="line">        this.pressure &#x3D; pressure;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 指示状态已经改变</span><br><span class="line">        super.setChanged();</span><br><span class="line">        &#x2F;&#x2F; 通知观察者</span><br><span class="line">        super.notifyObservers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.observer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"><span class="keyword">import</span> java.util.Observer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-11 20:51:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrentConditionsDisplayObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Current Conditions: %s F degrees and %s %% humidity.\n&quot;</span>, temperature, humidity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> WeatherDataObservable) &#123;</span><br><span class="line">            WeatherDataObservable weatherDataObservable = (WeatherDataObservable) o;</span><br><span class="line">            <span class="keyword">this</span>.temperature = weatherDataObservable.getTemperature();</span><br><span class="line">            <span class="keyword">this</span>.humidity = weatherDataObservable.getHumidity();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.display();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-11 20:59:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherStationObservable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 气象主题，管理观察者，当有数据就通知已注册的观察者</span></span><br><span class="line">        WeatherDataObservable weatherData = <span class="keyword">new</span> WeatherDataObservable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 观察者1</span></span><br><span class="line">        CurrentConditionsDisplayObserver currentDisplay = <span class="keyword">new</span> CurrentConditionsDisplayObserver();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册观察者</span></span><br><span class="line">        weatherData.addObserver(currentDisplay);</span><br><span class="line"></span><br><span class="line">        weatherData.setMeasurements(<span class="number">80</span>, <span class="number">56</span>, <span class="number">29.4f</span>);</span><br><span class="line">        weatherData.setMeasurements(<span class="number">82</span>, <span class="number">70</span>, <span class="number">39.2f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>观察者模式定义了对象之间一对多的关系</p>
</li>
<li><p>主题（也就是可观察者）用一个共同的接口来更新观察者</p>
</li>
<li><p>观察者和可观察者之间用松耦合方式结合，可观察者不知道观察者的细节，只知道观察者实现了观察者接口</p>
</li>
<li><p>使用此模式时，你可从被观察者处推（push）和拉（pull）数据</p>
</li>
<li><p>有多个观察者时，不可以依赖特定的通知次序</p>
</li>
<li><p>Java有多种观察者模式的实现，包括了通用的 <code>java java.util.Observable</code></p>
</li>
<li><p>要注意<code>java java.util.Observable</code>实现上带来的一些问题</p>
</li>
<li><p>如果有必要，可以实现自己的Observable</p>
</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>观察者模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之迭代器模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之迭代器模式"><a href="#每天一个设计模式之迭代器模式" class="headerlink" title="每天一个设计模式之迭代器模式"></a>每天一个设计模式之迭代器模式</h2><h3 id="管理良好的集合"><a href="#管理良好的集合" class="headerlink" title="管理良好的集合"></a>管理良好的集合</h3><p>有许多种方法可以把对象堆起来成为一个集合。你可以把它们放进数组、堆栈、列表或者是散列表中。接下来我们会学习如何让客户遍历你的对象而又无法窥视你存储对象的方式；也将学习如何创建一些对象超集合，能够一口气就跳过某些让人望而生畏的数据结构。</p>
<h3 id="餐厅和煎饼屋合并了"><a href="#餐厅和煎饼屋合并了" class="headerlink" title="餐厅和煎饼屋合并了"></a>餐厅和煎饼屋合并了</h3><p>现在我们可以去同一地方就可以享用煎饼早餐，和午餐了。但是，好像有一点儿麻烦。。。因为煎饼屋使用的<code>ArrayList</code>，而餐厅使用的是数组，它们都不想改变实现，毕竟有太多的代码依赖于它们了。</p>
<h3 id="查看菜单项"><a href="#查看菜单项" class="headerlink" title="查看菜单项"></a>查看菜单项</h3><p>让我们检查每份菜单上的项目和实现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 菜单项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-30 21:13:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuItem</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 菜名</span></span><br><span class="line">    String name;</span><br><span class="line">    <span class="comment">// 描述</span></span><br><span class="line">    String description;</span><br><span class="line">    <span class="comment">// 是否素食</span></span><br><span class="line">    <span class="keyword">boolean</span> vegetarian;</span><br><span class="line">    <span class="comment">// 价格</span></span><br><span class="line">    <span class="keyword">double</span> price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MenuItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">        <span class="keyword">this</span>.vegetarian = vegetarian;</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略 get/set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="煎饼屋菜单实现"><a href="#煎饼屋菜单实现" class="headerlink" title="煎饼屋菜单实现"></a>煎饼屋菜单实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 煎饼屋的菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-30 21:15:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenu</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里使用ArrayList 实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;MenuItem&gt; menuItems;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PancakeHouseMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        menuItems = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        addItem(<span class="string">&quot;煎饼早餐&quot;</span>, <span class="string">&quot;炒鸡蛋煎饼，加面包&quot;</span>, <span class="keyword">true</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;常规煎饼早餐&quot;</span>, <span class="string">&quot;煎饼配煎蛋，香肠&quot;</span>, <span class="keyword">false</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;蓝莓煎饼&quot;</span>, <span class="string">&quot;用新鲜蓝莓制成的煎饼&quot;</span>, <span class="keyword">true</span>, <span class="number">3.49</span>);</span><br><span class="line">        addItem(<span class="string">&quot;华夫饼&quot;</span>, <span class="string">&quot;华夫饼，您可以选择蓝莓或草莓&quot;</span>, <span class="keyword">true</span>, <span class="number">3.59</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vegetarian</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> price</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = <span class="keyword">new</span> MenuItem(name, description, vegetarian, price);</span><br><span class="line">        menuItems.add(menuItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回菜单列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;MenuItem&gt; <span class="title">getMenuItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="餐厅菜单实现"><a href="#餐厅菜单实现" class="headerlink" title="餐厅菜单实现"></a>餐厅菜单实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 晚餐菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-30 21:26:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenu</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ITEMS = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numberOfItems = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuItem[] menuItems;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DinerMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        menuItems = <span class="keyword">new</span> MenuItem[MAX_ITEMS];</span><br><span class="line"></span><br><span class="line">        addItem(<span class="string">&quot;Vegetarian BLT&quot;</span>, <span class="string">&quot;全麦培根莴苣和番茄&quot;</span>, <span class="keyword">true</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;BLT&quot;</span>, <span class="string">&quot;培根配生菜和番茄全麦&quot;</span>, <span class="keyword">false</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;当天的汤&quot;</span>, <span class="string">&quot;当天的汤，配以土豆沙拉&quot;</span>, <span class="keyword">false</span>, <span class="number">3.29</span>);</span><br><span class="line">        addItem(<span class="string">&quot;热狗&quot;</span>, <span class="string">&quot;热狗, 配酸菜，调味，洋葱，加奶酪&quot;</span>, <span class="keyword">false</span>, <span class="number">3.99</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vegetarian</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> price</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = <span class="keyword">new</span> MenuItem(name, description, vegetarian, price);</span><br><span class="line">        <span class="keyword">if</span> (numberOfItems &gt;= MAX_ITEMS) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Sorry, menu is full! Can&#x27;t add item to menu&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            menuItems[numberOfItems] = menuItem;</span><br><span class="line">            numberOfItems++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回菜单列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> MenuItem[] getMenuItems() &#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务员打印菜单"><a href="#服务员打印菜单" class="headerlink" title="服务员打印菜单"></a>服务员打印菜单</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Waitress</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PancakeHouseMenu pancakeHouseMenu;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DinerMenu dinerMenu;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Waitress</span><span class="params">(PancakeHouseMenu pancakeHouseMenu, DinerMenu dinerMenu)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pancakeHouseMenu = pancakeHouseMenu;</span><br><span class="line">        <span class="keyword">this</span>.dinerMenu = dinerMenu;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印合并后的餐厅菜单项</span></span><br><span class="line">    <span class="comment">// 我们总是要处理两个菜单，并且用两个循环遍历这些项。如果还有第三家餐厅以不同的实现，我们就需要有三个循环。。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;MenuItem&gt; pancakeHouseMenuMenuItems = pancakeHouseMenu.getMenuItems();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pancakeHouseMenuMenuItems.size(); i++) &#123;</span><br><span class="line">            MenuItem menuItem = pancakeHouseMenuMenuItems.get(i);</span><br><span class="line">            System.out.print(menuItem.getName() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getPrice() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getDescription());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MenuItem[] dinerMenuMenuItems = dinerMenu.getMenuItems();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dinerMenuMenuItems.length; i++) &#123;</span><br><span class="line">            MenuItem menuItem = dinerMenuMenuItems[i];</span><br><span class="line">            System.out.print(menuItem.getName() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getPrice() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="可以封装遍历吗？"><a href="#可以封装遍历吗？" class="headerlink" title="可以封装遍历吗？"></a>可以封装遍历吗？</h3><p>我们可以封装变化的部分。很明显，在这里发生变化的是：由不同的集合类型所造成的遍历。</p>
<h3 id="在餐厅加入一个迭代器"><a href="#在餐厅加入一个迭代器" class="headerlink" title="在餐厅加入一个迭代器"></a>在餐厅加入一个迭代器</h3><p>想要在餐厅中加入一个迭代器，我们需要先定义迭代器接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 迭代器接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-30 21:45:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现具体的迭代器，为餐厅菜单服务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenuIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuItem[] items;</span><br><span class="line">    <span class="comment">// 记录当前数组遍历的位置</span></span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DinerMenuIterator</span><span class="params">(MenuItem[] items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position &gt;= items.length || items[position] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MenuItem item = items[position];</span><br><span class="line">        position++;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;MenuItem&gt; menuItems;</span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PancakeHouseIterator</span><span class="params">(ArrayList&lt;MenuItem&gt; menuItems)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.menuItems = menuItems;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position &gt;= menuItems.size() || menuItems.get(position) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = menuItems.get(position);</span><br><span class="line">        position++;</span><br><span class="line">        <span class="keyword">return</span> menuItem;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="用迭代器改写餐厅菜单"><a href="#用迭代器改写餐厅菜单" class="headerlink" title="用迭代器改写餐厅菜单"></a>用迭代器改写餐厅菜单</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 晚餐菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-30 21:26:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenu</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ITEMS = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numberOfItems = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuItem[] menuItems;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 省略其他方法...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回菜单列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> MenuItem[] getMenuItems() &#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回一个迭代器的实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DinerMenuIterator(getMenuItems());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenu</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里使用ArrayList 实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;MenuItem&gt; menuItems;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略其他方法...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回菜单列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;MenuItem&gt; <span class="title">getMenuItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Iterator <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PancakeHouseIterator(getMenuItems());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修正服务员打印菜单"><a href="#修正服务员打印菜单" class="headerlink" title="修正服务员打印菜单"></a>修正服务员打印菜单</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Waitress</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PancakeHouseMenu pancakeHouseMenu;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DinerMenu dinerMenu;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Waitress</span><span class="params">(PancakeHouseMenu pancakeHouseMenu, DinerMenu dinerMenu)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pancakeHouseMenu = pancakeHouseMenu;</span><br><span class="line">        <span class="keyword">this</span>.dinerMenu = dinerMenu;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator iterator = pancakeHouseMenu.createIterator();</span><br><span class="line">        printMenu(iterator);</span><br><span class="line">        Iterator dinerMenuIterator = dinerMenu.createIterator();</span><br><span class="line">        printMenu(dinerMenuIterator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">(Iterator iterator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            MenuItem menuItem = (MenuItem) iterator.next();</span><br><span class="line">            System.out.print(menuItem.getName() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getPrice() + <span class="string">&quot; --&quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试我们的代码"><a href="#测试我们的代码" class="headerlink" title="测试我们的代码"></a>测试我们的代码</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PancakeHouseMenu pancakeHouseMenu = <span class="keyword">new</span> PancakeHouseMenu();</span><br><span class="line">        DinerMenu dinerMenu = <span class="keyword">new</span> DinerMenu();</span><br><span class="line"></span><br><span class="line">        Waitress waitress = <span class="keyword">new</span> Waitress(pancakeHouseMenu, dinerMenu);</span><br><span class="line">        waitress.printMenu();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用Java的Iterator接口改良菜单"><a href="#使用Java的Iterator接口改良菜单" class="headerlink" title="使用Java的Iterator接口改良菜单"></a>使用Java的Iterator接口改良菜单</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Menu</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 简单接口，让客户能够取得一个菜单项迭代器</span></span><br><span class="line">    <span class="function">Iterator <span class="title">createIterator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 煎饼屋的菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-30 21:15:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenu</span> <span class="keyword">implements</span> <span class="title">Menu</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里使用ArrayList 实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;MenuItem&gt; menuItems;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略其他方法...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems.iterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenuIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuItem[] items;</span><br><span class="line">    <span class="comment">// 记录当前数组遍历的位置</span></span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DinerMenuIterator</span><span class="params">(MenuItem[] items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position &gt;= items.length || items[position] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MenuItem item = items[position];</span><br><span class="line">        position++;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;You can&#x27;t remove an item until you&#x27;ve done at least one next()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (items[position - <span class="number">1</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = position - <span class="number">1</span>; i &lt; (items.length - <span class="number">1</span>); i++) &#123;</span><br><span class="line">                items[i] = items[i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            items[items.length - <span class="number">1</span>] = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改造我们的服务员类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Waitress</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Menu pancakeHouseMenu;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Menu dinerMenu;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Waitress</span><span class="params">(Menu pancakeHouseMenu, Menu dinerMenu)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pancakeHouseMenu = pancakeHouseMenu;</span><br><span class="line">        <span class="keyword">this</span>.dinerMenu = dinerMenu;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator iterator = pancakeHouseMenu.createIterator();</span><br><span class="line">        printMenu(iterator);</span><br><span class="line">        Iterator dinerMenuIterator = dinerMenu.createIterator();</span><br><span class="line">        printMenu(dinerMenuIterator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">(Iterator iterator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            MenuItem menuItem = (MenuItem) iterator.next();</span><br><span class="line">            System.out.print(menuItem.getName() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getPrice() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            System.out.println(menuItem.getDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="改良的好处"><a href="#改良的好处" class="headerlink" title="改良的好处"></a>改良的好处</h3><p>煎饼屋菜单和餐厅菜单的类，都实现了Menu接口，服务员类可以利用接口（而不是具体类）引用每一个菜单对象。这样，通过“针对接口编程，而不是针对实现编程”，这样就可以减少服务员类与具体类之间的依赖。</p>
<h3 id="定义迭代器模式"><a href="#定义迭代器模式" class="headerlink" title="定义迭代器模式"></a>定义迭代器模式</h3><p><strong>迭代器模式</strong>提供一种方法顺序访问一个聚合对象中的各个元素，而又不暴露其内部的表示。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>迭代器允许访问聚合的元素，而不需要暴露它的内部结构</li>
<li>迭代器将遍历聚合的工作封装进一个对象中</li>
<li>当使用迭代器的时候，我们依赖聚合提供遍历</li>
<li>迭代器提供了一个通用的接口，让我们遍历聚合项，当我们编码使用聚合的项时，就可以使用多态机制</li>
<li>我们应该努力让一个类只分配一个责任</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>迭代器模式</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之适配器模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之适配器模式"><a href="#每天一个设计模式之适配器模式" class="headerlink" title="每天一个设计模式之适配器模式"></a>每天一个设计模式之适配器模式</h2><h3 id="我们周围的适配器"><a href="#我们周围的适配器" class="headerlink" title="我们周围的适配器"></a>我们周围的适配器</h3><p>OO适配器是什么，你一定不难理解，因为现实中到处都是。比方说：如果你需要在欧洲国家使用美国制造的笔记本电脑，你可能需要使用一个交流电的适配器…</p>
<p>你知道适配器的作用：它位于美式插头和欧式插头中间，它的工作是将欧式插座转换成美式插座，好让美式插头可以插进这个插座得到电力。或者也可以这么认为：适配器改变了插座的接口，以符合美式笔记本电脑的需求。</p>
<p>其实OO适配器和真实世界的适配器扮演着同样的角色：将一个接口转换成另一个接口，以符合客户的期望。</p>
<h3 id="面向对象适配器"><a href="#面向对象适配器" class="headerlink" title="面向对象适配器"></a>面向对象适配器</h3><p>假设已有一个软件系统，你希望它和一个新的产商类库搭配使用，但是这个新产商所设计出来的接口，不同于旧产商的接口；我们又不想改变现有的代码，解决这个问题。所以我们可以提供一个适配器的类，将新产商接口转换成你所期望的接口。</p>
<p>这个适配器工作起来就如同一个中间人，它将客户所发出的请求转换成产商类能理解的请求。</p>
<h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-21 22:05:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鸭子实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-21 22:05:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallardDuck</span> <span class="keyword">implements</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Quack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I&#x27;m flying.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 火鸡接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-21 22:06:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Turkey</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 野火鸡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-21 22:06:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WildTurkey</span> <span class="keyword">implements</span> <span class="title">Turkey</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Gobble gobble.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I&#x27;m flying a short distance.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设你缺一些鸭子对象， 想用一些火鸡对象来冒充。显而易见，不能直接使用火鸡接口。所以写一个适配器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 火鸡适配器，将火鸡伪装成鸭子类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-21 22:07:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TurkeyAdapter</span> <span class="keyword">implements</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Turkey turkey;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TurkeyAdapter</span><span class="params">(Turkey turkey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.turkey = turkey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        turkey.gobble();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 火鸡飞行距离很短，不像鸭子飞行距离远，所以让火鸡多飞几次来完成</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            turkey.fly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试适配器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DuckTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建一只鸭子</span></span><br><span class="line">        MallardDuck duck = <span class="keyword">new</span> MallardDuck();</span><br><span class="line">       <span class="comment">// 创建一只火鸡 </span></span><br><span class="line">        WildTurkey turkey = <span class="keyword">new</span> WildTurkey();</span><br><span class="line">        <span class="comment">// 然后将火鸡包装进一个火鸡适配器中，使它看起来像只鸭子</span></span><br><span class="line">        Duck turkeyAdapter = <span class="keyword">new</span> TurkeyAdapter(turkey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试火鸡</span></span><br><span class="line">        System.out.println(<span class="string">&quot;The Turkey says...&quot;</span>);</span><br><span class="line">        turkey.gobble();</span><br><span class="line">        turkey.fly();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试鸭子</span></span><br><span class="line">        System.out.println(<span class="string">&quot;The Duck says...&quot;</span>);</span><br><span class="line">        testDuck(duck);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试适配器包装的假鸭子</span></span><br><span class="line">        System.out.println(<span class="string">&quot;The TurkeyAdapter says...&quot;</span>);</span><br><span class="line">        testDuck(turkeyAdapter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testDuck</span><span class="params">(Duck duck)</span> </span>&#123;</span><br><span class="line">        duck.quack();</span><br><span class="line">        duck.fly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">The Turkey says...</span><br><span class="line">Gobble gobble.</span><br><span class="line">I<span class="string">&#x27;m flying a short distance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The Duck says...</span></span><br><span class="line"><span class="string">Quack</span></span><br><span class="line"><span class="string">I&#x27;</span>m flying.</span><br><span class="line"></span><br><span class="line">The TurkeyAdapter says...</span><br><span class="line">Gobble gobble.</span><br><span class="line">I<span class="string">&#x27;m flying a short distance.</span></span><br><span class="line"><span class="string">I&#x27;</span>m flying a <span class="keyword">short</span> distance.</span><br><span class="line">I<span class="string">&#x27;m flying a short distance.</span></span><br><span class="line"><span class="string">I&#x27;</span>m flying a <span class="keyword">short</span> distance.</span><br><span class="line">I<span class="string">&#x27;m flying a short distance.</span></span><br></pre></td></tr></table></figure>

<h3 id="适配器模式解析"><a href="#适配器模式解析" class="headerlink" title="适配器模式解析"></a>适配器模式解析</h3><p>现在我们知道了什么是适配器，让我们看看各部分之间的关系。</p>
<p><img src="http://wx4.sinaimg.cn/large/008aQ1h9ly1ghysshz6dmj30tk0hido6.jpg"></p>
<p>客户使用适配器的过程如下：</p>
<ol>
<li><strong>客户通过目标接口调用适配器的方法对适配器发出请求</strong>。</li>
<li><strong>适配器使用被适配器接口把请求转换成被适配器的一个或多个调用接口</strong>。</li>
<li><strong>客户接收调用的结果，但并未察觉这一切是适配器在起转换作用</strong>。</li>
</ol>
<h3 id="定义适配器模式"><a href="#定义适配器模式" class="headerlink" title="定义适配器模式"></a>定义适配器模式</h3><blockquote>
<p>适配器模式将一个类的接口，转换成客户期望的另一个接口。适配器让原本接口不兼容的类可以合作无间。</p>
</blockquote>
<h3 id="适配器类图"><a href="#适配器类图" class="headerlink" title="适配器类图"></a>适配器类图</h3><p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghyswd63azj30xl0enjwz.jpg"></p>
<h3 id="设计JDK类库中的适配器"><a href="#设计JDK类库中的适配器" class="headerlink" title="设计JDK类库中的适配器"></a>设计JDK类库中的适配器</h3><p>在Java早期集合类型（Vector、Stack、Hashtable）都实现了一个名为<code>elements()</code>的方法。这个<code>Enumeration</code>接口可以逐一走过此集合内的每个元素，而无需知道它们在集合内是如何被管理的。</p>
<p>在JDK后来的更新中，开始使用了<code>Iterator</code>迭代器接口，这个接口和枚举接口很像，都可以让你遍历此集合类型内的每个元素，但不同的是，迭代器提供了删除元素的功能。</p>
<h3 id="将枚举Enumeration适配到迭代器中"><a href="#将枚举Enumeration适配到迭代器中" class="headerlink" title="将枚举Enumeration适配到迭代器中"></a>将枚举Enumeration适配到迭代器中</h3><p>看看两个接口的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Enumeration</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tests if this enumeration contains more elements.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  &lt;code&gt;true&lt;/code&gt; if and only if this enumeration object</span></span><br><span class="line"><span class="comment">     *           contains at least one more element to provide;</span></span><br><span class="line"><span class="comment">     *          &lt;code&gt;false&lt;/code&gt; otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the next element of this enumeration if this enumeration</span></span><br><span class="line"><span class="comment">     * object has at least one more element to provide.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>     the next element of this enumeration.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NoSuchElementException  if no more elements exist.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">E <span class="title">nextElement</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns &#123;<span class="doctag">@code</span> true&#125; if the iteration has more elements.</span></span><br><span class="line"><span class="comment">     * (In other words, returns &#123;<span class="doctag">@code</span> true&#125; if &#123;<span class="doctag">@link</span> #next&#125; would</span></span><br><span class="line"><span class="comment">     * return an element rather than throwing an exception.)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the iteration has more elements</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the next element in the iteration.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the next element in the iteration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if the iteration has no more elements</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">E <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Removes from the underlying collection the last element returned</span></span><br><span class="line"><span class="comment">     * by this iterator (optional operation).  This method can be called</span></span><br><span class="line"><span class="comment">     * only once per call to &#123;<span class="doctag">@link</span> #next&#125;.  The behavior of an iterator</span></span><br><span class="line"><span class="comment">     * is unspecified if the underlying collection is modified while the</span></span><br><span class="line"><span class="comment">     * iteration is in progress in any way other than by calling this</span></span><br><span class="line"><span class="comment">     * method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implSpec</span></span></span><br><span class="line"><span class="comment">     * The default implementation throws an instance of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> UnsupportedOperationException&#125; and performs no other action.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UnsupportedOperationException if the &#123;<span class="doctag">@code</span> remove&#125;</span></span><br><span class="line"><span class="comment">     *         operation is not supported by this iterator</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if the &#123;<span class="doctag">@code</span> next&#125; method has not</span></span><br><span class="line"><span class="comment">     *         yet been called, or the &#123;<span class="doctag">@code</span> remove&#125; method has already</span></span><br><span class="line"><span class="comment">     *         been called after the last call to the &#123;<span class="doctag">@code</span> next&#125;</span></span><br><span class="line"><span class="comment">     *         method</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;remove&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each remaining element until all elements</span></span><br><span class="line"><span class="comment">     * have been processed or the action throws an exception.  Actions are</span></span><br><span class="line"><span class="comment">     * performed in the order of iteration, if that order is specified.</span></span><br><span class="line"><span class="comment">     * Exceptions thrown by the action are relayed to the caller.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implSpec</span></span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The default implementation behaves as if:</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">     *     while (hasNext())</span></span><br><span class="line"><span class="comment">     *         action.accept(next());</span></span><br><span class="line"><span class="comment">     * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action The action to be performed for each element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified action is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> E&gt; action)</span> </span>&#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        <span class="keyword">while</span> (hasNext())</span><br><span class="line">            action.accept(next());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设计适配器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 枚举迭代器适配器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-21 22:43:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumerationIterator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Enumeration&lt;T&gt; enumeration;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnumerationIterator</span><span class="params">(Enumeration&lt;T&gt; enumeration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.enumeration = enumeration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> enumeration.hasMoreElements();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> enumeration.nextElement();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>当需要使用一个现有的类而其接口并不符合你的需要时，就使用适配器。</li>
<li>适配器改变接口以符合客户的期望。</li>
<li>实现一个适配器可能需要一番功夫，也可能不费功夫，视目标接口的大小与复杂度而定。</li>
<li>适配器模式有两种形式：对象适配器和类适配器。类适配器需要用到多重继承。</li>
<li>适配器将一个对象包装起来以改变其接口；装饰者将一个对象包装起来以增加新的行为和责任。</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>适配器模式</tag>
      </tags>
  </entry>
  <entry>
    <title>面试总结（其他）</title>
    <url>/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93%EF%BC%88%E5%85%B6%E4%BB%96%EF%BC%89/</url>
    <content><![CDATA[<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gimoby2nc7j30ku0b4gls.jpg"></p>
<a id="more"></a>

<h2 id="面试总结（其他）"><a href="#面试总结（其他）" class="headerlink" title="面试总结（其他）"></a>面试总结（其他）</h2><h3 id="LinkedHashMap-如何保证有序"><a href="#LinkedHashMap-如何保证有序" class="headerlink" title="LinkedHashMap 如何保证有序"></a>LinkedHashMap 如何保证有序</h3><p>LinkedHashMap继承自HashMap，LinkedHashMap定义了Entry继承自HashMap的Node链表的基础上定义了双向链表来保证顺序，主要是通过双向链表来保证有序的，默认是按照插入顺序，也可以用重载方法的访问顺序来排序</p>
<h3 id="IO-NIO-AIO-模型"><a href="#IO-NIO-AIO-模型" class="headerlink" title="IO/NIO/AIO 模型"></a>IO/NIO/AIO 模型</h3><h4 id="IO-BIO（Blocking-I-O）"><a href="#IO-BIO（Blocking-I-O）" class="headerlink" title="IO/BIO（Blocking I/O）"></a>IO/BIO（Blocking I/O）</h4><p>同步阻塞I/O模式，数据的读取写入必须阻塞在一个线程内等待其完成。</p>
<!-- more -->

<p>BIO通信（一请求一应答）模型图如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1gilctcgjxkj310k0ouae4.jpg" alt="WX20200910-103832@2x"></p>
<h4 id="NIO（Non-Blocking-I-O）"><a href="#NIO（Non-Blocking-I-O）" class="headerlink" title="NIO（Non-Blocking I/O）"></a>NIO（Non-Blocking I/O）</h4><p>NIO是一种同步非阻塞的I/O模型，在Java 1.4 中引入了 NIO 框架，对应 java.nio 包，提供了 Channel , Selector，Buffer等抽象。</p>
<p>NIO线程模型如下：</p>
<p><img src="https://tva4.sinaimg.cn/large/008aQ1h9ly1gill3zadb6j312s0eodr2.jpg"></p>
<h4 id="AIO（Asynchronous-non-blocking-I-O）"><a href="#AIO（Asynchronous-non-blocking-I-O）" class="headerlink" title="AIO（Asynchronous non-blocking I/O）"></a>AIO（Asynchronous non-blocking I/O）</h4><p>AIO 也就是 NIO 2。在 Java 7 中引入了 NIO 的改进版 NIO 2,它是异步非阻塞的IO模型。异步 IO 是基于事件和回调机制实现的，也就是应用操作之后会直接返回，不会阻塞在那里，当后台处理完成，操作系统会通知相应的线程进行后续的操作。</p>
<p>AIO 是异步IO的缩写，虽然 NIO 在网络操作中，提供了非阻塞的方法，但是 NIO 的 IO 行为还是同步的。对于 NIO 来说，我们的业务线程是在 IO 操作准备好时，得到通知，接着就由这个线程自行进行 IO 操作，IO操作本身是同步的。</p>
<p>AIO模型：</p>
<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gillw8dr81j30is0ky3z3.jpg" alt="20150929202423057"></p>
<h3 id="同步阻塞-同步非阻塞-异步非阻塞是在IO模型中的哪一环节"><a href="#同步阻塞-同步非阻塞-异步非阻塞是在IO模型中的哪一环节" class="headerlink" title="同步阻塞/同步非阻塞/异步非阻塞是在IO模型中的哪一环节"></a>同步阻塞/同步非阻塞/异步非阻塞是在IO模型中的哪一环节</h3><ul>
<li><p>IO的同步阻塞是在 accept()   read()会进行阻塞</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// IO Server 端</span></span><br><span class="line">ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8000</span>))；<span class="comment">// 绑定端口</span></span><br><span class="line">Socket socket = serverSocket.accept(); <span class="comment">// 会阻塞</span></span><br><span class="line"></span><br><span class="line">socket.getInputStream().read(); <span class="comment">// 会阻塞</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>NIO的同步非阻塞在 accept() 不会阻塞线程，在select()阶段还是会阻塞</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NIO Server 端</span></span><br><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">Selector selector = Selector.open();</span><br><span class="line">serverSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8000</span>)); <span class="comment">// 绑定端口</span></span><br><span class="line">serverSocketChannel.configureBlocking(<span class="keyword">false</span>); <span class="comment">// 设置非阻塞</span></span><br><span class="line">serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); <span class="comment">// 注册事件</span></span><br><span class="line"><span class="comment">// 阻塞等待客户端Channel</span></span><br><span class="line">selector.select();</span><br><span class="line">SocketChannel channel = serverSocketChannel.accept(); <span class="comment">// 非阻塞</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>AIO的异步非阻塞在accept() 会直接返回，不会等待</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AIO Server 端</span></span><br><span class="line">AsynchronousServerSocketChannel socketChannel = AsynchronousServerSocketChannel.open();</span><br><span class="line">socketChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8080</span>)); <span class="comment">// 绑定端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 非阻塞，等待os回调处理</span></span><br><span class="line">socketChannel.accept(<span class="keyword">null</span>, <span class="keyword">new</span> CompletionHandler&lt;AsynchronousSocketChannel, Object&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(AsynchronousSocketChannel result, Object attachment)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 继续监听下一个请求</span></span><br><span class="line">    socketChannel.accept(attachment, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 处理数据</span></span><br><span class="line">    handler(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;服务出现异常：&quot;</span> + exc.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="GC-Roots-是什么"><a href="#GC-Roots-是什么" class="headerlink" title="GC Roots 是什么"></a>GC Roots 是什么</h3><ul>
<li>虚拟机栈中引用的对象，比如各线程调用方法堆栈中使用的参数、局部变量、临时变量等</li>
<li>方法区中类静态属性引用的对象，比如字符串常量池里的引用和Java类的引用类型静态变量</li>
<li>本地方法栈中JNI引用的对象</li>
<li>Java虚拟机内部的引用，比如：基本数据类型对应的Class对象，以及一些异常对象（NPE、OOM）等，还有系统类加载器</li>
<li>所有被同步锁（synchronized关键字）持有的对象</li>
<li>反映Java虚拟机内部情况的JMXBean、JVMTI中注册的回调、本地代码缓存等</li>
</ul>
<h3 id="栈空间如何设置大小，栈空间过大会有什么影响"><a href="#栈空间如何设置大小，栈空间过大会有什么影响" class="headerlink" title="栈空间如何设置大小，栈空间过大会有什么影响"></a>栈空间如何设置大小，栈空间过大会有什么影响</h3><p>-Xss128k：设置每个线程的栈大小。JDK5.0以后每个线程栈大小为1M，以前每个线程栈大小为256K。根据应用的线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右。随着线程栈的大小越大，能够支持越多的方法调用，也即是能够存储更多的栈帧。</p>
<p>线程栈的大小是个双刃剑，如果设置过小，可能会出现栈溢出，特别是在该线程内有递归、大的循环时出现溢出的可能性更大；如果该值设置过大，就有影响到创建栈帧的数量，如果是多线程的应用，就会出现内存溢出的错误.</p>
<h3 id="零拷贝（Zero-Copy）原理"><a href="#零拷贝（Zero-Copy）原理" class="headerlink" title="零拷贝（Zero-Copy）原理"></a>零拷贝（Zero-Copy）原理</h3><p>零拷贝（Zero-copy）技术指在计算机执行操作时，CPU 不需要先将数据从一个内存区域复制到另一个内存区域，从而可以减少上下文切换以及 CPU 的拷贝时间。它的作用是在数据报从网络设备到用户程序空间传递的过程中，减少数据拷贝次数，减少系统调用，实现 CPU 的零参与，彻底消除 CPU 在这方面的负载。实现零拷贝用到的最主要技术是 DMA 数据传输技术和内存区域映射技术。</p>
<ul>
<li>零拷贝机制可以减少数据在内核缓冲区和用户进程缓冲区之间反复的 I/O 拷贝操作。</li>
<li>零拷贝机制可以减少用户进程地址空间和内核地址空间之间因为上下文切换而带来的 CPU 开销。</li>
</ul>
<h3 id="CMS-和-G1-的异同"><a href="#CMS-和-G1-的异同" class="headerlink" title="CMS 和 G1 的异同"></a>CMS 和 G1 的异同</h3><p>按分代收集来说，CMS是老年代收集器，G1则是混合收集，它开创了混合收集的模式，衡量标准不在是属于哪个分代，而是哪块内存值得收集，哪块内存中存放的垃圾数量最多，回收收益最大来进行收集。</p>
<p>按收集算法来说，CMS收集器是基于标记-清除的垃圾收集器，由于CMS是一款基于“标记-清除”算法实现的收集器，就会造成大量空间碎片产生，如果空间碎片过多时，当需要足够大大连续空间来分配大对象大时候，会不得不提前触发Full GC的情况；而G1从整体来看是基于“标记-整理”算法实现的收集器，从局部上看（两个Region之间）又是基于“标记-复制”算法实现，无论如何，这两种算法在运行期间都不会产生内存空间碎片，垃圾收集完成之后能提供规整的可用内存。</p>
<h3 id="G1-什么时候引发-Full-GC"><a href="#G1-什么时候引发-Full-GC" class="headerlink" title="G1 什么时候引发 Full GC"></a>G1 什么时候引发 Full GC</h3><p><code>G1 Full GC</code>的原因一般有：</p>
<ul>
<li><code>Mixed GC</code>赶不上内存分配的速度，只能通过<code>Full GC</code>来释放内存</li>
<li><code>MetaSpace</code>不足，对于大量使用反射，动态代理的类，由于动态代理的每个类都会生成一个新的类，同时<code>class</code>信息会存放在元空间，因此如果元空间不足，<code>G1</code>会靠<code>Full GC</code>来扩容元空间，这种情况解决方案就是扩大初始元空间大小。</li>
<li><code>Humongous</code>分配失败，前面说过<code>G1</code>分配大对象时，回收是靠<code>Concurrent Marking</code>或<code>Full GC</code>，因此如果大对象分配失败，则可能会引发<code>Full GC</code></li>
</ul>
<h3 id="说一个最熟悉的垃圾回收算法"><a href="#说一个最熟悉的垃圾回收算法" class="headerlink" title="说一个最熟悉的垃圾回收算法"></a>说一个最熟悉的垃圾回收算法</h3><p>可以通过自己熟悉的垃圾回收算法引申一下该算法相应的垃圾收集器实现，比如，<strong>标记–复制</strong>算法，这是 HotSpot 虚拟机新生代垃圾收集器常用的回收算法，对应的实现有 Serial、Parallel Scavenge，在比如<strong>标记–清除</strong>算法，对应的垃圾收集器实现有 CMS 等等。</p>
<h3 id="吞量优先和响应时间优先的回收器有哪些"><a href="#吞量优先和响应时间优先的回收器有哪些" class="headerlink" title="吞量优先和响应时间优先的回收器有哪些"></a>吞量优先和响应时间优先的回收器有哪些</h3><ul>
<li>Parallel Scavenge</li>
<li>Parallel Old</li>
<li>G1</li>
</ul>
<h3 id="怎么判断内存泄漏"><a href="#怎么判断内存泄漏" class="headerlink" title="怎么判断内存泄漏"></a>怎么判断内存泄漏</h3><h3 id="讲一下-CMS-的流程"><a href="#讲一下-CMS-的流程" class="headerlink" title="讲一下 CMS 的流程"></a>讲一下 CMS 的流程</h3><h3 id="为什么压缩指针超过32G失效"><a href="#为什么压缩指针超过32G失效" class="headerlink" title="为什么压缩指针超过32G失效"></a>为什么压缩指针超过32G失效</h3><h3 id="什么是内存泄漏？GC-调优有经验吗？一般出现-GC-问题你怎么解决？"><a href="#什么是内存泄漏？GC-调优有经验吗？一般出现-GC-问题你怎么解决？" class="headerlink" title="什么是内存泄漏？GC 调优有经验吗？一般出现 GC 问题你怎么解决？"></a>什么是内存泄漏？GC 调优有经验吗？一般出现 GC 问题你怎么解决？</h3><h3 id="ThreadLocal-有没有内存泄漏问题"><a href="#ThreadLocal-有没有内存泄漏问题" class="headerlink" title="ThreadLocal 有没有内存泄漏问题"></a>ThreadLocal 有没有内存泄漏问题</h3><h3 id="G1-两个-Region-不是连续的，而且之间还有可达的引用，我现在要回收另一个怎么处理？"><a href="#G1-两个-Region-不是连续的，而且之间还有可达的引用，我现在要回收另一个怎么处理？" class="headerlink" title="G1 两个 Region 不是连续的，而且之间还有可达的引用，我现在要回收另一个怎么处理？"></a>G1 两个 Region 不是连续的，而且之间还有可达的引用，我现在要回收另一个怎么处理？</h3><h3 id="讲一下-JVM-堆内存管理（对象分配过程）"><a href="#讲一下-JVM-堆内存管理（对象分配过程）" class="headerlink" title="讲一下 JVM 堆内存管理（对象分配过程）"></a>讲一下 JVM 堆内存管理（对象分配过程）</h3><h3 id="听说过-CMS-的并发预处理和并发可中断预处理吗"><a href="#听说过-CMS-的并发预处理和并发可中断预处理吗" class="headerlink" title="听说过 CMS 的并发预处理和并发可中断预处理吗"></a>听说过 CMS 的并发预处理和并发可中断预处理吗</h3><h3 id="到底多大的对象会被直接扔到老年代"><a href="#到底多大的对象会被直接扔到老年代" class="headerlink" title="到底多大的对象会被直接扔到老年代"></a>到底多大的对象会被直接扔到老年代</h3><p>JVM虚拟机提供了一个<code>-XX:PretenureSizeThreshold</code>参数，令大于这个设置值的对象直接在老年代分配。这样做的目的是避免在Eden区及两个Survivor区之间发生大量的内存复制。</p>
<p>所谓的大对象是指，需要大量连续内存空间的Java对象，最典型的大对象就是那种很长的字符串以及数组。</p>
<p>注意：<code>PretenureSizeThreshold</code>参数只对Serial和ParNew两款收集器有效，Parallel Scavenge收集器不认识这个参数，Parallel Scavenge收集器一般并不需要设置。如果遇到必须使用此参数的场合，可以考虑ParNew加CMS的收集器组合。</p>
<h3 id="mysql-原子性和持久性怎么保证"><a href="#mysql-原子性和持久性怎么保证" class="headerlink" title="mysql 原子性和持久性怎么保证"></a>mysql 原子性和持久性怎么保证</h3><p>Mysql是利用Innodb的undo log日志来保证原子性的；undo log名为回滚日志，是实现原子性的关键，当事务回滚时能够撤销所有已经成功执行的sql语句，他需要记录你要回滚的相应日志信息redo log</p>
<p>Mysql是利用Innodb的redo log来保证持久性；当做数据修改的时候，不仅在内存中操作，还会在redo log中记录这次操作。当事务提交的时候，会将redo log日志进行刷盘(redo log一部分在内存中，一部分在磁盘上)。当数据库宕机重启的时候，会将redo log中的内容恢复到数据库中，再根据undo log和binlog内容决定回滚数据还是提交数据</p>
<h3 id="Mysql-Innodb-和-mylsam-存储引擎区别"><a href="#Mysql-Innodb-和-mylsam-存储引擎区别" class="headerlink" title="Mysql Innodb 和 mylsam 存储引擎区别"></a>Mysql Innodb 和 mylsam 存储引擎区别</h3><table>
<thead>
<tr>
<th align="center">区别</th>
<th align="center">InnoDB</th>
<th align="center">MylSam</th>
</tr>
</thead>
<tbody><tr>
<td align="center">事务</td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td align="center">外键</td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td align="center">锁的粒度</td>
<td align="center">行锁</td>
<td align="center">表锁</td>
</tr>
<tr>
<td align="center">索引</td>
<td align="center">聚集索引</td>
<td align="center">非聚集索引</td>
</tr>
<tr>
<td align="center">表的具体行数</td>
<td align="center">不提供</td>
<td align="center">提供</td>
</tr>
<tr>
<td align="center">CURD操作</td>
<td align="center">适合insert或update场景</td>
<td align="center">适合大量select场景</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h3 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h3><h3 id="Innodb-存储引擎的底层数据结构"><a href="#Innodb-存储引擎的底层数据结构" class="headerlink" title="Innodb 存储引擎的底层数据结构"></a>Innodb 存储引擎的底层数据结构</h3><p> 使用的是B+树</p>
<h3 id="为什么底层使用-B-树不用-B-树"><a href="#为什么底层使用-B-树不用-B-树" class="headerlink" title="为什么底层使用 B+树不用 B 树"></a>为什么底层使用 B+树不用 B 树</h3><p>参考另一个面试总结</p>
<h3 id="快速排序的算法原理以及时间复杂度"><a href="#快速排序的算法原理以及时间复杂度" class="headerlink" title="快速排序的算法原理以及时间复杂度"></a>快速排序的算法原理以及时间复杂度</h3><p>使用分治法，所有比基准值大的排在右边，小的排在左边，然后两边继续按照这个分治法继续递归，直到完成排序</p>
<p>时间复杂度：O(n*logn)</p>
]]></content>
      <categories>
        <category>面试总结</category>
      </categories>
      <tags>
        <tag>面试总结</tag>
      </tags>
  </entry>
  <entry>
    <title>面试总结（某猎头公司）</title>
    <url>/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93%EF%BC%88%E6%9F%90%E7%8C%8E%E5%A4%B4%EF%BC%89/</url>
    <content><![CDATA[<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gimoby2nc7j30ku0b4gls.jpg"></p>
<a id="more"></a>

<h2 id="面试总结（某猎头公司）"><a href="#面试总结（某猎头公司）" class="headerlink" title="面试总结（某猎头公司）"></a>面试总结（某猎头公司）</h2><h3 id="两个Long对象判断相等"><a href="#两个Long对象判断相等" class="headerlink" title="两个Long对象判断相等"></a>两个Long对象判断相等</h3><p>使用equals方法判断两个long对象相等</p>
<h3 id="UTF-8字符如何转成GBK集，具体怎么实现的"><a href="#UTF-8字符如何转成GBK集，具体怎么实现的" class="headerlink" title="UTF-8字符如何转成GBK集，具体怎么实现的"></a>UTF-8字符如何转成GBK集，具体怎么实现的</h3><p>String的重载方法，将字节数组传入String的构造器，传入指定的字符，可以实现相互转换字符集</p>
<h3 id="线程的几种创建方法"><a href="#线程的几种创建方法" class="headerlink" title="线程的几种创建方法"></a>线程的几种创建方法</h3><ol>
<li>继承Thread类，并复写run方法，创建该类对象，调用start方法开启线程。此方式没有返回值。</li>
<li>实现Runnable接口，复写run方法，创建Thread类对象，将Runnable子类对象传递给Thread类对象。调用start方法开启线程。此方法2较之方法1好，将线程对象和线程任务对象分离开。降低了耦合性，利于维护。此方式没有返回值。</li>
<li>创建FutureTask对象，创建Callable子类对象，复写call(相当于run)方法，将其传递给FutureTask对象（相当于一个Runnable）。 创建Thread类对象，将FutureTask对象传递给Thread对象。调用start方法开启线程。这种方式可以获得线程执行完之后的返回值。该方法使用Runnable功能更加强大的一个子类.这个子类是具有返回值类型的任务方法。</li>
<li>线程池的方式</li>
</ol>
<h3 id="线程池的核心参数介绍一下"><a href="#线程池的核心参数介绍一下" class="headerlink" title="线程池的核心参数介绍一下"></a>线程池的核心参数介绍一下</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                          TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                          ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                          RejectedExecutionHandler handler)</span></span></span><br></pre></td></tr></table></figure>

<p><strong>corePoolSize核心线程数量</strong>：线程池内部核心线程数量，如果线程池收到任务，且线程池内部线程数量没有达到corePoolSize，线程池会直接给此任务创建一个新线程来处理此任务</p>
<p><strong>maximumPoolSize最大允许线程数量</strong>：线程池内部线程数量已经达到核心线程数量，即corePoolSize，并且<strong>任务队列已满</strong>，此时如果继续有任务被提交，将判断线程池内部线程总数是否达到maximumPoolSize，如果小于maximumPoolSize，将继续使用线程工厂创建新线程。如果线程池内线程数量等于maximumPoolSize，就不会继续创建线程，将触发拒绝策略RejectedExecutionHandler</p>
<p><strong>keepAliveTime、unit</strong>：当线程池内部的线程数量大于corePoolSize，则多出来的线程会在keepAliveTime时间之后销毁</p>
<p><strong>workQueue工作队列</strong>：线程池需要执行的任务的队列，通常有固定数量的ArrayBlockingQueue，无限制的LinkedBlockingQueue</p>
<p><strong>threadFactory线程工厂</strong>：线程池内初初始没有线程，任务来了之后，会使用线程工厂创建线程</p>
<p><strong>handler拒绝策略</strong>：当任务队列已满，又有新的任务进来时，会回调此接口。有几种默认实现，通常建议根据具体业务来自行实现</p>
<h3 id="线程池核心线程数是5个，启动的时候会创建几个工作线程"><a href="#线程池核心线程数是5个，启动的时候会创建几个工作线程" class="headerlink" title="线程池核心线程数是5个，启动的时候会创建几个工作线程"></a>线程池核心线程数是5个，启动的时候会创建几个工作线程</h3><p>启动的时候不会创建线程，只有执行execute方法的时候才会创建工作线程，每次执行execute方法会创建一个工作线程执行任务，直到工作线程等于核心线程数</p>
<h3 id="线程池的阻塞队列里的任务什么时候会被获取执行"><a href="#线程池的阻塞队列里的任务什么时候会被获取执行" class="headerlink" title="线程池的阻塞队列里的任务什么时候会被获取执行"></a>线程池的阻塞队列里的任务什么时候会被获取执行</h3><p>当工作线程满了并且等于核心线程数的时候，如果继续向线程池提交任务，队列如果也没有满的话，就将会从阻塞队列里获取任务并执行；如果队列满了，并且核心线程小于最大线程数的时候，就会创建新的工作线程从队列获取任务执行</p>
<h3 id="Java-Exception的父类是什么"><a href="#Java-Exception的父类是什么" class="headerlink" title="Java Exception的父类是什么"></a>Java Exception的父类是什么</h3><p>Throwable是所有异常类和Error的父类</p>
<h3 id="RuntimeException、Exception和Error区别"><a href="#RuntimeException、Exception和Error区别" class="headerlink" title="RuntimeException、Exception和Error区别"></a>RuntimeException、Exception和Error区别</h3><p>RuntimeException是运行时异常类</p>
<p>Exception是异常类，是运行时异常的父类</p>
<p>Error是错误类</p>
<h3 id="项目的业务异常为什么要定义RuntimeException"><a href="#项目的业务异常为什么要定义RuntimeException" class="headerlink" title="项目的业务异常为什么要定义RuntimeException"></a>项目的业务异常为什么要定义RuntimeException</h3><p>因为是业务类的异常，业务异常都是业务类型的错误，所以只能定义运行时异常</p>
<h3 id="Http和Https区别"><a href="#Http和Https区别" class="headerlink" title="Http和Https区别"></a>Http和Https区别</h3><p>https是加密的http协议</p>
<h3 id="Spring-Bean-默认类型"><a href="#Spring-Bean-默认类型" class="headerlink" title="Spring Bean 默认类型"></a>Spring Bean 默认类型</h3><p>单例的Singleton Bean</p>
<h3 id="单例Bean-原型Bean-在销毁的时候是否一样的"><a href="#单例Bean-原型Bean-在销毁的时候是否一样的" class="headerlink" title="单例Bean 原型Bean 在销毁的时候是否一样的"></a>单例Bean 原型Bean 在销毁的时候是否一样的</h3><p>不一样，scope为prototype的bean，容器会将创建好的对象实例返回给请求方，之后，容器就不再拥有其引用，请求方需要自己负责当前对象后继生命周期的管理工作，包括该对象的销毁。</p>
<p>所以：scope为singleton的bean的destroy方法则是在容器关闭时执行，而scope为prototype的bean是不会执行destroy方法的</p>
<h3 id="Mysql-联合索引-a-b-c-，以下哪些会走索引"><a href="#Mysql-联合索引-a-b-c-，以下哪些会走索引" class="headerlink" title="Mysql 联合索引 (a + b + c)，以下哪些会走索引"></a>Mysql 联合索引 (a + b + c)，以下哪些会走索引</h3><p> select * from table where a = ? and b = ? 会走索引<br> select * from table where a = ? and c = ? 会<br> select * from table where b = ? and c = ? 不会<br> select * from table where b = ? and a = ? 会</p>
<p>建索引的几大原则：</p>
<p>1、最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配，比如a = 1 and b = 2 and c &gt; 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</p>
<p>2、=和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式。</p>
<p>3、尽量选择区分度高的列作为索引，区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录。</p>
<p>4、索引列不能参与计算，保持列“干净”，比如from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’2014-05-29’)。</p>
<p>5、尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。</p>
<h3 id="有一个user表，需要根据age倒序排，然后获取50-80行的数据，sql怎么写"><a href="#有一个user表，需要根据age倒序排，然后获取50-80行的数据，sql怎么写" class="headerlink" title="有一个user表，需要根据age倒序排，然后获取50-80行的数据，sql怎么写"></a>有一个user表，需要根据age倒序排，然后获取50-80行的数据，sql怎么写</h3><p>SELECT * FROM user ORDER BY age desc limit 50, 30;</p>
]]></content>
      <categories>
        <category>面试总结</category>
      </categories>
      <tags>
        <tag>面试总结</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM 性能监控与故障处理工具</title>
    <url>/JVM%20%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p><img src="https://tva1.sinaimg.cn/large/008aQ1h9ly1gimfe2w3jrj30lx0amgrz.jpg"></p>
<a id="more"></a>

<h2 id="JVM-性能监控与故障处理工具"><a href="#JVM-性能监控与故障处理工具" class="headerlink" title="JVM 性能监控与故障处理工具"></a>JVM 性能监控与故障处理工具</h2><h3 id="JDK-命令行工具"><a href="#JDK-命令行工具" class="headerlink" title="JDK 命令行工具"></a>JDK 命令行工具</h3><p>Java开发人员肯定知道JDK的bin目录中有<code>java.exe</code>、<code>javac.exe</code>这两个命令行工具，但还有很多其他工具提供稳定而强大的功能，能在处理应用程序性能问题、定位故障时发挥很大的作用。下面来介绍一下Java提供的那些强大并且很有帮助的工具吧。</p>
<p>jdk命令行的主要工具：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">jps</td>
<td align="left">JVM Process Status Tool，显示指定系统内所有的HotSpot虚拟机进程</td>
</tr>
<tr>
<td align="center">jstat</td>
<td align="left">JVM Statistics Monitoring Tool，用于收集HotSpot虚拟机各方面的运行数据</td>
</tr>
<tr>
<td align="center">jinfo</td>
<td align="left">Configuration Info for Java，显示虚拟机配置信息</td>
</tr>
<tr>
<td align="center">jmap</td>
<td align="left">Memory Map for Java，生成虚拟机的内存转储快照（heapdump文件）</td>
</tr>
<tr>
<td align="center">jhat</td>
<td align="left">JVM Heap Dump Browser，用于分析heapdump文件，它会建立一个HTTP/HTML服务器，让用户可以在浏览器上查看分析结果</td>
</tr>
<tr>
<td align="center">jstack</td>
<td align="left">Stack Trace for Java，显示虚拟机的线程快照</td>
</tr>
</tbody></table>
<h3 id="jps：-虚拟机进程状况工具"><a href="#jps：-虚拟机进程状况工具" class="headerlink" title="jps： 虚拟机进程状况工具"></a>jps： 虚拟机进程状况工具</h3><p>JDK的很多小工具的名字都参考了Unix命令的命名方式，jps（JVM Process Status Tool）是其中的典型。功能是可以列出正在运行的虚拟机进程，并显示虚拟机执行主类（Main Class，main()函数所在的类）名称以及这些进程的本地虚拟机唯一ID（Local Virtual Machine Identifier，LVMID）。</p>
<p>命令格式： <code>jps [options] [hostid]</code></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.<span class="number">8.0</span>_171\bin&gt;jps <span class="literal">-l</span></span><br><span class="line"><span class="number">9968</span> org.jetbrains.jps.cmdline.Launcher</span><br><span class="line"><span class="number">14248</span> sun.tools.jps.Jps</span><br><span class="line"><span class="number">8812</span> org.jetbrains.idea.maven.server.RemoteMavenServer36</span><br></pre></td></tr></table></figure>

<p>jps工具的主要选项：</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-q</td>
<td>只输出<code>LVMID</code>，省略主类的名称</td>
</tr>
<tr>
<td align="center">-m</td>
<td>输出虚拟机进程启动时传递给主类<code>main()</code>函数的参数</td>
</tr>
<tr>
<td align="center">-l</td>
<td>输出主类的全名， 如果执行进程的是jar包，输出jar路径</td>
</tr>
<tr>
<td align="center">-v</td>
<td>输出虚拟机进程启动时JVM参数</td>
</tr>
</tbody></table>
<h3 id="jstat：-虚拟机统计信息监视工具"><a href="#jstat：-虚拟机统计信息监视工具" class="headerlink" title="jstat： 虚拟机统计信息监视工具"></a>jstat： 虚拟机统计信息监视工具</h3><p>jstat（JVM Statistics Monitoring Tool）是用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾收集、JIT编译等运行数据，在没有GUI图形界面，只提供了纯文本控制台环境的服务器上， 它将是运行期定位虚拟机性能问题的首选工具。</p>
<p>命令格式： <code>jstat [option vmid [interval[s|ms] [count]] ]</code></p>
<p>参数interval和count代表查询间隔和次数，如果省略这两个参数，说明只查询一次。</p>
<p>假设需要没250ms查询一次进程2764垃圾收集状况，一共查询20次，那么命令应该是：</p>
<p>jstat -gc 2764 250 20</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.8.0_171\bin&gt;jstat -gcutil 8812 1000 20</span><br><span class="line">  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br></pre></td></tr></table></figure>

<p>选项option代表着用户希望查询的虚拟机信息，主要分为3类：类加载、垃圾收集、运行期编译状况。</p>
<p>jstat工具的主要选项：</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-class</td>
<td>监视类加载、卸载数量、总空间以及类加载所消耗的时间</td>
</tr>
<tr>
<td align="center">-gc</td>
<td>监视Java堆状况，包括Eden区、两个Survivor区、老年代、元空间等的容量、已用空间、GC时间合计等信息</td>
</tr>
<tr>
<td align="center">-gccapacity</td>
<td>监视内容与-gc基本相同，但输出主要关注Java堆各个区域使用到的最大、最小空间</td>
</tr>
<tr>
<td align="center">-gcutil</td>
<td>监视内容与-gc基本相同，但输出主要关注已使用空间占总空间的百分比</td>
</tr>
<tr>
<td align="center">-gccause</td>
<td>与-gcutil功能一样，但是会额外输出导致上一次GC产生的原因</td>
</tr>
<tr>
<td align="center">-gcnew</td>
<td>监视新生代GC状况</td>
</tr>
<tr>
<td align="center">-gcnewcapacity</td>
<td>监视内容与-gcnew基本相同，输出主要关注使用到的最大、最小空间</td>
</tr>
<tr>
<td align="center">-gcold</td>
<td>监视老年代GC状况</td>
</tr>
<tr>
<td align="center">-gcoldcapacity</td>
<td>监视内容与-gcold基本相同，输出主要关注使用到的最大、最小空间</td>
</tr>
<tr>
<td align="center">-gcpermcapacity（jdk8已移除）</td>
<td>输出永久代使用到的最大、最小空间</td>
</tr>
<tr>
<td align="center">-gcmetacapacity（jdk8新增）</td>
<td>输出元空间使用到的最大、最小空间</td>
</tr>
<tr>
<td align="center">-compiler</td>
<td>输出JIT编译器编译过的方法、耗时等信息</td>
</tr>
<tr>
<td align="center">-printcompilation</td>
<td>输出已经被JIT编译的方法</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.8.0_171\bin&gt;jstat -gcutil 8812 250 20</span><br><span class="line">  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br><span class="line">  0.00 100.00  76.74   4.42  92.98  82.74      3    0.027     0    0.000    0.027</span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<p><code>E代表Eden区，使用了76.74%的空间；</code></p>
<p><code>两个Survivor区（S0、S1）里面一个是空的，另一个使用了100%；</code></p>
<p><code>O代表老年代，使用了4.42%</code></p>
<p><code>M代表元空间，使用了92.98%</code></p>
<p><code>CCS是压缩的类空间利用率（以百分比表示）是82.74%</code></p>
<p><code>YGC是程序运行一来来共发生Minor GC（YGC，表示Young GC）3次，总耗时YGCT是0.027s</code></p>
<p><code>FGC发生Full GC是0次，Full GC的FGCT的耗时也是0</code></p>
<p><code>GCT（表示GC Time）是所有的GC的总耗时是0.027s</code></p>
<h3 id="jinfo：-Java配置信息工具"><a href="#jinfo：-Java配置信息工具" class="headerlink" title="jinfo： Java配置信息工具"></a>jinfo： Java配置信息工具</h3><p>jinfo（Configuration Info for Java）的作用是实时地查看和调整虚拟机各项参数。使用jps命令的-v参数可以查看虚拟机启动时显式指定的参数列表，但如果想指定未被显式指定的参数的系统默认值，就可以使用<code>jinfo</code>的<code>-flag</code>选项进行查询，<code>jinfo</code>还可以使用<code>-sysprops</code>选项把虚拟机进程的<code>System.getProperties()</code>的内容打印出来。</p>
<p><code>jinfo的命令格式：</code></p>
<p><code>jinfo [ option ] pid </code></p>
<h3 id="jmap：-Java内存映像工具"><a href="#jmap：-Java内存映像工具" class="headerlink" title="jmap： Java内存映像工具"></a>jmap： Java内存映像工具</h3><p>jmap（Memory Map for Java）命令用于生成堆转储快照（一般称为dump或是heapdump文件）。如果不使用jmap命令，要想获取Java堆转储快照，可以使用</p>
<p><code>-XX:+HeapDumpOnOutOfMemoryError</code>参数，可以让虚拟机在OOM异常出现之后自动生成dump文件，通过<code>-XX:+HeapDumpOnCtrlBreak</code>参数则可以使用<code>[Ctrl] + [Break]</code>键让虚拟机生成dump文件，又或者在Linux系统下通过<code>Kill -3</code>命令发送进程退出信号，让虚拟机生成dump文件。</p>
<p>jmap的作用并不仅仅是为了获取dump文件，它还可以查询<code>finalize</code>执行队列、Java堆、元空间（Jdk8以后）或永久代（Jdk8以前）的详细信息，如空间使用率、当前用的是哪种收集器等。</p>
<p><code>jmap的命令格式：</code></p>
<p><code>jmap [ option ] pid </code></p>
<p>jmap工具的主要选项：</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-dump</td>
<td>生成Java堆转储快照。格式为：<code>-dump:[live, ]format=b, file=&lt;filename&gt;</code>，其中live子参数说明只dump存活的对象</td>
</tr>
<tr>
<td align="center">-finalizerinfo</td>
<td>显示在F-Queue中等待Finalizer线程执行finalize方法的对象。只在Linux/Solaris平台有效</td>
</tr>
<tr>
<td align="center">-heap</td>
<td>显示Java堆详细，如使用哪种垃圾收集器、参数配置、分代状况等。只在Linux/Solaris平台有效</td>
</tr>
<tr>
<td align="center">-histo</td>
<td>显示堆中对象统计信息，包括类、实例数量、合计容量</td>
</tr>
<tr>
<td align="center">-permstat</td>
<td>以ClassLoader为统计口径显示永久代或元空间内存状态。只在Linux/Solaris平台有效</td>
</tr>
<tr>
<td align="center">-F</td>
<td>当虚拟机进程对-dump选项没有响应时，可使用这个选项强制生成dump快照。只在Linux/Solaris平台有效</td>
</tr>
</tbody></table>
<p>以下是jmap生成dump快照的示例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.8.0_171\bin&gt;jmap -dump:format=b,file=D:\dump.hprof 8812</span><br><span class="line">Dumping heap to D:\dump.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>

<h3 id="jhat：-虚拟机堆转储快照分析工具"><a href="#jhat：-虚拟机堆转储快照分析工具" class="headerlink" title="jhat： 虚拟机堆转储快照分析工具"></a>jhat： 虚拟机堆转储快照分析工具</h3><p>Sun JDK提供jhat（JVM Heap Analysis Tool）命令与jmap搭配使用，来分析jmap生成的堆转储快照。jhat内置了一个微型的HTTP/HTML服务器，生成的dump文件的分析结果后，可以在浏览器中查看。一般不建议使用。可以使用其他工具分析，比如Eclipse Memory Analyzer、IBM HeapAnalyzer或JProfiler等工具，都可以实现更强大更专业的分析功能。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.8.0_171\bin&gt;jhat d:\dump.hprof</span><br><span class="line">Reading from d:\dump.hprof...</span><br><span class="line">Dump file created Thu Aug 20 21:22:50 CST 2020</span><br><span class="line">Snapshot read, resolving...</span><br><span class="line">Resolving 617466 objects...</span><br><span class="line">Chasing references, expect 123 dots...........................................................................................................................</span><br><span class="line">Eliminating duplicate references...........................................................................................................................</span><br><span class="line">Snapshot resolved.</span><br><span class="line">Started HTTP server on port 7000</span><br><span class="line">Server is ready.</span><br></pre></td></tr></table></figure>

<p>在浏览器输入<code>http://localhost:7000</code>即可查看分析结果。</p>
<h3 id="jstack-：Java堆栈跟踪工具"><a href="#jstack-：Java堆栈跟踪工具" class="headerlink" title="jstack ：Java堆栈跟踪工具"></a>jstack ：Java堆栈跟踪工具</h3><p>jstack（Stack Trace for Java）命令用于生成虚拟机当前时刻的线程快照（一般称为threaddump或者javacore文件）。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等等都是导致线程长时间停顿的原因。线程出现停顿的时候通过jstack来查看各线程的调用堆栈，就可以知道没有响应的现场到底在后台做些什么事情，或者等待什么资源。</p>
<p><code>jtack的命令格式：</code></p>
<p><code>jstack [ option ] vmid </code></p>
<p>jstack工具主要选项</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-F</td>
<td>当正常输出的请求不被响应时，强制输出线程堆栈</td>
</tr>
<tr>
<td align="center">-l</td>
<td>除堆栈外，显示关于锁的附加信息</td>
</tr>
<tr>
<td align="center">-m</td>
<td>如果调用到本地方法的话，可以显示C/C++的堆栈</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">C:\Program Files\Java\jdk1.8.0_171\bin&gt;jstack 3984</span><br><span class="line">2020-08-23 12:26:14</span><br><span class="line">Full thread dump OpenJDK 64-Bit Server VM (11.0.6+8-b765.40 mixed mode, sharing):</span><br><span class="line"></span><br><span class="line">Threads class SMR info:</span><br><span class="line">_java_thread_list=0x0000022dbefdb6d0, length=17, elements=&#123;</span><br><span class="line">0x0000022da3b28000, 0x0000022dbcc65800, 0x0000022dbcc67000, 0x0000022dbcc88800,</span><br><span class="line">0x0000022dbcc8b800, 0x0000022dbcc8d800, 0x0000022dbccf9800, 0x0000022dbd501000,</span><br><span class="line">0x0000022dbd5e4800, 0x0000022dbd5ea800, 0x0000022dbe0b6800, 0x0000022dbe0ab000,</span><br><span class="line">0x0000022dbe140800, 0x0000022dbe0e6800, 0x0000022dbe1bd800, 0x0000022dbe1ae800,</span><br><span class="line">0x0000022dbf12f000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;main&quot; #1 prio=5 os_prio=0 cpu=484.38ms elapsed=1227.43s tid=0x0000022da3b28000 nid=0x1ec0 in Object.wait()  [0x000000e64f7ff000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(java.base@11.0.6/Native Method)</span><br><span class="line">        - waiting on &lt;0x00000000d00e2010&gt; (a java.lang.Object)</span><br><span class="line">        at com.intellij.execution.rmi.RemoteServer.start(RemoteServer.java:91)</span><br><span class="line">        - waiting to re-lock in wait() &lt;0x00000000d00e2010&gt; (a java.lang.Object)</span><br><span class="line">        at org.jetbrains.idea.maven.server.RemoteMavenServer36.main(RemoteMavenServer36.java:23)</span><br><span class="line"></span><br><span class="line">&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=2 cpu=0.00ms elapsed=1227.39s tid=0x0000022dbcc65800 nid=0x29e8 waiting on condition  [0x000000e64feff000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.lang.ref.Reference.waitForReferencePendingList(java.base@11.0.6/Native Method)</span><br><span class="line">        at java.lang.ref.Reference.processPendingReferences(java.base@11.0.6/Reference.java:241)</span><br><span class="line">        at java.lang.ref.Reference$ReferenceHandler.run(java.base@11.0.6/Reference.java:213)</span><br><span class="line"></span><br><span class="line">&quot;Finalizer&quot; #3 daemon prio=8 os_prio=1 cpu=0.00ms elapsed=1227.39s tid=0x0000022dbcc67000 nid=0x3158 in Object.wait()  [0x000000e64fffe000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(java.base@11.0.6/Native Method)</span><br><span class="line">        - waiting on &lt;0x00000000d00e23c0&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(java.base@11.0.6/ReferenceQueue.java:155)</span><br><span class="line">        - waiting to re-lock in wait() &lt;0x00000000d00e23c0&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(java.base@11.0.6/ReferenceQueue.java:176)</span><br><span class="line">        at java.lang.ref.Finalizer$FinalizerThread.run(java.base@11.0.6/Finalizer.java:170)</span><br><span class="line"></span><br><span class="line">&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=2 cpu=0.00ms elapsed=1227.38s tid=0x0000022dbcc88800 nid=0x2364 runnable  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Attach Listener&quot; #5 daemon prio=5 os_prio=2 cpu=0.00ms elapsed=1227.38s tid=0x0000022dbcc8b800 nid=0x21d8 waiting on condition  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C2 CompilerThread0&quot; #6 daemon prio=9 os_prio=2 cpu=1109.38ms elapsed=1227.38s tid=0x0000022dbcc8d800 nid=0x57c waiting on condition  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">   No compile task</span><br><span class="line"></span><br><span class="line">&quot;C1 CompilerThread0&quot; #8 daemon prio=9 os_prio=2 cpu=671.88ms elapsed=1227.37s tid=0x0000022dbccf9800 nid=0x18bc waiting on condition  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">   No compile task</span><br><span class="line"></span><br><span class="line">&quot;Sweeper thread&quot; #9 daemon prio=9 os_prio=2 cpu=0.00ms elapsed=1227.36s tid=0x0000022dbd501000 nid=0x12d4 runnable  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Service Thread&quot; #10 daemon prio=9 os_prio=0 cpu=0.00ms elapsed=1227.33s tid=0x0000022dbd5e4800 nid=0xe38 runnable  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Common-Cleaner&quot; #11 daemon prio=8 os_prio=1 cpu=0.00ms elapsed=1227.33s tid=0x0000022dbd5ea800 nid=0x488 in Object.wait()  [0x000000e6507fe000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(java.base@11.0.6/Native Method)</span><br><span class="line">        - waiting on &lt;0x00000000d01a1f98&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(java.base@11.0.6/ReferenceQueue.java:155)</span><br><span class="line">        - waiting to re-lock in wait() &lt;0x00000000d01a1f98&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at jdk.internal.ref.CleanerImpl.run(java.base@11.0.6/CleanerImpl.java:148)</span><br><span class="line">        at java.lang.Thread.run(java.base@11.0.6/Thread.java:834)</span><br><span class="line">        at jdk.internal.misc.InnocuousThread.run(java.base@11.0.6/InnocuousThread.java:134)</span><br><span class="line">        </span><br><span class="line"> // .................</span><br><span class="line"> </span><br><span class="line">&quot;RMI TCP Connection(idle)&quot; #27 daemon prio=5 os_prio=0 cpu=0.00ms elapsed=24.77s tid=0x0000022dbf12f000 nid=0x1724 waiting on condition  [0x000000e64f5fe000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line">        at jdk.internal.misc.Unsafe.park(java.base@11.0.6/Native Method)</span><br><span class="line">        - parking to wait for  &lt;0x00000000d00b9568&gt; (a java.util.concurrent.SynchronousQueue$TransferStack)</span><br><span class="line">        at java.util.concurrent.locks.LockSupport.parkNanos(java.base@11.0.6/LockSupport.java:234)</span><br><span class="line">        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(java.base@11.0.6/SynchronousQueue.java:462)</span><br><span class="line">        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(java.base@11.0.6/SynchronousQueue.java:361)</span><br><span class="line">        at java.util.concurrent.SynchronousQueue.poll(java.base@11.0.6/SynchronousQueue.java:937)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.getTask(java.base@11.0.6/ThreadPoolExecutor.java:1053)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@11.0.6/ThreadPoolExecutor.java:1114)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@11.0.6/ThreadPoolExecutor.java:628)</span><br><span class="line">        at java.lang.Thread.run(java.base@11.0.6/Thread.java:834)</span><br><span class="line"></span><br><span class="line">&quot;VM Thread&quot; os_prio=2 cpu=31.25ms elapsed=1227.40s tid=0x0000022dbcc60000 nid=0x1d6c runnable</span><br><span class="line"></span><br><span class="line">&quot;GC Thread#0&quot; os_prio=2 cpu=31.25ms elapsed=1227.42s tid=0x0000022da3b44000 nid=0x2d7c runnable</span><br><span class="line"></span><br><span class="line">&quot;GC Thread#1&quot; os_prio=2 cpu=31.25ms elapsed=1226.21s tid=0x0000022dbe605800 nid=0x2220 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC Thread#2&quot; os_prio=2 cpu=15.63ms elapsed=1226.21s tid=0x0000022dbe58c800 nid=0x2200 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC Thread#3&quot; os_prio=2 cpu=15.63ms elapsed=1226.21s tid=0x0000022dbe3bf800 nid=0x22e0 runnable</span><br><span class="line"></span><br><span class="line">&quot;G1 Main Marker&quot; os_prio=2 cpu=0.00ms elapsed=1227.42s tid=0x0000022da3b58800 nid=0x191c runnable</span><br><span class="line"></span><br><span class="line">&quot;G1 Conc#0&quot; os_prio=2 cpu=0.00ms elapsed=1227.42s tid=0x0000022da3b5a000 nid=0x8a0 runnable</span><br><span class="line"></span><br><span class="line">&quot;G1 Refine#0&quot; os_prio=2 cpu=15.63ms elapsed=1227.41s tid=0x0000022da3be4000 nid=0x148c runnable</span><br><span class="line"></span><br><span class="line">&quot;G1 Refine#1&quot; os_prio=2 cpu=0.00ms elapsed=1226.20s tid=0x0000022dbd68e800 nid=0x1460 runnable</span><br><span class="line"></span><br><span class="line">&quot;G1 Young RemSet Sampling&quot; os_prio=2 cpu=0.00ms elapsed=1227.41s tid=0x0000022da3be7000 nid=0x1e44 runnable</span><br><span class="line">&quot;VM Periodic Task Thread&quot; os_prio=2 cpu=0.00ms elapsed=1227.33s tid=0x0000022dbd5e5800 nid=0x4a8 waiting on condition</span><br><span class="line"></span><br><span class="line">JNI global refs: 17, weak refs: 0</span><br></pre></td></tr></table></figure>



<h3 id="基础工具总结"><a href="#基础工具总结" class="headerlink" title="基础工具总结"></a>基础工具总结</h3><h4 id="基础工具"><a href="#基础工具" class="headerlink" title="基础工具"></a>基础工具</h4><p>用于支持基本的程序创建和运行</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">appletviewer</td>
<td>在不使用Web浏览器的情况下运行和调试Applet、JDK11中被移除</td>
</tr>
<tr>
<td align="center">extcheck</td>
<td>检测Jar冲突的工具，从JDK9移除</td>
</tr>
<tr>
<td align="center">jar</td>
<td>创建和管理Jar文件</td>
</tr>
<tr>
<td align="center">java</td>
<td>Java运行工具，用于运行Class文件或Jar文件</td>
</tr>
<tr>
<td align="center">javac</td>
<td>用于Java的编程语言的编译器</td>
</tr>
<tr>
<td align="center">javadoc</td>
<td>Java的API文档生成器</td>
</tr>
<tr>
<td align="center">javah</td>
<td>C语言头文件和Stub函数生成器，用于编写JNI方法</td>
</tr>
<tr>
<td align="center">javap</td>
<td>Java字节码分析工具</td>
</tr>
<tr>
<td align="center">jlink</td>
<td>将Module和它的依赖打包成一个运行时镜像文件</td>
</tr>
<tr>
<td align="center">jdb</td>
<td>基于JPDA协议的调试器，以类似于GDB的方式进行调试Java代码</td>
</tr>
<tr>
<td align="center">jdeps</td>
<td>Java类依赖性分析器</td>
</tr>
<tr>
<td align="center">jdeprscan</td>
<td>用于搜索Jar包中使用了“Deprecated”的类，从JDK9开始提供</td>
</tr>
</tbody></table>
<h4 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h4><p>用于程序签名、设置安全测试等</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">keytool</td>
<td>管理密钥库和证书。主要用于获取或缓存Kerberos协议的票据授权票据。允许用户查看本地凭据缓存和秘钥表中的条目</td>
</tr>
<tr>
<td align="center">jarsigner</td>
<td>生成并验证Jar签名</td>
</tr>
<tr>
<td align="center">policytool</td>
<td>管理策略文件的GUI工具，用于管理用户策略文件（.java.policy），在JDK10中被移除</td>
</tr>
</tbody></table>
<h4 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h4><p>用于创建本地语言文件</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">native2ascii</td>
<td>本地编码到ASCII编码的转换器（Native-to-ASCII Converter），用于“任意受支持的字符编码”和与之对应的“ASCII编码和Unicode转义”之间的相互转换</td>
</tr>
</tbody></table>
<h4 id="远程方法调用"><a href="#远程方法调用" class="headerlink" title="远程方法调用"></a>远程方法调用</h4><p>用于跨Web或网络的服务交互</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">rmic</td>
<td>Java RMI编译器，为使用JRMP或IIOP协议的远程对象生成Stub、Skeleton和Tie类，也用于生成OMG IDL</td>
</tr>
<tr>
<td align="center">rmiregistry</td>
<td>远程对象注册表服务，用于在当前主机的指定端口上创建并启动一个远程对象注册表</td>
</tr>
<tr>
<td align="center">rmid</td>
<td>启动激活系统守护进程，允许在虚拟机中注册或激活对象</td>
</tr>
<tr>
<td align="center">serialver</td>
<td>生成并返回指定类的序列化版本ID</td>
</tr>
</tbody></table>
<h4 id="Java-IDL与RMI-IIOP"><a href="#Java-IDL与RMI-IIOP" class="headerlink" title="Java IDL与RMI-IIOP"></a>Java IDL与RMI-IIOP</h4><p>在JDK 11中结束了十余年的CORBA支持，这些工具不在提供</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">tnameserv</td>
<td>提供对命名服务的访问</td>
</tr>
<tr>
<td align="center">idlj</td>
<td>IDL转Java编译器（IDL-to-Java Compiler），生成映射OMG IDL接口的Java源文件，并启用以Java编程语言编写的使用CORBA功能的应用程序的Java源文件。IDL意即接口定义语言（Interface Definition Language）</td>
</tr>
<tr>
<td align="center">orbd</td>
<td>对象请求代理守护进程（Object Request Broker Daemon），提供从客户端查找和调用CORBA环境服务端上的持久化对象的功能。使用CORBA代理瞬态命名服务tnameserv。ORBD包括瞬态命名服务和持久化命名服务。ORBD工具集成了服务器管理器、互操作命名服务和引导名称服务器的功能。当客户端想进行服务器时定位、注册和激活功能时，可以与servertool一起使用</td>
</tr>
<tr>
<td align="center">servertool</td>
<td>为应用程序注册、注销、启动和关闭服务器提供易用的接口</td>
</tr>
</tbody></table>
<h4 id="部署工具"><a href="#部署工具" class="headerlink" title="部署工具"></a>部署工具</h4><p>用于程序打包、发布和部署。</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">javapackager</td>
<td>打包、签名Java和JavaFX应用程序，在JDK11中被移除</td>
</tr>
<tr>
<td align="center">pack200</td>
<td>使用Java GZIP压缩器将JAR文件转换为压缩的Pack200文件。压缩的压缩文件是高度压缩的JAR，可以直接部署，节省带宽并减少下载时间</td>
</tr>
<tr>
<td align="center">unpack200</td>
<td>将Pack200生成的打包文件解压提取为JAR文件</td>
</tr>
</tbody></table>
<h4 id="Java-Web-Start"><a href="#Java-Web-Start" class="headerlink" title="Java Web Start"></a>Java Web Start</h4><table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">javaws</td>
<td>启动Java Web Start并设置各种选项的工具。在JDK11中被移除</td>
</tr>
</tbody></table>
<h4 id="性能监控和故障处理"><a href="#性能监控和故障处理" class="headerlink" title="性能监控和故障处理"></a>性能监控和故障处理</h4><p>用于监控分析Java虚拟机运行信息，排查问题</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">jps</td>
<td>JVM Process Status Tool，显示指定系统内所有的HotSpot虚拟机进程</td>
</tr>
<tr>
<td align="center">jstat</td>
<td>JVM Statistics Monitoring Tool，用于收集HotSpot虚拟机各方面的运行数据</td>
</tr>
<tr>
<td align="center">jstatd</td>
<td>JVM Statistics Monitoring Tool Daemon，jstat的守护程序，启动一个RMI服务器应用程序，用于监测测试的HotSpot虚拟机的创建和终止，并提供一个界面，运行远程监控工具附加到在本地系统上运行的虚拟机。在JDK9中集成到了JHSDB中</td>
</tr>
<tr>
<td align="center">jinfo</td>
<td>Configuration Info for Java，显示虚拟机配置信息。在JDK9中集成到了JHSDB中</td>
</tr>
<tr>
<td align="center">jmap</td>
<td>Memory Map for Java，生成虚拟机的内存转储快照（heapdump文件）。在JDK9中集成到了JHSDB中</td>
</tr>
<tr>
<td align="center">jhat</td>
<td>JVM Heap Analysis Tool，用于分析堆转储快照，它会建立一个HTTP/Web服务器， 让用户可以在浏览器上查看分析的结果。在JDK9中被JHSDB代替</td>
</tr>
<tr>
<td align="center">jstack</td>
<td>Stack Trace for Java，显示虚拟机的线程快照。在JDK9中集成到了JHSDB中</td>
</tr>
<tr>
<td align="center">jhsdb</td>
<td>Java HotSpot Debugger，一个基于Serviceability Agent的HotSpot进程调试器，从JDK9开始提供</td>
</tr>
<tr>
<td align="center">jsadebugd</td>
<td>Java Serviceability Agent Debug Daemon，适用于Java的可维护性代理调试守护程序，主要用于附加到指定的Java进程、核心文件，或充当一个调试服务器</td>
</tr>
<tr>
<td align="center">jcmd</td>
<td>JVM Command，虚拟机诊断命令工具，将诊断命令请求发送到正在运行的Java虚拟机。从JDK7开始提供</td>
</tr>
<tr>
<td align="center">jconsole</td>
<td>Java Console，用于监控Java虚拟机的使用JMX规范的图形工具。它可以监控本地和远程Java虚拟机，还可以监控和管理应用程序</td>
</tr>
<tr>
<td align="center">jmc</td>
<td>Java Mission Control，包含用于监控和管理Java应用程序的工具，而不会引入与这些工具相关联的性能开销。开发者可以使用jmc命令来创建JMC工具，从JDK7 Update 40开始集成到OracleJDK中</td>
</tr>
<tr>
<td align="center">jvisualvm</td>
<td>Java VisualVM，一种图形工具，可在Java虚拟机中运行时提供有关基于Java技术的应用程序（Java应用程序）的详细信息。Java VisualVM提供内存和CPU分析、堆转储分析、内存泄漏检测、MBean访问和垃圾收集。从JDK6 Update 7开始提供；从JDK9开始不再打包入JDK中，但仍然保持更新发展，可以独立下载使用</td>
</tr>
</tbody></table>
<h4 id="WebService工具"><a href="#WebService工具" class="headerlink" title="WebService工具"></a>WebService工具</h4><p>与CORBA一起在JDK11被移除</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">schemagen</td>
<td>用于XML绑定的Schema生成器，用于生成XML Schema文件</td>
</tr>
<tr>
<td align="center">wsgen</td>
<td>XML Web Service 2.0的Java API，生成用于JAX-WS Web Service的JAX-WS便携式产物</td>
</tr>
<tr>
<td align="center">wsimport</td>
<td>XML Web Service 2.0的Java API，主要用于根据服务端发布的WSDL文件生成客户端</td>
</tr>
<tr>
<td align="center">xjc</td>
<td>主要用于根据XML Schema文件生成对应的Java类</td>
</tr>
</tbody></table>
<h4 id="REPL和脚本工具"><a href="#REPL和脚本工具" class="headerlink" title="REPL和脚本工具"></a>REPL和脚本工具</h4><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">主要作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">jshell</td>
<td align="center">基于Java的Shell REPL（Read-Eval-Print Loop）交互工具</td>
</tr>
<tr>
<td align="center">jjs</td>
<td align="center">对Nashorn引擎的调用入口。Nashorn是基于Java实现的一个轻量级高性能JavaScript运行环境</td>
</tr>
<tr>
<td align="center">jrunscript</td>
<td align="center">Java命令行脚本外壳工具（Command Line Script Shell），主要用于解释执行JavaScript、Groovy、Ruby等脚本语言</td>
</tr>
</tbody></table>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文介绍了JDK提供的自带的常用故障处理工具，在日常线上环境使用的尤为频繁，JDK还提供了可视化的工具就不介绍了，有兴趣的可以自己去尝试使用，如：JConsole和VisualVM等可视化工具。</p>
]]></content>
      <categories>
        <category>JVM笔记</category>
      </categories>
      <tags>
        <tag>JVM性能监控工具</tag>
        <tag>JVM故障处理工具</tag>
        <tag>JDK工具</tag>
      </tags>
  </entry>
  <entry>
    <title>每天一个设计模式之工厂模式</title>
    <url>/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gimfethgrmj30ly0am74z.jpg"></p>
<a id="more"></a>

<h2 id="每天一个设计模式之工厂模式"><a href="#每天一个设计模式之工厂模式" class="headerlink" title="每天一个设计模式之工厂模式"></a>每天一个设计模式之工厂模式</h2><h3 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h3><h4 id="初识需要变化的方面"><a href="#初识需要变化的方面" class="headerlink" title="初识需要变化的方面"></a>初识需要变化的方面</h4><p>假如你有一个比萨店，身为比萨店的主人，你的代码可能会这么写：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 普通比萨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 21:39:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 制作比萨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Pizza <span class="title">orderPizza</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Pizza pizza = <span class="keyword">new</span> Pizza();</span><br><span class="line">        pizza.prepare();</span><br><span class="line">        pizza.bake();</span><br><span class="line">        pizza.cut();</span><br><span class="line">        pizza.box();</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">box</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Packed Pizza&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cut Pizza&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 烘烤比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bake</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bake Pizza&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 准备比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Prepare Pizza&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="假如你需要更多的比萨类型"><a href="#假如你需要更多的比萨类型" class="headerlink" title="假如你需要更多的比萨类型"></a>假如你需要更多的比萨类型</h4><p>所以需要增加一些代码，来决定适合的比萨类型，然后再制作比萨：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Pizza <span class="title">orderPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">    Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 根据不同的类型，创建不同的实例对象</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;cheese&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> CheesePizza();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;greek&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> GreekPizza();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;pepperoni&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> PepperoniPizza();</span><br><span class="line">    &#125;</span><br><span class="line">    pizza.prepare();</span><br><span class="line">    pizza.bake();</span><br><span class="line">    pizza.cut();</span><br><span class="line">    pizza.box();</span><br><span class="line">    <span class="keyword">return</span> pizza;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="如果需要增加更多的类型比萨"><a href="#如果需要增加更多的类型比萨" class="headerlink" title="如果需要增加更多的类型比萨"></a>如果需要增加更多的类型比萨</h4><p>此时，如果我们需要增加更多可口的比萨呢，就需要在代码中重新增加类型，随着时间的变化，类型会不断的改变，这无疑是个灾难。</p>
<p>这个时候，该是用封装的时候了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Pizza <span class="title">orderPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">    Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 根据不同的类型，创建不同的实例对象</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;cheese&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> CheesePizza();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;greek&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> GreekPizza();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;pepperoni&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> PepperoniPizza();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;clam&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> ClamPizza();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;veggie&quot;</span>.equals(type)) &#123;</span><br><span class="line">       pizza = <span class="keyword">new</span> VeggiePizza();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... 省略制作过程</span></span><br><span class="line">    <span class="keyword">return</span> pizza;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="建立一个简单比萨工厂"><a href="#建立一个简单比萨工厂" class="headerlink" title="建立一个简单比萨工厂"></a>建立一个简单比萨工厂</h4><p>先从工厂本身开始，我们要为所有比萨封装创建对象的代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单的比萨工厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 22:05:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePizzaFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 根据不同的类型，创建不同的实例对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;cheese&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> CheesePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;greek&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> GreekPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;pepperoni&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> PepperoniPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;clam&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ClamPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;veggie&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> VeggiePizza();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设计比萨店类"><a href="#设计比萨店类" class="headerlink" title="设计比萨店类"></a>设计比萨店类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比萨店</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 21:39:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimplePizzaFactory simplePizzaFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PizzaStore</span><span class="params">(SimplePizzaFactory simplePizzaFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.simplePizzaFactory = simplePizzaFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 制作比萨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Pizza <span class="title">orderPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = simplePizzaFactory.createPizza(type);</span><br><span class="line">        pizza.prepare();</span><br><span class="line">        pizza.bake();</span><br><span class="line">        pizza.cut();</span><br><span class="line">        pizza.box();</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="让我们来定义简单工厂"><a href="#让我们来定义简单工厂" class="headerlink" title="让我们来定义简单工厂"></a>让我们来定义简单工厂</h4><p>简单工厂其实不是一个设计模式，反而比较像是一种编程习惯。</p>
<h4 id="简单工厂模式类图"><a href="#简单工厂模式类图" class="headerlink" title="简单工厂模式类图"></a>简单工厂模式类图</h4><p><img src="http://wx1.sinaimg.cn/large/008aQ1h9ly1ghqp8y74saj30qc0gcwlw.jpg"></p>
<h3 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h3><h4 id="加盟比萨店"><a href="#加盟比萨店" class="headerlink" title="加盟比萨店"></a>加盟比萨店</h4><p>因为我们的比萨店经营有成，现在很多人想加盟我们的比萨店。但是不同区域是有差异的， 比如：纽约、芝加哥、加州等各地的加盟店之间口味也有差异。</p>
<h4 id="改造我们的比萨店"><a href="#改造我们的比萨店" class="headerlink" title="改造我们的比萨店"></a>改造我们的比萨店</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 我们的比萨店</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 22:20:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 订购比萨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">orderPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = createPizza(type);</span><br><span class="line">        pizza.prepare();</span><br><span class="line">        pizza.bake();</span><br><span class="line">        pizza.cut();</span><br><span class="line">        pizza.box();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义抽象的制作比萨方法</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在已经有一个<code>PizzaStore</code>作为超类，让每个区域加盟比萨店（<code>NewYorkPizzaStore、ChicagoPizzaStore</code>）都继承这个<code>PizzaStore</code>，每个子类各自决定如何制造比萨。</p>
<h4 id="让我们开一家纽约风味的比萨店吧"><a href="#让我们开一家纽约风味的比萨店吧" class="headerlink" title="让我们开一家纽约风味的比萨店吧"></a>让我们开一家纽约风味的比萨店吧</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 纽约风味的比萨店</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 22:18:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewYorkPizzaStore</span> <span class="keyword">extends</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 根据不同的类型，创建不同的实例对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;cheese&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> NewYorkStyleCheesePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;pepperoni&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> NewYorkStylePepperoniPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;clam&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> NewYorkStyleClamPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;veggie&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> NewYorkStyleVeggiePizza();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="让我们再开一家芝加哥风味的比萨店吧"><a href="#让我们再开一家芝加哥风味的比萨店吧" class="headerlink" title="让我们再开一家芝加哥风味的比萨店吧"></a>让我们再开一家芝加哥风味的比萨店吧</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 芝加哥风味的比萨店</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 22:18:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChicagoPizzaStore</span> <span class="keyword">extends</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 根据不同的类型，创建不同的实例对象</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;cheese&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ChicagoStyleCheesePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;pepperoni&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ChicagoStylePepperoniPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;clam&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ChicagoStyleClamPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;veggie&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ChicagoStyleVeggiePizza();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="改造我们的比萨吧"><a href="#改造我们的比萨吧" class="headerlink" title="改造我们的比萨吧"></a>改造我们的比萨吧</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 普通比萨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 21:39:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> String dough;</span><br><span class="line">    <span class="keyword">protected</span> String sauce;</span><br><span class="line">    <span class="keyword">protected</span> ArrayList&lt;String&gt; toppings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">box</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Place pizza in official PizzaStore box&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cut the pizza into diagonal slices&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 烘烤比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bake</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bake for 25 minutes at 350&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 准备比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Prepare &quot;</span> + name +<span class="string">&quot; Pizza&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Tossing dough...&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding sauce...&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Adding toppings: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toppings.size(); i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;   &quot;</span> + toppings.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设计纽约风味的比萨"><a href="#设计纽约风味的比萨" class="headerlink" title="设计纽约风味的比萨"></a>设计纽约风味的比萨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 省略其他纽约风味的口味比萨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewYorkStyleCheesePizza</span> <span class="keyword">extends</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewYorkStyleCheesePizza</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.name = <span class="string">&quot;New York Style Sauce and Cheese Pizza&quot;</span>;</span><br><span class="line">        <span class="keyword">super</span>.dough = <span class="string">&quot;Thin Crust Dough&quot;</span>;</span><br><span class="line">        <span class="keyword">super</span>.sauce = <span class="string">&quot;Marinara Sauce&quot;</span>;</span><br><span class="line">        <span class="keyword">super</span>.toppings.add(<span class="string">&quot;Grated Reggiano Cheese&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设计芝加哥风味的比萨"><a href="#设计芝加哥风味的比萨" class="headerlink" title="设计芝加哥风味的比萨"></a>设计芝加哥风味的比萨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 省略其他芝加哥风味的口味比萨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChicagoStyleCheesePizza</span> <span class="keyword">extends</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChicagoStyleCheesePizza</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.name = <span class="string">&quot;Chicago Style Deep Dish Cheese Pizza&quot;</span>;</span><br><span class="line">        <span class="keyword">super</span>.dough = <span class="string">&quot;Extra Thick Crust Dough&quot;</span>;</span><br><span class="line">        <span class="keyword">super</span>.sauce = <span class="string">&quot;Plum Tomato Sauce&quot;</span>;</span><br><span class="line">        <span class="keyword">super</span>.toppings.add(<span class="string">&quot;Shredded Mozzarella Cheese&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 将芝加哥风味比萨切成正方形</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cutting the pizza into square slices&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="久等了，让我们来制作比萨吧"><a href="#久等了，让我们来制作比萨吧" class="headerlink" title="久等了，让我们来制作比萨吧"></a>久等了，让我们来制作比萨吧</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建纽约风味的比萨店</span></span><br><span class="line">        PizzaStore nyStore = <span class="keyword">new</span> NewYorkPizzaStore();</span><br><span class="line">        <span class="comment">// 创建芝加哥风味的比萨店</span></span><br><span class="line">        PizzaStore chicagoStore = <span class="keyword">new</span> ChicagoPizzaStore();</span><br><span class="line"></span><br><span class="line">        Pizza pizza = nyStore.orderPizza(<span class="string">&quot;cheese&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Ethan ordered a &quot;</span> + pizza.getName() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        pizza = chicagoStore.orderPizza(<span class="string">&quot;cheese&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Joel ordered a &quot;</span> + pizza.getName() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="认识工厂方法模式的时刻到了"><a href="#认识工厂方法模式的时刻到了" class="headerlink" title="认识工厂方法模式的时刻到了"></a>认识工厂方法模式的时刻到了</h4><p>所有工厂模式都用来封装对象的创建。工厂方法模式（<code>Factory Method Pattern</code>）通过让子类来决定该创建的对象是什么，来达到将对象创建的过程封装的目的。</p>
<h4 id="工厂方法模式类图"><a href="#工厂方法模式类图" class="headerlink" title="工厂方法模式类图"></a>工厂方法模式类图</h4><p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghqr9jwgpyj30wc0jkjzr.jpg"></p>
<h4 id="定义工厂方法模式"><a href="#定义工厂方法模式" class="headerlink" title="定义工厂方法模式"></a>定义工厂方法模式</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### 抽象工厂模式</span><br><span class="line"></span><br><span class="line">#### 设计原则</span><br><span class="line"></span><br><span class="line">要依赖对象，不要依赖具体类</span><br><span class="line"></span><br><span class="line">#### 依赖倒置原则</span><br><span class="line"></span><br><span class="line">下面的指导方针，能帮助我们避免在OO设计中违反依赖倒置原则：</span><br><span class="line"></span><br><span class="line">- 变量不可以持有具体类的引用</span><br><span class="line">- 不要让类派生自具体类</span><br><span class="line">- 不要覆盖基类中已实现的方法</span><br><span class="line"></span><br><span class="line">#### 重新建造原料工厂</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">&#x2F;**</span><br><span class="line"> * 建造原料工厂</span><br><span class="line"> * @author Mr.zxb</span><br><span class="line"> * @date 2020-08-15 10:05:27</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface PizzaIngredientFactory &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 创建面团</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Dough createDough();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 创建酱汁</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Sauce createSauce();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 创建奶酪</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Cheese createCheese();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     *创建蔬菜</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Veggies[] createVeggies();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     *创建意大利辣香肠</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Peppernoi createPepperoni();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 创建蛤蜊</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Clams createClam();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建纽约原料工厂"><a href="#创建纽约原料工厂" class="headerlink" title="创建纽约原料工厂"></a>创建纽约原料工厂</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 纽约比萨配料厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 10:11:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewYorkPizzaIngredientFactory</span> <span class="keyword">implements</span> <span class="title">PizzaIngredientFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dough <span class="title">createDough</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThinCrustDough();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sauce <span class="title">createSauce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarinaraSauce();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cheese <span class="title">createCheese</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReggianoCheese();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Veggies[] createVeggies() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Veggies[]&#123; <span class="keyword">new</span> Garlic(), <span class="keyword">new</span> Onion(), <span class="keyword">new</span> Mushroom(), <span class="keyword">new</span> RedPepper() &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Peppernoi <span class="title">createPepperoni</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SlicedPeppernoi();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Clams <span class="title">createClam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FreshClams();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="重做比萨···-···"><a href="#重做比萨···-···" class="headerlink" title="重做比萨··· ···"></a>重做比萨··· ···</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比萨抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 10:28:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> Dough dough;</span><br><span class="line">    <span class="keyword">protected</span> Sauce sauce;</span><br><span class="line">    <span class="keyword">protected</span> Veggies[] veggies;</span><br><span class="line">    <span class="keyword">protected</span> Cheese cheese;</span><br><span class="line">    <span class="keyword">protected</span> Peppernoi peppernoi;</span><br><span class="line">    <span class="keyword">protected</span> Clams clams;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">box</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Place pizza in official PizzaStore box&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cut the pizza into diagonal slices&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 烘烤比萨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bake</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bake for 25 minutes at 350&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pizza&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, dough=&quot;</span> + dough +</span><br><span class="line">                <span class="string">&quot;, sauce=&quot;</span> + sauce +</span><br><span class="line">                <span class="string">&quot;, veggies=&quot;</span> + Arrays.toString(veggies) +</span><br><span class="line">                <span class="string">&quot;, cheese=&quot;</span> + cheese +</span><br><span class="line">                <span class="string">&quot;, peppernoi=&quot;</span> + peppernoi +</span><br><span class="line">                <span class="string">&quot;, clams=&quot;</span> + clams +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 芝士披萨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 10:31:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheesePizza</span> <span class="keyword">extends</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PizzaIngredientFactory ingredientFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CheesePizza</span><span class="params">(PizzaIngredientFactory ingredientFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ingredientFactory = ingredientFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Preparing &quot;</span> + name);</span><br><span class="line">        <span class="keyword">super</span>.dough = ingredientFactory.createDough();</span><br><span class="line">        <span class="keyword">super</span>.sauce = ingredientFactory.createSauce();</span><br><span class="line">        <span class="keyword">super</span>.cheese = ingredientFactory.createCheese();</span><br><span class="line">        <span class="keyword">super</span>.veggies = ingredientFactory.createVeggies();</span><br><span class="line">        <span class="keyword">super</span>.clams = ingredientFactory.createClam();</span><br><span class="line">        <span class="keyword">super</span>.peppernoi = ingredientFactory.createPepperoni();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 蛤蜊比萨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 10:31:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClamPizza</span> <span class="keyword">extends</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PizzaIngredientFactory ingredientFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClamPizza</span><span class="params">(PizzaIngredientFactory ingredientFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ingredientFactory = ingredientFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Preparing &quot;</span> + name);</span><br><span class="line">        <span class="keyword">super</span>.dough = ingredientFactory.createDough();</span><br><span class="line">        <span class="keyword">super</span>.sauce = ingredientFactory.createSauce();</span><br><span class="line">        <span class="keyword">super</span>.cheese = ingredientFactory.createCheese();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="再回到比萨店"><a href="#再回到比萨店" class="headerlink" title="再回到比萨店"></a>再回到比萨店</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比萨店</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-14 22:20:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">orderPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = createPizza(type);</span><br><span class="line">        pizza.prepare();</span><br><span class="line">        pizza.bake();</span><br><span class="line">        pizza.cut();</span><br><span class="line">        pizza.box();</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 纽约风味比萨店</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-08-15 10:33:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewYorkPizzaStore</span> <span class="keyword">extends</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        PizzaIngredientFactory ingredientFactory = <span class="keyword">new</span> NewYorkPizzaIngredientFactory();</span><br><span class="line">        Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;cheese&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> CheesePizza(ingredientFactory);</span><br><span class="line">            pizza.setName(<span class="string">&quot;New York Style Cheese Pizza&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;clam&quot;</span>.equals(type)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ClamPizza(ingredientFactory);</span><br><span class="line">            pizza.setName(<span class="string">&quot;New York Style Clam Pizza&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ... 其他口味方法</span></span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="让我们来制作新的比萨吧"><a href="#让我们来制作新的比萨吧" class="headerlink" title="让我们来制作新的比萨吧"></a>让我们来制作新的比萨吧</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStoreTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建纽约风味比萨店</span></span><br><span class="line">        PizzaStore nyPizzaStore = <span class="keyword">new</span> NewYorkPizzaStore();</span><br><span class="line">        <span class="comment">// 制作芝士比萨</span></span><br><span class="line">        Pizza pizza = nyPizzaStore.orderPizza(<span class="string">&quot;cheese&quot;</span>);</span><br><span class="line">        System.out.println(pizza);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定义抽象工厂模式"><a href="#定义抽象工厂模式" class="headerlink" title="定义抽象工厂模式"></a>定义抽象工厂模式</h4><p>抽象工厂模式：提供一个接口，用于创建相关或依赖对象的家族，而不需要明确指定具体类。</p>
<p>抽象工厂允许客户使用抽象的接口来创建一组相关的产品，而不需要知道实际产出的具体产品是什么。这样一来，客户就从具体的产品中解耦。</p>
<h4 id="抽象工厂模式类图"><a href="#抽象工厂模式类图" class="headerlink" title="抽象工厂模式类图"></a>抽象工厂模式类图</h4><p><img src="http://wx3.sinaimg.cn/large/008aQ1h9ly1ghrbcpywyej30qx0kpdp6.jpg"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>所有的工厂都是用来封装对象的创建</li>
<li>简单工厂，虽然不是真正的设计模式，但仍不失为一个简单的方法，可以将客户程序从具体类解耦</li>
<li>工厂方法使用继承：把对象的创建委托给子类，子类实现工厂方法来创建对象</li>
<li>抽象工厂使用对象组合：对象的创建被实现在工厂接口所暴露出来的方法中</li>
<li>所有工厂模式都通过减少应用程序和具体类之间的依赖促进松耦合</li>
<li>工厂方法允许类将实例化延迟到子类进行</li>
<li>抽象工厂创建相关的对象家族，而不需要依赖它们的具体类</li>
<li>依赖倒置原则，指导我们避免依赖具体类型，而尽量依赖抽象</li>
<li>工厂是很有威力的技巧，帮助我们针对抽象编程，而不要针对具体类的编程</li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>工厂模式</tag>
      </tags>
  </entry>
  <entry>
    <title>面试总结（某地产）</title>
    <url>/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93%EF%BC%88%E6%9F%90%E5%9C%B0%E4%BA%A7%EF%BC%89/</url>
    <content><![CDATA[<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gimoby2nc7j30ku0b4gls.jpg"></p>
<a id="more"></a>

<h2 id="面试总结（某地产）"><a href="#面试总结（某地产）" class="headerlink" title="面试总结（某地产）"></a>面试总结（某地产）</h2><h3 id="gRPC-如何做负载的"><a href="#gRPC-如何做负载的" class="headerlink" title="gRPC 如何做负载的"></a>gRPC 如何做负载的</h3><p>gRPC负载均衡，官方只提供了<code>pick_first</code>和<code>round_robin</code>两种负载均衡策略</p>
<h3 id="gRPC-限流怎么做的"><a href="#gRPC-限流怎么做的" class="headerlink" title="gRPC 限流怎么做的"></a>gRPC 限流怎么做的</h3><p>可以通过信号量来做限流</p>
<h3 id="Dubbo-如何做负载的"><a href="#Dubbo-如何做负载的" class="headerlink" title="Dubbo 如何做负载的"></a>Dubbo 如何做负载的</h3><p>dubbo的负载均衡全部由AbstractLoadBalance的子类来实现，Dubbo默认采用的是随机负载策略</p>
<h3 id="Dubbo的负载均衡策略"><a href="#Dubbo的负载均衡策略" class="headerlink" title="Dubbo的负载均衡策略"></a>Dubbo的负载均衡策略</h3><p>dubbo 总共有四种负载均衡策略</p>
<ul>
<li>RandomLoadBalance 随机：默认情况下，dubbo 是 random load balance 随机调用实现负载均衡，可以对 provider 不同实例设置不同的权重，会按照权重来负载均衡，权重越大分配流量越高，一般就用这个默认的就可以了。</li>
<li>RoundRobinLoadBalance 轮询：这个的话默认就是均匀地将流量打到各个机器上去，但是如果各个机器的性能不一样，容易导致性能差的机器负载过高。所以此时需要调整权重，让性能差的机器承载权重小一些，流量少一些。</li>
<li>LeastActiveLoadBalance 最少活跃调用数：这个就是自动感知一下，如果某个机器性能越差，那么接收的请求越少，越不活跃，此时就会给不活跃的性能差的机器更少的请求。</li>
<li>ConsistentHashLoadBalance 一致性 Hash：一致性 Hash 算法，相同参数的请求一定分发到一个 provider 上去，provider 挂掉的时候，会基于虚拟节点均匀分配剩余的流量，抖动不会太大。如果你需要的不是随机负载均衡，是要一类请求都到一个节点，那就走这个一致性 Hash 策略。</li>
</ul>
<h3 id="Dubbo-的容错策略"><a href="#Dubbo-的容错策略" class="headerlink" title="Dubbo 的容错策略"></a>Dubbo 的容错策略</h3><p>dubbo 集群的六种容错策略：</p>
<ol>
<li>failover cluster 模式：失败自动切换，自动重试其他机器，默认就是这个，常见于读操作。（失败重试其它机器）</li>
<li>failfast cluster模式：一次调用失败就立即失败，常见于写操作。（调用失败就立即失败）</li>
<li>failsafe cluster 模式：出现异常时忽略掉，常用于不重要的接口调用，比如记录日志。</li>
<li>failback cluster 模式：失败了后台自动记录请求，然后定时重发，比较适合于写消息队列这种。</li>
<li>forking cluster 模式：并行调用多个 provider，只要一个成功就立即返回。</li>
<li>broadcacst cluster：逐个调用所有的 provider。</li>
</ol>
<h3 id="Spring-循环依赖怎么解决的，为什么使用三级缓存？"><a href="#Spring-循环依赖怎么解决的，为什么使用三级缓存？" class="headerlink" title="Spring 循环依赖怎么解决的，为什么使用三级缓存？"></a>Spring 循环依赖怎么解决的，为什么使用三级缓存？</h3><p>Spring无法解决构造器注入的循环依赖，可以解决setter注入的循环依赖并且只能解决单例bean的循环依赖</p>
<ol>
<li>先从一级缓存singletonObjects中去获取。（如果获取到就直接return）</li>
<li>如果获取不到或者对象正在创建中（isSingletonCurrentlyInCreation()），那就再从二级缓存earlySingletonObjects中获取。（如果获取到就直接return）</li>
<li>如果还是获取不到，且允许singletonFactories（allowEarlyReference=true）通过getObject()获取。就从三级缓存singletonFactory.getObject()获取。（如果获取到了就从singletonFactories中移除，并且放进earlySingletonObjects。其实也就是从三级缓存移动（是剪切、不是复制哦~）到了二级缓存）</li>
</ol>
<h3 id="Spring-Bean-生命周期"><a href="#Spring-Bean-生命周期" class="headerlink" title="Spring Bean 生命周期"></a>Spring Bean 生命周期</h3><p><a href="https://chivalry727.github.io/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93-2/#more">参考面试总结2</a>里的Spring Bean生命周期总结</p>
<h3 id="Spring-两种动态代理区别"><a href="#Spring-两种动态代理区别" class="headerlink" title="Spring 两种动态代理区别"></a>Spring 两种动态代理区别</h3><ul>
<li>Spring JDK原生动态代理是基于Java反射实现的，Java动态代理是基于接口的，如果对象没有实现接口，Spring就会使用CGLIB动态代理</li>
</ul>
<ul>
<li>CGLIB是一个基于ASM的字节码生成库，它允许我们在运行时对字节码进行修改和动态生成。CGLIB通过继承方式实现代理</li>
</ul>
<h3 id="Spring的BeanPostProcessor和BeanFactoryPostProcessor区别"><a href="#Spring的BeanPostProcessor和BeanFactoryPostProcessor区别" class="headerlink" title="Spring的BeanPostProcessor和BeanFactoryPostProcessor区别"></a>Spring的BeanPostProcessor和BeanFactoryPostProcessor区别</h3><p>BeanPostProcessor接口：后置bean处理器，允许自定义修改新的bean实例，应用程序上下文可以在其bean定义中自动检测BeanPostProcessor类型的bean，并将它们应用于随后创建的任何bean。（例如：配置文件中注册了一个自定义BeanPostProcessor类型的bean，一个User类型的bean，应用程序上下文会在创建User实例之后对User应用BeanPostProcessor）。</p>
<p>BeanFactoryPostProcessor接口：后置工厂处理器，允许自定义修改应用程序上下文的bean定义，调整bean属性值。应用程序上下文可以在其bean定义中自动检测BeanFactoryPostProcessor，并在创建任何非BeanFactoryPostProcessor类型bean之前应用它们（例如：配置文件中注册了一个自定义BeanFactoryPostProcessor类型的bean，一个User类型的bean，应用程序上下文会在创建User实例之前对User应用BeanFactoryPostProcessor）</p>
<h3 id="Spring-AOP-和-AspectJ-AOP-区别"><a href="#Spring-AOP-和-AspectJ-AOP-区别" class="headerlink" title="Spring AOP 和 AspectJ AOP 区别"></a>Spring AOP 和 AspectJ AOP 区别</h3><h4 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h4><ol>
<li>Spring是基于动态代理来实现的AOP，默认如果使用接口，就用JDK提供的动态代理实现；如果是方法则使用CGLIB实现</li>
<li>Spring AOP需要依赖IoC容器来管理，并且只能作用于Spring容器，使用纯Java代码实现</li>
<li>在性能上，由于Spring AOP是基于动态代理来实现的，在容器启动时需要生成代理实例，在方法调用上也会增加栈的深度，使得Spring AOP的性能不如AspectJ</li>
</ol>
<h4 id="AspectJ"><a href="#AspectJ" class="headerlink" title="AspectJ"></a>AspectJ</h4><ul>
<li>AspectJ来自于Eclipse基金会</li>
<li>AspectJ属于静态织入，通过修改代码来实现，有如下几个织入的时机：<ol>
<li>编译期织入（Compile-time weaving）：如类A使用AspectJ添加一个属性，类B引用了它，这个时候就需要编译期的时候进行织入，否则没法编译类B</li>
<li>编译后织入（Post-compile weaving）：也就是生成了<code>.class</code>文件或已经打成了jar包，这种情况我们需要增强处理的话，就要用到编译后织入</li>
<li>类加载后织入（Load-time weaving）：指的是在加载类的时候进行织入，要实现这个时期的织入，有几种常见的方法：<ol>
<li>自定义类加载器来干这个，这个应该是最容易想到的办法，在被织入类加载到JVM前去对它进行加载，这样就可以在加载到时候定义行为来</li>
<li>在JVM启动的时候指定AspectJ提供的agent:<code>-javaagent:xxx/xxx/aspectjweaver.jar</code></li>
</ol>
</li>
</ol>
</li>
<li>AspectJ可以做Spring AOP干不了的事情，它是AOP编程的完全解决方案，Spring AOP则致力于解决企业级开发中最普遍的AOP（方法织入）。而不是成为像AspectJ一样的AOP方案</li>
<li>因为AspectJ在实际运行之前就完成了织入，所以说它生成的类是没有额外运行时开销的</li>
</ul>
<h3 id="HashMap-如何解决hash碰撞，以及何时扩容的"><a href="#HashMap-如何解决hash碰撞，以及何时扩容的" class="headerlink" title="HashMap 如何解决hash碰撞，以及何时扩容的"></a>HashMap 如何解决hash碰撞，以及何时扩容的</h3><p><strong>Hash冲突</strong>：由于用于计算的数据是无限的<code>H(key),key属于(-∞,+∞)</code>,而映射到区间是有限的，所以肯定会存在两个key:key1,key2，H(key1)=H(key2)，这就是hash冲突。一般的解决Hash冲突方法有:开放定址法、再哈希法、链地址法（拉链法）、建立公共溢出区。</p>
<p><strong>开放地址法</strong>：也称为<code>再散列法</code>，基本思想就是，如果<code>p=H(key)</code>出现冲突时，则以<code>p</code>为基础，再次hash，<code>p1=H(p)</code>,如果p1再次出现冲突，则以p1为基础，以此类推，直到找到一个不冲突的哈希地址<code>pi</code>。 因此开放定址法所需要的hash表的长度要大于等于所需要存放的元素，而且因为存在再次hash，所以<code>只能在删除的节点上做标记，而不能真正删除节点。</code></p>
<p>缺点：容易产生堆积问题;不适合大规模的数据存储;插入时会发生多次冲突的情况;删除时要考虑与要删除元素互相冲突的另一个元素，比较复杂。</p>
<p><strong>再哈希法（双重散列，多重散列）</strong>：提供多个不同的hash函数，当<code>R1=H1(key1)</code>发生冲突时，再计算<code>R2=H2(key1)</code>，直到没有冲突为止。 这样做虽然不易产生堆集，但增加了计算的时间。</p>
<p><strong>链地址法（拉链法）</strong>：将哈希值相同的元素构成一个同义词的单链表,并将单链表的头指针存放在哈希表的第i个单元中，查找、插入和删除主要在同义词链表中进行。链表法适用于经常进行插入和删除的情况。HashMap采用的就是链地址法来解决hash冲突。(链表长度大于等于8时转为红黑树)</p>
<p><strong>建立公共溢出区</strong>：将哈希表分为公共表和溢出表，当溢出发生时，将所有溢出数据统一放到溢出区。</p>
<p><strong>何时扩容</strong>：HashMap的容量是有限的。当经过多次元素插入的时候，使得HashMap达到一定的饱和度，Key映射位置的几率不断变大。这个时候，HashMap就需要扩容了，也就是Resize。<strong>当 HashMap.size &gt;= Capacity*LoadFactor 时，HashMap可能会进行Resize。</strong></p>
<p>Hashmap的扩容需要满足两个条件：<strong>当前数据存储的数量（即size()）大小必须大于等于阈值；当前加入的数据是否发生了hash冲突。</strong></p>
<h3 id="ArrayList与LinkedList区别"><a href="#ArrayList与LinkedList区别" class="headerlink" title="ArrayList与LinkedList区别"></a>ArrayList与LinkedList区别</h3><ul>
<li>ArrayList基于数组实现的列表</li>
</ul>
<ul>
<li>LinkeddList基于链表实现的列表</li>
</ul>
<h3 id="LinkedHashMap如何实现有序的"><a href="#LinkedHashMap如何实现有序的" class="headerlink" title="LinkedHashMap如何实现有序的"></a>LinkedHashMap如何实现有序的</h3><p>LinkedHashMap是继承于HashMap，是基于HashMap和双向链表来实现的。</p>
<p>HashMap是无序的；LinkedHashMap有序的，可分为插入顺序和访问顺序两种。如果是访问顺序，那put和get操作已存在的Entry时，都会把Entry移动到双向链表的表尾(其实是先删除再插入)。</p>
<p>LinkedHashMap存取数据，还是跟HashMap一样使用的Entry[]的方式，双向链表只是为了保证顺序。</p>
<h3 id="Queue的阻塞队列用过哪几种"><a href="#Queue的阻塞队列用过哪几种" class="headerlink" title="Queue的阻塞队列用过哪几种"></a>Queue的阻塞队列用过哪几种</h3><p>Java提供了7个阻塞队列：</p>
<ul>
<li>ArrayBlockingQueue：一个由数组结构组成的有界阻塞队列<ul>
<li>ArrayBlockingQueue按照先进先出（FIFO）的原则对元素进行排序</li>
<li>默认情况下不保证线程公平的访问队列，所谓公平访问队列是指阻塞的线程，可以按照先后顺序访问队列</li>
<li>非公平性是对先等待的线程是非公平的，当队列可用时，阻塞的线程都可以争夺访问队列的资格</li>
<li>为了保证公平性，通常会降低吞吐量</li>
</ul>
</li>
<li>LinkedBlockingQueue：一个由链表结构组成的有界阻塞队列<ul>
<li>LinkedBlockingQueue队列默认和最大长度为Integer.MAX_VALUE</li>
<li>此队列也是按照先入先出（FIFO）的原则对元素进行排序</li>
</ul>
</li>
<li>PriorityBlockingQueue：一个支持优先级排序的无界阻塞队列<ul>
<li>默认情况下元素采取自然顺序升序排列</li>
<li>也可以自定义实现compareTo()方法来指定元素排序规则，或者初始化时，指定构造参数Comparator来对元素进行排序</li>
<li>需要注意的是不能保证同优先级元素的顺序</li>
</ul>
</li>
<li>DelayQueue：一个支持延时获取元素的无界阻塞队列<ul>
<li>DelayQueue队列使用PriorityQueue来实现</li>
<li>队列中的元素必须实现Delayed接口，在创建元素时可以指定多久才能从队列中获取当前元素</li>
<li>只有在延迟期满时才能从队列中提取元素</li>
</ul>
</li>
<li>SynchronousQueue：一个不存储元素的阻塞队列<ul>
<li>是一个不存储元素的阻塞队列</li>
<li>每个put操作必须等待一个take操作，否则不能继续添加元素</li>
<li>它支持公平访问队列，默认采用非公平性策略访问队列</li>
<li>该队列非常适合传递性场景</li>
</ul>
</li>
<li>LinkedTransferQueue：一个由链表结构组成的无界阻塞队列<ul>
<li>是一个由链表结构组成的无界阻塞TransferQueue队列</li>
<li>相比于其他阻塞队列，LinkedTransferQueue多个tryTransfer和transfer方法</li>
</ul>
</li>
<li>LinkedBlockingDeque：一个由链表结构组成的双向阻塞队列<ul>
<li>是一个由链表结构组成的双向阻塞队列</li>
<li>所谓双向队列指的是可以从队列的两端插入和移出元素</li>
<li>双向队列因为多了一个操作队列的入口、在多线程同时入队时，也就减少了一半的竞争</li>
<li>在初始化LinkedBlockingDeque时可以设置容量防止其过度膨胀</li>
<li>另外双向阻塞队列可以运用在“工作窃取”模式中</li>
</ul>
</li>
</ul>
<h3 id="AQS的实现原理"><a href="#AQS的实现原理" class="headerlink" title="AQS的实现原理"></a>AQS的实现原理</h3><h4 id="什么是AQS"><a href="#什么是AQS" class="headerlink" title="什么是AQS"></a>什么是AQS</h4><p>AQS全称为AbstractQueuedSynchronizer，它提供了一个FIFO队列，可以看成是一个用来实现同步锁以及其他涉及到同步功能的核心组件，常见的有：ReentrantLock、CountDownLatch、信号量等。AQS是一个抽象类，主要是通过继承的方式来使用，它本身没有实现任何的同步接口，仅仅是定义了同步状态的获取以及释放的方法来提供自定义的同步组件。</p>
<h4 id="AQS提供的功能"><a href="#AQS提供的功能" class="headerlink" title="AQS提供的功能"></a>AQS提供的功能</h4><p>从使用层面来说，AQS的功能分为两种：独占和共享</p>
<ul>
<li>独占锁：每次只能被一个线程持有锁，如：ReentrantLock</li>
<li>共享锁：允许多个线程同时获取锁，并发访问共享资源，如：ReentrantReadWriteLock</li>
</ul>
<h4 id="AQS的内部实现"><a href="#AQS的内部实现" class="headerlink" title="AQS的内部实现"></a>AQS的内部实现</h4><p>AQS的实现依赖内部的同步队列,也就是FIFO的双向队列，如果当前线程竞争锁失败，那么AQS会把当前线程以及等待状态信息构造成一个Node加入到同步队列中，同时再阻塞该线程。当获取锁的线程释放锁以后，会从队列中唤醒一个阻塞的节点(线程)。</p>
<p>AQS队列内部维护的是一个FIFO的双向链表，这种结构的特点是每个数据结构都有两个指针，分别指向直接的后继节点和直接前驱节点。所以双向链表可以从任意一个节点开始很方便的访问前驱和后继。每个Node其实是由线程封装，当线程争抢锁失败后会封装成Node加入到ASQ队列中去</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** 指示节点正在共享模式下等待的标记 */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="comment">/** 指示节点正在以独占模式等待的标记 */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** waitStatus值，指示线程已取消 */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** waitStatus值，指示后续线程需要释放 */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** waitStatus值，指示线程正在等待条件 */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * waitStatus值，指示下一个acquireShared应该无条件传播</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 前驱节点</span></span><br><span class="line">        <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 后置节点</span></span><br><span class="line">        <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 使该节点排队的线程。 在构造上初始化，使用后消失。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储在condition队列中的后继节点</span></span><br><span class="line">        Node nextWaiter;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果节点在共享模式下等待，则返回true。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 返回上一个节点，如果为null，则抛出NullPointerException。 </span></span><br><span class="line"><span class="comment">         * 空检查可能会被忽略，但是它可以帮助VM。</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the predecessor of this node</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">            Node p = prev;</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node() &#123;    <span class="comment">// 用于建立初始标头或SHARED标记</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node(Thread thread, Node mode) &#123;     <span class="comment">// 由addWaiter使用</span></span><br><span class="line">            <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">            <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; <span class="comment">// 根据条件使用</span></span><br><span class="line">            <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">            <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="CAS的原理"><a href="#CAS的原理" class="headerlink" title="CAS的原理"></a>CAS的原理</h3><p>CAS全称是Compare and Swap，即比较并交换，是通过原子指令来实现多线程的同步功能，将获取存储在内存地址的原值和指定的内存地址进行比较，只有当他们相等时，交换指定的预期值和内存中的值，这个操作是原子操作，若不相等，则重新获取存储在内存地址的原值。</p>
<p>CAS操作都是使用的Unsafe类的方法里设置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapObject</span><span class="params">(Object var1, <span class="keyword">long</span> var2, Object var4, Object var5)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4, <span class="keyword">int</span> var5)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapLong</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">long</span> var4, <span class="keyword">long</span> var6)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="事务的隔离级别，以及分别解决了什么"><a href="#事务的隔离级别，以及分别解决了什么" class="headerlink" title="事务的隔离级别，以及分别解决了什么"></a>事务的隔离级别，以及分别解决了什么</h3><table>
<thead>
<tr>
<th align="center">事务隔离级别</th>
<th align="center">脏读</th>
<th align="center">不可重复读</th>
<th align="center">幻读</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Read-uncommitted</td>
<td align="center">是</td>
<td align="center">是</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">Read-committed</td>
<td align="center">否</td>
<td align="center">是</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">Repeatable-read</td>
<td align="center">否</td>
<td align="center">否</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">Serializable</td>
<td align="center">否</td>
<td align="center">否</td>
<td align="center">否</td>
</tr>
</tbody></table>
<h3 id="Mysql除了可重复读的隔离级别还有哪些？"><a href="#Mysql除了可重复读的隔离级别还有哪些？" class="headerlink" title="Mysql除了可重复读的隔离级别还有哪些？"></a>Mysql除了可重复读的隔离级别还有哪些？</h3><p>还有读未提交、读已提交、串行化这些隔离级别</p>
<h3 id="Mysql-日志类型"><a href="#Mysql-日志类型" class="headerlink" title="Mysql 日志类型"></a>Mysql 日志类型</h3><p>重做日志（redo log）：确保事务的持久性。redo日志记录事务执行后的状态，用来恢复未写入data file的已成功事务更新的数据。防止在发生故障的时间点，尚有脏页未写入磁盘，在重启<a href="https://www.2cto.com/database/MySQL/">mysql</a>服务的时候，根据redo log进行重做，从而达到事务的持久性这一特性。</p>
<p>回滚日志（undo log）：保证数据的原子性，保存了事务发生之前的数据的一个版本，可以用于回滚，同时可以提供多版本并发控制下的读（MVCC），也即非锁定读。</p>
<p>二进制日志（binlog）：用于复制，在主从复制中，从库利用主库上的binlog进行重播，实现主从同步。用于数据库的基于时间点的还原。</p>
<p>错误日志（errorlog）：错误日志记录着mysqld启动和停止,以及服务器在运行过程中发生的错误的相关信息。在默认情况下，系统记录错误日志的功能是关闭的，错误信息被输出到标准错误输出。</p>
<p>慢查询日志（slow query log）：慢日志记录执行时间过长和没有使用索引的查询语句，报错select、update、delete以及insert语句，慢日志只会记录执行成功的语句。</p>
<p>一般查询日志（general log）：记录了服务器接收到的每一个查询或是命令，无论这些查询或是命令是否正确甚至是否包含语法错误，general log 都会将其记录下来 ，记录的格式为 {Time ，Id ，Command，Argument }。也正因为mysql服务器需要不断地记录日志，开启General log会产生不小的系统开销。 因此，Mysql默认是把General log关闭的。</p>
<p>中继日志（relay log）：中继日志是连接mastert和slave的信息，它是复制的核心，I/O线程将来自master的事件存储到中继日志中，中继日志充当缓冲，这样master不必等待slave执行完成就可以发送下一个事件。</p>
<h3 id="Mysql索引为什么使用B-tree"><a href="#Mysql索引为什么使用B-tree" class="headerlink" title="Mysql索引为什么使用B+tree"></a>Mysql索引为什么使用B+tree</h3><ul>
<li>B树能解决的问题，B+树都能解决，且能够更好的解决，降低了树的高度，增加节点的数据存储量。</li>
<li>B+树的扫库和扫表能力更强，如果根据索引去根据数据表扫描，对B树扫描，需要整颗树遍历，B+树只需要遍历所有的叶子节点</li>
<li>B+树的磁盘读写能力更强，根结点和支节点不保存数据区，所有的根结点和支节点同样大小的情况下，保存的关键字更多，叶子结点不存子节点的引用，所以，B+树读写一次磁盘加载的关键字更多</li>
<li>B+树具有天然的排序功能</li>
<li>B+树的查询效率更加稳定，每次查询数据，查询IO次数是稳定的</li>
</ul>
<h3 id="Mysql的最左匹配原则是什么"><a href="#Mysql的最左匹配原则是什么" class="headerlink" title="Mysql的最左匹配原则是什么"></a>Mysql的最左匹配原则是什么</h3><ul>
<li><p>最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配，比如a = 1 and b = 2 and c &gt; 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</p>
</li>
<li><p>=和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式。</p>
</li>
</ul>
<h3 id="Mysql的锁有哪些"><a href="#Mysql的锁有哪些" class="headerlink" title="Mysql的锁有哪些"></a>Mysql的锁有哪些</h3><h4 id="参考官方文档"><a href="#参考官方文档" class="headerlink" title="参考官方文档"></a><a href="https://docs.oracle.com/cd/E17952_01/mysql-5.5-en/innodb-locking.html#innodb-shared-exclusive-locks">参考官方文档</a></h4><p><a href="https://learnku.com/articles/39212?order_by=vote_count&">参考其他文档分享</a></p>
<h4 id="共享锁和排他锁"><a href="#共享锁和排他锁" class="headerlink" title="共享锁和排他锁"></a>共享锁和排他锁</h4><p>在InnoDB中是实现标准的行级锁定，其中有两种类型的锁定：共享（S）锁定和排他（X）锁定。</p>
<ul>
<li>读锁（read lock），也叫共享锁（shared lock）允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁</li>
</ul>
<ul>
<li>写锁（write lock），也叫排他锁（exclusive lock）允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享锁和排他锁</li>
</ul>
<h4 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h4><p>InnoDB支持多种粒度锁定，允许行锁和表锁并存。 例如，诸如LOCK TABLES … WRITE之类的语句对指定表采用排他锁（X锁）。 为了使在多个粒度级别上的锁定变得切实可行，InnoDB使用了意图锁定。 意向锁是表级锁，指示事务稍后对表中的行需要哪种类型的锁（共享锁或排他锁）。 有两种类型的意图锁：</p>
<ul>
<li>意向共享锁（IS）一个事务给一个数据行加共享锁时，必须先获得表的IS锁</li>
</ul>
<ul>
<li>意向排它锁（IX）一个事务给一个数据行加排他锁时，必须先获得该表的IX锁</li>
</ul>
<h4 id="记录锁"><a href="#记录锁" class="headerlink" title="记录锁"></a>记录锁</h4><p>记录锁定是对索引记录的锁定。 例如<strong>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE</strong>； 防止任何其他事务插入，更新或删除t.c1值为10的行。</p>
<h4 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h4><p>间隙锁定是对索引记录之间的间隙的锁定，或者是对第一个或最后一个索引记录之前的间隙的锁定。 例如**SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;**。 防止其他事务将值15插入到t.c1列中，无论该列中是否已有这样的值，因为该范围中所有现有值之间的间隙是锁定的。</p>
<h4 id="Next-Key-锁"><a href="#Next-Key-锁" class="headerlink" title="Next-Key 锁"></a>Next-Key 锁</h4><p>下一键锁定是索引记录上的记录锁定和索引记录之前的间隙上的间隙锁定的组合。</p>
<h4 id="插入意图锁"><a href="#插入意图锁" class="headerlink" title="插入意图锁"></a>插入意图锁</h4><p>插入意图锁是在行插入之前通过INSERT操作设置的间隙锁的一种。 此锁以这种方式发出信号，表明要插入的意图是：如果多个事务未插入间隙中的相同位置，则不必等待彼此插入的多个事务。 假设有索引记录，其值分别为4和7。单独的事务分别尝试插入值5和6，在获得插入行的排他锁之前，每个事务都使用插入意图锁来锁定4和7之间的间隙， 但不要互相阻塞，因为行是无冲突的。</p>
<h4 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h4><p>AUTO-INC锁是一种特殊的表级锁，由插入到具有AUTO_INCREMENT列的表中的事务获取。 在最简单的情况下，如果一个事务正在向表中插入值，那么任何其他事务都必须等待自己在该表中进行插入，以便第一个事务插入的行接收连续的主键值。</p>
<h3 id="Mysql-InnoDB和MyISAM的区别"><a href="#Mysql-InnoDB和MyISAM的区别" class="headerlink" title="Mysql InnoDB和MyISAM的区别"></a>Mysql InnoDB和MyISAM的区别</h3><ol>
<li>InnoDB 支持事务，MyISAM 不支持事务。这是 MySQL 将默认存储引擎从 MyISAM 变成 InnoDB 的重要原因之一；</li>
<li>InnoDB 支持外键，而 MyISAM 不支持。对一个包含外键的 InnoDB 表转为 MYISAM 会失败；  </li>
<li>InnoDB 是聚集索引，MyISAM 是非聚集索引。聚簇索引的文件存放在主键索引的叶子节点上，因此 InnoDB 必须要有主键，通过主键索引效率很高。但是辅助索引需要两次查询，先查询到主键，然后再通过主键查询到数据。因此，主键不应该过大，因为主键太大，其他索引也都会很大。而 MyISAM 是非聚集索引，数据文件是分离的，索引保存的是数据文件的指针。主键索引和辅助索引是独立的。 </li>
<li>InnoDB 不保存表的具体行数，执行 select count(*) from table 时需要全表扫描。而MyISAM 用一个变量保存了整个表的行数，执行上述语句时只需要读出该变量即可，速度很快；    </li>
<li>InnoDB 最小的锁粒度是行锁，MyISAM 最小的锁粒度是表锁。一个更新语句会锁住整张表，导致其他查询和更新都会被阻塞，因此并发访问受限。这也是 MySQL 将默认存储引擎从 MyISAM 变成 InnoDB 的重要原因之一；</li>
</ol>
<h3 id="Redis如何实现持久化的"><a href="#Redis如何实现持久化的" class="headerlink" title="Redis如何实现持久化的"></a>Redis如何实现持久化的</h3><p><em>Redis 提供了不同级别的持久化方式：</em></p>
<ul>
<li>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储.</li>
<li>AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾.Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大.</li>
<li>如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.</li>
<li>你也可以同时开启两种持久化方式, 在这种情况下, 当redis重启的时候会优先载入AOF文件来恢复原始的数据,因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.</li>
<li>最重要的事情是了解RDB和AOF持久化方式的不同,让我们以RDB持久化方式开始</li>
</ul>
<p><em>RDB 优点：</em></p>
<ul>
<li>RDB是一个非常紧凑的文件,它保存了某个时间点得数据集,非常适用于数据集的备份,比如你可以在每个小时报保存一下过去24小时内的数据,同时每天保存过去30天的数据,这样即使出了问题你也可以根据需求恢复到不同版本的数据集.</li>
<li>RDB是一个紧凑的单一文件,很方便传送到另一个远端数据中心或者亚马逊的S3（可能加密），非常适用于灾难恢复.</li>
<li>RDB在保存RDB文件时父进程唯一需要做的就是fork出一个子进程,接下来的工作全部由子进程来做，父进程不需要再做其他IO操作，所以RDB持久化方式可以最大化redis的性能.</li>
<li>与AOF相比,在恢复大的数据集的时候，RDB方式会更快一些</li>
</ul>
<p><em>RDB 缺点：</em></p>
<ul>
<li>如果你希望在redis意外停止工作（例如电源中断）的情况下丢失的数据最少的话，那么RDB不适合你.虽然你可以配置不同的save时间点(例如每隔5分钟并且对数据集有100个写的操作),是Redis要完整的保存整个数据集是一个比较繁重的工作,你通常会每隔5分钟或者更久做一次完整的保存,万一在Redis意外宕机,你可能会丢失几分钟的数据.</li>
<li>RDB 需要经常fork子进程来保存数据集到硬盘上,当数据集比较大的时候,fork的过程是非常耗时的,可能会导致Redis在一些毫秒级内不能响应客户端的请求.如果数据集巨大并且CPU性能不是很好的情况下,这种情况会持续1秒,AOF也需要fork,但是你可以调节重写日志文件的频率来提高数据集的耐久度.</li>
</ul>
<p><em>AOF 优点</em></p>
<ul>
<li>使用AOF会让你的Redis更加耐久: 你可以使用不同的fsync策略：无fsync,每秒fsync,每次写的时候fsync.使用默认的每秒fsync策略,Redis的性能依然很好(fsync是由后台线程进行处理的,主线程会尽力处理客户端请求),一旦出现故障，你最多丢失1秒的数据.</li>
<li>AOF文件是一个只进行追加的日志文件,所以不需要写入seek,即使由于某些原因(磁盘空间已满，写的过程中宕机等等)未执行完整的写入命令,你也也可使用redis-check-aof工具修复这些问题.</li>
<li>Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF 进行重写： 重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合。 整个重写操作是绝对安全的，因为 Redis 在创建新 AOF 文件的过程中，会继续将命令追加到现有的 AOF 文件里面，即使重写过程中发生停机，现有的 AOF 文件也不会丢失。 而一旦新 AOF 文件创建完毕，Redis 就会从旧 AOF 文件切换到新 AOF 文件，并开始对新 AOF 文件进行追加操作。</li>
<li>AOF 文件有序地保存了对数据库执行的所有写入操作， 这些写入操作以 Redis 协议的格式保存， 因此 AOF 文件的内容非常容易被人读懂， 对文件进行分析（parse）也很轻松。 导出（export） AOF 文件也非常简单： 举个例子， 如果你不小心执行了 FLUSHALL 命令， 但只要 AOF 文件未被重写， 那么只要停止服务器， 移除 AOF 文件末尾的 FLUSHALL 命令， 并重启 Redis ， 就可以将数据集恢复到 FLUSHALL 执行之前的状态。</li>
</ul>
<p><em>AOF 缺点：</em></p>
<ul>
<li>对于相同的数据集来说，AOF 文件的体积通常要大于 RDB 文件的体积。</li>
<li>根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB 。 在一般情况下， 每秒 fsync 的性能依然非常高， 而关闭 fsync 可以让 AOF 的速度和 RDB 一样快， 即使在高负荷之下也是如此。 不过在处理巨大的写入载入时，RDB 可以提供更有保证的最大延迟时间（latency）。</li>
</ul>
<h3 id="项目中如何做链路跟踪的"><a href="#项目中如何做链路跟踪的" class="headerlink" title="项目中如何做链路跟踪的"></a>项目中如何做链路跟踪的</h3><p>Zipkin 做服务链路跟踪</p>
]]></content>
      <categories>
        <category>面试总结</category>
      </categories>
      <tags>
        <tag>面试总结</tag>
      </tags>
  </entry>
  <entry>
    <title>面试总结（某上市公司）</title>
    <url>/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93%EF%BC%88%E6%9F%90%E4%B8%8A%E5%B8%82%E5%85%AC%E5%8F%B8%EF%BC%89/</url>
    <content><![CDATA[<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gimoby2nc7j30ku0b4gls.jpg"></p>
<a id="more"></a>

<h2 id="面试总结（某上市公司）"><a href="#面试总结（某上市公司）" class="headerlink" title="面试总结（某上市公司）"></a>面试总结（某上市公司）</h2><h3 id="Java-IO-NIO-AIO-的区别以及线程模型"><a href="#Java-IO-NIO-AIO-的区别以及线程模型" class="headerlink" title="Java IO/NIO/AIO 的区别以及线程模型"></a>Java IO/NIO/AIO 的区别以及线程模型</h3><ul>
<li><p>Java BIO ： 同步并阻塞IO，服务器实现模式为一个连接一个线程，即客户端有连接请求时服务器端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销，当然可以通过线程池机制改善。</p>
</li>
<li><p>Java NIO ： 同步非阻塞IO，服务器实现模式为一个请求一个线程，即客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到连接有I/O请求时才启动一个线程进行处理。</p>
</li>
<li><p>Java AIO(NIO.2) ： 异步非阻塞IO，服务器实现模式为一个有效请求一个线程，客户端的I/O请求都是由OS先完成了再通知服务器应用去启动线程进行处理。</p>
<ul>
<li>AsynchronousServerSocketChannel ，对应于bio中的ServerSocket和nio中的ServerSocketChannel，用于server端的网络程序。</li>
</ul>
</li>
<li><p>AsynchronousSocketChannel，对云关于bio中的Socket和nio中的SocketChannel，用于client端的网络程序。</p>
<ul>
<li>CompletionHandler，回调接口，在socket进行accept/connect/read/write等操作时，可以传入一个CompletionHandler的实现，操作执行完毕后，会调用注册的CompletionHandler。</li>
<li>除了CompletionHandler这种回调方式，aio中还支持返回Future对象，使用Future来设定回调操作</li>
</ul>
</li>
</ul>
<h3 id="Full-GC-和-Young-GC-区别"><a href="#Full-GC-和-Young-GC-区别" class="headerlink" title="Full GC 和 Young GC 区别"></a>Full GC 和 Young GC 区别</h3><p>Minor GC又称为Young GC，只回收新生代的收集器，MinorGC很频繁，和用户线程同步执行，不会停顿用户线程</p>
<p>Full GC又称为Major GC，<strong>就是收集整个堆，包括新生代，老年代，永久代(在JDK 1.8及以后，永久代会被移除，换为metaspace)等收集区域</strong></p>
<h3 id="YoungGC-是否会Stop-the-World，YGC停顿时间是否可配置"><a href="#YoungGC-是否会Stop-the-World，YGC停顿时间是否可配置" class="headerlink" title="YoungGC 是否会Stop the World，YGC停顿时间是否可配置"></a>YoungGC 是否会Stop the World，YGC停顿时间是否可配置</h3><p>是的，也会Stop The World，YGC可以配置停顿时间，只有Parallel Scavenge收集器可以配置吞吐量和停顿时间，g1收集器也可以设置停顿时间</p>
<h3 id="Spring-启动流程"><a href="#Spring-启动流程" class="headerlink" title="Spring 启动流程"></a>Spring 启动流程</h3><p>Spring 上下文的启动流程，也就是启动 AbstractApplicationContext refresh()的流程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="comment">// 准备此上下文以进行刷新。</span></span><br><span class="line">            prepareRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 告诉子类刷新内部bean工厂</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备在这种情况下使用的bean工厂</span></span><br><span class="line">            prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 允许在上下文子类中对bean工厂进行后处理。</span></span><br><span class="line">                postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用在上下文中注册为bean的工厂处理器。</span></span><br><span class="line">                invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 注册拦截Bean创建的Bean处理器。</span></span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 为此上下文初始化消息源。</span></span><br><span class="line">                initMessageSource();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 为此上下文初始化事件多播器。</span></span><br><span class="line">                initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 在特定上下文子类中初始化其他特殊bean。</span></span><br><span class="line">                onRefresh();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查侦听器bean并注册它们。</span></span><br><span class="line">                registerListeners();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 实例化所有剩余的（非延迟初始化）单例bean。</span></span><br><span class="line">                finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 最后一步：发布相应的事件。</span></span><br><span class="line">                finishRefresh();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 销毁已创建的单例以避免资源悬空。</span></span><br><span class="line">                destroyBeans();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重置“活动”标志。</span></span><br><span class="line">                cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将异常传播给监听者。</span></span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 在Spring的核心中重置常见的自省缓存，因为我们可能再也不需要单例bean的元数据了。</span></span><br><span class="line">                resetCommonCaches();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-Bean-的生命周期"><a href="#Spring-Bean-的生命周期" class="headerlink" title="Spring Bean 的生命周期"></a>Spring Bean 的生命周期</h3><p>Spring 只帮我们管理单例模式 Bean 的<strong>完整</strong>生命周期，对于 prototype 的 bean ，Spring 在创建好交给使用者之后则不会再管理后续的生命周期。</p>
<p>对于普通的Java对象，当new的时候创建对象，当它没有任何引用的时候被垃圾回收机制回收。而由Spring IoC容器托管的对象，它们的生命周期完全由容器控制。Spring中每个Bean的生命周期如下：</p>
<p><img src="https://tvax3.sinaimg.cn/large/008aQ1h9ly1gi3409bvdwj31200fu45c.jpg" alt="WX20200825-155349@2x"></p>
<ol>
<li><p>实例化Bean</p>
<p>对于BeanFactory容器，当客户向容器请求一个尚未初始化的bean时，或初始化bean的时候需要注入另一个尚未初始化的依赖时，容器就会调用createBean进行实例化。<br>对于ApplicationContext容器，当容器启动结束后，便实例化所有的bean。<br>容器通过获取BeanDefinition对象中的信息进行实例化。并且这一步仅仅是简单的实例化，并未进行依赖注入。<br>实例化对象被包装在BeanWrapper对象中，BeanWrapper提供了设置对象属性的接口，从而避免了使用反射机制设置属性。</p>
</li>
<li><p>设置对象属性（依赖注入）</p>
<p>实例化后的对象被封装在BeanWrapper对象中，并且此时对象仍然是一个原生的状态，并没有进行依赖注入。<br>紧接着，Spring根据BeanDefinition中的信息进行依赖注入。<br>并且通过BeanWrapper提供的设置属性的接口完成依赖注入。</p>
</li>
<li><p>注入Aware接口</p>
<p>紧接着，Spring会检测该对象是否实现了xxxAware接口，并将相关的xxxAware实例注入给bean。</p>
</li>
<li><p>BeanPostProcessor</p>
<p>当经过上述几个步骤后，bean对象已经被正确构造，但如果你想要对象被使用前再进行一些自定义的处理，就可以通过BeanPostProcessor接口实现。<br>该接口提供了两个函数：</p>
<ul>
<li>postProcessBeforeInitialzation( Object bean, String beanName )<br>当前正在初始化的bean对象会被传递进来，我们就可以对这个bean作任何处理。<br>这个函数会先于InitialzationBean执行，因此称为前置处理。<br>所有Aware接口的注入就是在这一步完成的。</li>
<li>postProcessAfterInitialzation( Object bean, String beanName )<br>当前正在初始化的bean对象会被传递进来，我们就可以对这个bean作任何处理。<br>这个函数会在InitialzationBean完成后执行，因此称为后置处理。</li>
</ul>
</li>
<li><p>InitializingBean与init-method</p>
<p>当BeanPostProcessor的前置处理完成后就会进入本阶段。<br>InitializingBean接口只有一个函数：</p>
<ul>
<li>afterPropertiesSet()</li>
</ul>
<p>这一阶段也可以在bean正式构造完成前增加我们自定义的逻辑，但它与前置处理不同，由于该函数并不会把当前bean对象传进来，因此在这一步没办法处理对象本身，只能增加一些额外的逻辑。<br>若要使用它，我们需要让bean实现该接口，并把要增加的逻辑写在该函数中。然后Spring会在前置处理完成后检测当前bean是否实现了该接口，并执行afterPropertiesSet函数。</p>
<p>当然，Spring为了降低对客户代码的侵入性，给bean的配置提供了init-method属性，该属性指定了在这一阶段需要执行的函数名。Spring便会在初始化阶段执行我们设置的函数。init-method本质上仍然使用了InitializingBean接口。</p>
</li>
<li><p>DisposableBean和destroy-method</p>
<p>和init-method一样，通过给destroy-method指定函数，就可以在bean销毁前执行指定的逻辑</p>
</li>
</ol>
<h3 id="SpringMvc-和-SpringBoot-比较"><a href="#SpringMvc-和-SpringBoot-比较" class="headerlink" title="SpringMvc 和 SpringBoot 比较"></a>SpringMvc 和 SpringBoot 比较</h3><p>SpringMvc是Spring的Mvc Web框架</p>
<p>Spring Boot实现了自动配置，降低了项目搭建的复杂度。 众所周知Spring框架需要进行大量的配置，Spring Boot引入自动配置的概念，让项目设置变得很容易。Spring Boot本身并不提供Spring框架的核心特性以及扩展功能，只是用于快速、敏捷地开发新一代基于Spring框架的应用程序。也就是说，它并不是用来替代Spring的解决方案，而是和Spring框架紧密结合用于提升Spring开发者体验的工具。</p>
<h3 id="SpringBoot-优点"><a href="#SpringBoot-优点" class="headerlink" title="SpringBoot 优点"></a>SpringBoot 优点</h3><ul>
<li><p>使用Java或Groovy开发基于Spring的应用程序非常容易。</p>
</li>
<li><p>它减少了大量的开发时间并提高了生产力。</p>
</li>
<li><p>它避免了编写大量的样板代码，注释和XML配置。</p>
</li>
<li><p><strong>Spring Boot</strong>应用程序与其Spring生态系统(如Spring JDBC，Spring ORM，Spring Data，Spring Security等)集成非常容易。</p>
</li>
<li><p>它遵循“自用默认配置”方法，以减少开发工作量。</p>
</li>
<li><p>它提供嵌入式Web容器，如Tomcat，Jetty等，以开发和测试Web应用程序非常容易。</p>
</li>
<li><p>它提供CLI(命令行界面)工具从命令提示符，非常容易和快速地开发和测试Spring Boot(Java或Groovy)应用程序。</p>
</li>
<li><p>它提供了许多插件来开发和测试Spring启动应用程序非常容易使用构建工具，如Maven和Gradle。</p>
</li>
<li><p>它提供了许多插件，以便与嵌入式和内存数据库工作非常容易</p>
</li>
</ul>
<h3 id="SpringCloud-组件用过哪些"><a href="#SpringCloud-组件用过哪些" class="headerlink" title="SpringCloud 组件用过哪些"></a>SpringCloud 组件用过哪些</h3><p>Spring Cloud Eureka</p>
<p>Spring Cloud config</p>
<p>Spring Cloud zuul</p>
<p>Spring Cloud Bus</p>
<p>Spring Cloud Hystrix</p>
<p>……</p>
<h3 id="SpringCloud-和-Dubbo-区别"><a href="#SpringCloud-和-Dubbo-区别" class="headerlink" title="SpringCloud 和 Dubbo 区别"></a>SpringCloud 和 Dubbo 区别</h3><p>SpringCould是基于SpringBoot的基础上的一个微服务架构。包括包服务发现（Eureka），断路器（Hystrix），服务网关（Zuul），客户端负载均衡（Ribbon）、服务跟踪(Sleuth)、消息总线(Bus)、消息驱动(Stream)、批量任务(Task)等。</p>
<p>最大的区别:Spring Cloud抛弃了Dubbo 的RPC通信，采用的是基于HTTP的REST方式。<br>严格来说，这两种方式各有优劣。虽然在一定程度上来说，后者牺牲了服务调用的性能，但也避免了上面提到的原生RPC带来的问题。而且REST相比RPC更为灵活，服务提供方和调用方的依赖只依靠一纸契约，不存在代码级别的强依赖，这在强调快速演化的微服务环境下，显得更为合适。</p>
<h3 id="Mybatis-一级缓存、二级缓存介绍一下"><a href="#Mybatis-一级缓存、二级缓存介绍一下" class="headerlink" title="Mybatis 一级缓存、二级缓存介绍一下"></a>Mybatis 一级缓存、二级缓存介绍一下</h3><p>一级缓存：</p>
<ol>
<li>MyBatis一级缓存的生命周期和SqlSession一致。</li>
<li>MyBatis一级缓存内部设计简单，只是一个没有容量限定的HashMap，在缓存的功能性上有所欠缺。</li>
<li>MyBatis的一级缓存最大范围是SqlSession内部，有多个SqlSession或者分布式的环境下，数据库写操作会引起脏数据，建议设定缓存级别为Statement。</li>
</ol>
<p>二级缓存：</p>
<ol>
<li>MyBatis的二级缓存相对于一级缓存来说，实现了<code>SqlSession</code>之间缓存数据的共享，同时粒度更加的细，能够到<code>namespace</code>级别，通过Cache接口实现类不同的组合，对Cache的可控性也更强。</li>
<li>MyBatis在多表查询时，极大可能会出现脏数据，有设计上的缺陷，安全使用二级缓存的条件比较苛刻。</li>
<li>在分布式环境下，由于默认的MyBatis Cache实现都是基于本地的，分布式环境下必然会出现读取到脏数据，需要使用集中式缓存将MyBatis的Cache接口实现，有一定的开发成本，直接使用Redis、Memcached等分布式缓存可能成本更低，安全性也更高。</li>
</ol>
<h3 id="gRPC-和-Dubbo-区别"><a href="#gRPC-和-Dubbo-区别" class="headerlink" title="gRPC 和 Dubbo 区别"></a>gRPC 和 Dubbo 区别</h3><p>Dubbo基于Java的rpc框架，是基于Netty实现的</p>
<p>gRPC是跨平台的，支持多种语言，可以在不同的平台上进行相互调用</p>
<h3 id="gRPC-优缺点"><a href="#gRPC-优缺点" class="headerlink" title="gRPC 优缺点"></a>gRPC 优缺点</h3><p>优点</p>
<ul>
<li>protobuf二进制消息，性能好/效率高（空间和时间效率都很不错）</li>
<li>proto文件生成目标代码，简单易用</li>
<li>序列化反序列化直接对应程序中的数据类，不需要解析后在进行映射(XML,JSON都是这种方式)</li>
<li>支持向前兼容（新加字段采用默认值）和向后兼容（忽略新加字段），简化升级</li>
<li>支持多种语言（可以把proto文件看做IDL文件）</li>
<li>Netty等一些框架集成</li>
</ul>
<p>缺点：</p>
<ul>
<li>GRPC尚未提供连接池，需要自行实现</li>
<li>尚未提供“服务发现”、“负载均衡”机制</li>
<li>因为基于HTTP2，绝大部多数HTTP Server、Nginx都尚不支持，即Nginx不能将GRPC请求作为HTTP请求来负载均衡，而是作为普通的TCP请求。（nginx1.9版本已支持）</li>
<li>Protobuf二进制可读性差（貌似提供了Text_Fromat功能）<br>默认不具备动态特性（可以通过动态定义生成消息类型或者动态编译支持</li>
</ul>
<h3 id="Tcp-粘包怎么处理"><a href="#Tcp-粘包怎么处理" class="headerlink" title="Tcp 粘包怎么处理"></a>Tcp 粘包怎么处理</h3><p>tcp是流数据，不存在数据包，问题很宽泛。</p>
<h3 id="MQTT-和-Http-区别"><a href="#MQTT-和-Http-区别" class="headerlink" title="MQTT 和 Http 区别"></a>MQTT 和 Http 区别</h3><p>http是超文本协议，是应用层协议</p>
<p>mqtt是基于tcp协议的发布和订阅协议</p>
<h3 id="MQTT-的原理"><a href="#MQTT-的原理" class="headerlink" title="MQTT 的原理"></a>MQTT 的原理</h3><p>实现MQTT协议需要：客户端和服务器端</p>
<p>MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。</p>
<p>MQTT传输的消息分为：主题（Topic）和负载（Payload）两部分</p>
<p>Topic：可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（Payload）</p>
<p>Payload：可以理解为消息的内容，是指订阅者具体要使用的内容</p>
<h3 id="MQTT消息类型"><a href="#MQTT消息类型" class="headerlink" title="MQTT消息类型"></a>MQTT消息类型</h3><ul>
<li><code>CONNECT</code>：客户端连接到MQTT代理</li>
<li><code>CONNACK</code>：连接确认</li>
<li><code>PUBLISH</code>：新发布消息</li>
<li><code>PUBACK</code>：新发布消息确认，是QoS 1给PUBLISH消息的回复</li>
<li><code>PUBREC</code>：QoS 2消息流的第一部分，表示消息发布已记录</li>
<li><code>PUBREL</code>：QoS 2消息流的第二部分，表示消息发布已释放</li>
<li><code>PUBCOMP</code>：QoS 2消息流的第三部分，表示消息发布完成</li>
<li><code>SUBSCRIBE</code>：客户端订阅某个主题</li>
<li><code>SUBACK</code>：对于SUBSCRIBE消息的确认</li>
<li><code>UNSUBSCRIBE</code>：客户端终止订阅的消息</li>
<li><code>UNSUBACK</code>：对于UNSUBSCRIBE消息的确认</li>
<li><code>PINGREQ</code>：心跳</li>
<li><code>PINGRESP</code>：确认心跳</li>
<li><code>DISCONNECT</code>：客户端终止连接前优雅地通知MQTT代理</li>
</ul>
<h3 id="MQTT-QoS消息等级"><a href="#MQTT-QoS消息等级" class="headerlink" title="MQTT QoS消息等级"></a>MQTT QoS消息等级</h3><p>QoS服务质量指的是交通优先级和资源预留控制机制，而不是接收的服务质量。 服务质量是为不同应用程序，用户或数据流提供的不同优先级的能力，或者也可以说是为数据流保证一定的性能水平的能力。</p>
<p>以下是每一个<a href="https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8B%99%E5%93%81%E8%B3%AA">服务质量</a>级别的具体描述</p>
<ol>
<li>最多一次传送 (只负责传送，发送过后就不管数据的传送情况)</li>
<li>至少一次传送 (确认数据交付)</li>
<li>正好一次传送 (保证数据交付成功)</li>
</ol>
<h3 id="MQTT-如何保持长连接的"><a href="#MQTT-如何保持长连接的" class="headerlink" title="MQTT 如何保持长连接的"></a>MQTT 如何保持长连接的</h3><p>和TCP一样也是通过心跳机制来保持长连接的</p>
<ul>
<li>TCP长连接保持：KeepAlive。TCP协议的实现里有一个KeepAlive机制，自动检测能否和对方连通并保持连接。</li>
<li>TCP识别不同的请求：每个连接建立时，都会保存一个唯一的套接字，有了这个套接字，你就知道对方的IP地址、端口号等信息。这样，通过这个套接字，就可以向指定方发送信息了</li>
</ul>
<h3 id="TCP-三次握手和四次握手"><a href="#TCP-三次握手和四次握手" class="headerlink" title="TCP 三次握手和四次握手"></a>TCP 三次握手和四次握手</h3><p>三次握手示意图：</p>
<p><img src="https://tva2.sinaimg.cn/mw690/008aQ1h9ly1gi1ugc15b7j30si0nan42.jpg" alt="WX20200824-133727@2x"></p>
<ul>
<li>客户端–发送带有 SYN 标志的数据包–一次握手–服务端</li>
<li>服务端–发送带有 SYN/ACK 标志的数据包–二次握手–客户端</li>
<li>客户端–发送带有带有 ACK 标志的数据包–三次握手–服务端</li>
</ul>
<p>四次握手示意图：</p>
<p><img src="https://tvax2.sinaimg.cn/mw690/008aQ1h9ly1gi1uilj9woj30wy0i2gqu.jpg" alt="WX20200824-133946@2x"></p>
<p>断开一个 TCP 连接则需要“四次握手”：</p>
<ul>
<li>客户端-发送一个 FIN，用来关闭客户端到服务器的数据传送</li>
<li>服务器-收到这个 FIN，它发回一个 ACK，确认序号为收到的序号加1 。和 SYN 一样，一个 FIN 将占用一个序号</li>
<li>服务器-关闭与客户端的连接，发送一个FIN给客户端</li>
<li>客户端-发回 ACK 报文确认，并将确认序号设置为收到序号加1</li>
</ul>
<h3 id="Redis-主从复制、哨兵介绍一下"><a href="#Redis-主从复制、哨兵介绍一下" class="headerlink" title="Redis 主从复制、哨兵介绍一下"></a>Redis 主从复制、哨兵介绍一下</h3><p>Redis主从复制：</p>
<p>从服务器在连接一个主服务器的时候，主服务器会创建一个快照文件并将其发送至从服务器，但这只是主从复制执行过程的其中一步。</p>
<p>从服务器连接主服务器时的步骤：</p>
<table>
<thead>
<tr>
<th align="center">步骤</th>
<th>主服务器操作</th>
<th>从服务器操作</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td>等待命令进入</td>
<td>连接（或者重连接）主服务器，发送SYNC命令</td>
</tr>
<tr>
<td align="center">2</td>
<td>开始执行BGSAVE，并使用缓冲区记录BGSAVE之后执行的所有写命令</td>
<td>根据配置选项来决定是继续使用现有的数据（如果有的话）来处理客户端的命令请求，还是向发送请求的客户端返回错误</td>
</tr>
<tr>
<td align="center">3</td>
<td>BGSAVE执行完毕，向从服务器发送快照文件，并在发送期间继续使用缓冲区记录被执行的写命令</td>
<td>丢弃所有旧数据（如果有的话），开始载入主服务器发来的快照文件</td>
</tr>
<tr>
<td align="center">4</td>
<td>快照文件发送完毕，开始向从服务器发送存储在缓冲区里面的写命令</td>
<td>完成对快照文件的解释操作，想往常一样开始接受命令请求</td>
</tr>
<tr>
<td align="center">5</td>
<td>缓冲区存储的写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相同的写命令</td>
<td>执行主服务器发来的所有存储在缓冲区里面的写命令；并从现在开始，接收并执行主服务器传来的每个写命令</td>
</tr>
</tbody></table>
<p>哨兵就是个监控服务，监控主节点的监控状态，提供：监控、通知、重新选举主服务和自动故障转移</p>
<h3 id="Redis-和内存缓存的区别"><a href="#Redis-和内存缓存的区别" class="headerlink" title="Redis 和内存缓存的区别"></a>Redis 和内存缓存的区别</h3><ol>
<li>读写速度，不考虑并发问题，本地缓存自然是最快的</li>
<li>场景使用，同一数据，从数据库取出来，放到redis只要一次，而放到本地缓存，则需要n个集群次</li>
<li>本地缓存无法用于重复点击，重复点击会分发请求到多台服务器，而用本地缓存只能防止本机重复点击，redis则可以防止，但是时间间隔也需要在redis的读写差之外。</li>
<li>redis内存可能n多扩充，而本地扩大堆内存代价是很大的。</li>
<li>本地缓存需要自己实现过期功能，实现不好可能导致极其严重的后果，而redis经过大量的流量验证，许多漏洞无需考试，安全。</li>
<li>本地缓存无法提供丰富的数据结构，redis可以。</li>
<li>redis可以写磁盘，持久化，本地缓存不可以或者说很麻烦要考虑的东西太多。</li>
<li>使用本地缓存极有可能导致严重的线程安全问题，并发考虑严重。</li>
</ol>
<h3 id="消息队列类型"><a href="#消息队列类型" class="headerlink" title="消息队列类型"></a>消息队列类型</h3><ul>
<li>ActiveMQ</li>
<li>RabbitMQ</li>
<li>RocketMQ</li>
<li>Kafka</li>
</ul>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line">Kafka` 在于 **分布式架构**，`RabbitMQ` 基于 `AMQP` **协议** 来实现，`RocketMQ` 的思路来源于 `Kafka`，改成了 **主从结构**，在 **事务性** 和 **可靠性** 方面做了优化。广泛来说，**电商**、**金融** 等对 **事务一致性** 要求很高的，可以考虑 `RabbitMQ` 和 `RocketMQ`，对 **性能要求高** 的可考虑 `Kafka</span><br></pre></td></tr></table></figure>

<h3 id="分布式锁如何实现"><a href="#分布式锁如何实现" class="headerlink" title="分布式锁如何实现"></a>分布式锁如何实现</h3><ul>
<li><p>基于set nx expire 来实现分布式锁。</p>
</li>
<li><p>基于Redis的Redisson实现，下图是Redisson的原理：</p>
</li>
</ul>
<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gi33fnj9soj314k0hgwy0.jpg" alt="WX20200825-153328@2x"></p>
<ol>
<li>加锁机制：线程去获取锁，获取成功就执行lua脚本，保存数据到redis数据库；线程去获取锁，获取失败就一直通过while循环尝试获取锁，获取成功后，执行lua脚本，保存数据到redis数据库。</li>
<li>watch dog自动延期机制：在一个分布式环境下，假如一个线程获得锁后，突然服务器宕机了，那么这个时候在一定时间后这个锁会自动释放，你也可以设置锁的有效时间(不设置默认30秒），这样的目的主要是防止死锁的发生；但持有锁的线程的业务还没处理完，想继续处理，就需要看门狗来进行锁续期了，它可以不断延长锁的持有时间</li>
<li>通过lua脚本执行，保证原子操作</li>
<li>可重入加锁机制</li>
</ol>
<h3 id="Aws-lambda-介绍一下"><a href="#Aws-lambda-介绍一下" class="headerlink" title="Aws lambda 介绍一下"></a>Aws lambda 介绍一下</h3><p>AWS Lambda 是一项计算服务，使用时无需预配置或管理服务器即可运行代码。AWS Lambda 只在需要时执行代码并自动缩放。借助 AWS Lambda，几乎可以为任何类型的应用程序或后端服务运行代码，而且无需执行任何管理。现在 AWS Lambda 支持 Node.js、Java、C# 和 Python</p>
]]></content>
      <categories>
        <category>面试总结</category>
      </categories>
      <tags>
        <tag>面试总结</tag>
      </tags>
  </entry>
  <entry>
    <title>面试总结（某电商）</title>
    <url>/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93%EF%BC%88%E6%9F%90%E7%94%B5%E5%95%86%EF%BC%89/</url>
    <content><![CDATA[<p><img src="https://tvax4.sinaimg.cn/large/008aQ1h9ly1gimoby2nc7j30ku0b4gls.jpg"></p>
<a id="more"></a>

<h2 id="面试总结（某电商）"><a href="#面试总结（某电商）" class="headerlink" title="面试总结（某电商）"></a>面试总结（某电商）</h2><h3 id="Mybatis-懒加载"><a href="#Mybatis-懒加载" class="headerlink" title="Mybatis 懒加载"></a>Mybatis 懒加载</h3><h4 id="什么是懒加载"><a href="#什么是懒加载" class="headerlink" title="什么是懒加载"></a>什么是懒加载</h4><p>延迟加载又叫懒加载，也叫按需加载，也就是说先加载主信息，需要的时候，再去加载从信息。代码中有查询语句，当执行到查询语句时，并不是马上去DB中查询，而是根据设置的延迟策略将查询向后推迟。</p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>减轻DB服务器的压力，因为我们延迟加载只有在用到需要的数据才会执行查询操作。</p>
<h4 id="如何配置"><a href="#如何配置" class="headerlink" title="如何配置"></a>如何配置</h4><ul>
<li>Mybatis-config.xml里配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span> =<span class="string">&quot;aggressiveLazyLoading&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--开启延迟加载--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;lazyLoadingEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Mapper里配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.xxx.mapper.AccountMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义封装 Account和User 的resultMap --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;userAccountMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Account&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;uid&quot;</span> <span class="attr">column</span>=<span class="string">&quot;uid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;money&quot;</span> <span class="attr">column</span>=<span class="string">&quot;money&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置封装 User 的内容</span></span><br><span class="line"><span class="comment">            select：查询用户的唯一标识</span></span><br><span class="line"><span class="comment">            column：用户根据id查询的时候，需要的参数值</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;user&quot;</span> <span class="attr">column</span>=<span class="string">&quot;uid&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;User&quot;</span>     <span class="attr">select</span>=<span class="string">&quot;com.xxx.mapper.UserMapper.findById&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据查询所有账户 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findAll&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;userAccountMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT * FROM account</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.xxx.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义User的resultMap--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;userAccountMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span> <span class="attr">column</span>=<span class="string">&quot;username&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;telephone&quot;</span> <span class="attr">column</span>=<span class="string">&quot;telephone&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;birthday&quot;</span> <span class="attr">column</span>=<span class="string">&quot;birthday&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">column</span>=<span class="string">&quot;gender&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;address&quot;</span> <span class="attr">column</span>=<span class="string">&quot;address&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;accounts&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;account&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;aid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;uid&quot;</span> <span class="attr">column</span>=<span class="string">&quot;uid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;money&quot;</span> <span class="attr">column</span>=<span class="string">&quot;money&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根据id查询用户 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;INT&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        select * from user where id = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>就可以实现按需加载，达到我们的目的。</p>
<h3 id="分布式锁如何实现"><a href="#分布式锁如何实现" class="headerlink" title="分布式锁如何实现"></a>分布式锁如何实现</h3><h4 id="基于数据库"><a href="#基于数据库" class="headerlink" title="基于数据库"></a>基于数据库</h4><p>在数据库中创建一个表，表中包含方法名等字段，并在方法名字段上创建唯一索引，想要执行某个方法，就使用这个方法名向表中插入数据，成功插入则获取锁，执行完成后删除对应的行数据释放锁。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP TABLE IF EXISTS &#96;method_lock&#96;;</span><br><span class="line">CREATE TABLE &#96;method_lock&#96; (</span><br><span class="line">  &#96;id&#96; int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,</span><br><span class="line">  &#96;method_name&#96; varchar(64) NOT NULL COMMENT &#39;锁定的方法名&#39;,</span><br><span class="line">  &#96;desc&#96; varchar(255) NOT NULL COMMENT &#39;备注信息&#39;,</span><br><span class="line">  &#96;update_time&#96; timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uidx_method_name&#96; (&#96;method_name&#96;) USING BTREE</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;3 DEFAULT CHARSET&#x3D;utf8 COMMENT&#x3D;&#39;锁定中的方法&#39;;</span><br></pre></td></tr></table></figure>

<p>执行某个方法后，插入一条记录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO method_lock (method_name, desc) VALUES (&#39;methodName&#39;, &#39;测试的methodName&#39;);</span><br></pre></td></tr></table></figure>

<p>因为我们对method_name做了唯一性约束，这里如果有多个请求同时提交到数据库的话，数据库会保证只有一个操作可以成功，那么我们就可以认为操作成功的那个线程获得了该方法的锁，可以执行方法体内容。</p>
<p>成功插入则获取锁，执行完成后删除对应的行数据释放锁：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">delete from method_lock where method_name &#x3D;&#39;methodName&#39;;</span><br></pre></td></tr></table></figure>

<p>优点：易于理解实现</p>
<p>缺点：</p>
<p>（1）因为是基于数据库实现的，数据库的可用性和性能将直接影响分布式锁的可用性及性能，所以，数据库需要双机部署、数据同步、主备切换。 </p>
<p>（2）不具备可重入的特性，因为同一个线程在释放锁之前，行数据一直存在，无法再次成功插入数据，所以，需要在表中新增一列，用于记录当前获取到锁的机器和线程信息，在再次获取锁的时候，先查询表中机器和线程信息是否和当前机器和线程信息相同，若相同则直接获取锁； </p>
<p>（3）没有锁失效机制，因为有可能出现成功插入数据后，服务器宕机了，对应的数据没有被删除，当服务恢复后一直获取不到锁，所以，需要在锁中新增一列，用于记录失效时间，并且需要有定时任务清除这些失效的数据； </p>
<p>（4）不具备阻塞锁特性，获取不到锁直接返回失败，所以需要优化获取逻辑，循环多次去获取。</p>
<h4 id="基于Redis"><a href="#基于Redis" class="headerlink" title="基于Redis"></a>基于Redis</h4><p>选择Redis分布式锁的原因：</p>
<ul>
<li><p>redis有很高的性能； </p>
</li>
<li><p>redis对此支持的命令较好，实现起来比较方便</p>
</li>
</ul>
<p>使用的命令：</p>
<ul>
<li>SETNX：<code>SETNX key val</code> 当且仅当key不存在时，set一个key为val的字符串，返回1；若key存在，则什么都不做，返回0</li>
<li>expire：<code>expire key timeout</code> 设置超时时间，单位为s，超过这个时间就会自动释放锁，避免死锁</li>
<li>delete：<code>delete key</code> 释放锁</li>
</ul>
<p>实现思想：</p>
<ol>
<li>获取锁的时候，使用setnx加锁，并使用expire命令给锁加一个超时时间，超过该时间则自动释放锁，锁的value值为一个随机生成的UUID，通过此在释放锁的时候进行判断。 </li>
<li>获取锁的时候还设置一个获取的超时时间，若超过这个时间则放弃获取锁。 </li>
<li>释放锁的时候，通过UUID判断是不是该锁，若是该锁，则执行进行锁释放。</li>
</ol>
<p>优点：</p>
<ol>
<li>吞吐量高</li>
<li>有锁失效自动删除机制，保证不会阻塞所有流程</li>
</ol>
<p>缺点:</p>
<ol>
<li>单点故障问题</li>
<li>锁超时问题：如果A拿到锁之后设置了超时时长，但是业务还未执行完成且锁已经被释放，此时其他进程就会拿到锁从而执行相同的业务。如何解决？Redission定时延长超时时长避免过期。为什么不直接设置为永不超时？为了防范业务方没写解锁方法或者发生异常之后无法进行解锁的问题</li>
<li>轮询获取锁状态方式太过低效</li>
</ol>
<h4 id="基于Zookeeper"><a href="#基于Zookeeper" class="headerlink" title="基于Zookeeper"></a>基于Zookeeper</h4><p>ZooKeeper是一个为分布式应用提供一致性服务的开源组件，它内部是一个分层的文件系统目录树结构，规定同一个目录下只能有一个唯一文件名。</p>
<p>基于ZooKeeper实现分布式锁的步骤如下：</p>
<ol>
<li>创建一个目录mylock； </li>
<li>线程A想获取锁就在mylock目录下创建临时顺序节点；</li>
<li>获取mylock目录下所有的子节点，然后获取比自己小的兄弟节点，如果不存在，则说明当前线程顺序号最小，获得锁； </li>
<li>线程B获取所有节点，判断自己不是最小节点，设置监听比自己小的节点； </li>
<li>线程A处理完，删除自己的节点，线程B监听到变更事件，判断自己是不是最小节点，如果是则获得锁。</li>
</ol>
<p>这里推荐一个Apache的开源库Curator，它是一个ZooKeeper客户端，Curator提供的InterProcessMutex是分布式锁的实现，acquire方法用于获取锁，release用于释放锁。</p>
<p>优点：具备高可用、可重入、阻塞锁特性，可解决失效死锁问题。</p>
<p>缺点：因为需要频繁的创建和删除节点，性能上不如redis方式，强依赖zk</p>
<h3 id="DynamoDB-优势"><a href="#DynamoDB-优势" class="headerlink" title="DynamoDB 优势"></a>DynamoDB 优势</h3><ul>
<li><p>规模性能</p>
<p>DynamoDB 通过在任意规模环境中提供一致的个位数毫秒响应时间，支持世界上一些最大规模的应用程序。您可以构建吞吐量和存储空间几乎无限的应用程序。DynamoDB 全局表可跨多个 AWS 区域复制您的数据，使您能够快速在本地访问全局分布的应用程序的数据。对于需要以微秒级延迟执行更快访问的使用案例，DynamoDB Accelerator (DAX) 提供了完全托管的内存缓存</p>
</li>
<li><p>无须管理服务器</p>
<p>DynamoDB 是无服务器服务，无需预配置、修补或管理服务器，也不需要安装、维护或操作软件。DynamoDB 可自动纵向扩展和缩减表，以针对容量做出调整并保持性能。由于内置了可用性和容错能力，您无需为这些功能构建应用程序。DynamoDB 提供预配置和按需容量模式，使您能够通过指定每个工作负载的容量或只为您使用的资源付费，从而优化成本。</p>
</li>
<li><p>企业级</p>
<p>DynamoDB 支持 ACID 事务，使您能够大规模构建业务关键型应用程序。DynamoDB 默认加密所有数据，并为您的所有表提供细粒度的身份和访问控制。您可以立即创建数百 TB 数据的完整备份，而不会对您的表性能产生影响，并且可以恢复到先前的 35 天内的任何时间点，而无需停机。DynamoDB 还提供有服务级别协议，从而确保可用性。</p>
</li>
</ul>
<h3 id="Spring-解决循环依赖"><a href="#Spring-解决循环依赖" class="headerlink" title="Spring  解决循环依赖"></a>Spring  解决循环依赖</h3><p>循环依赖就是N个类中循环嵌套引用，如果在日常开发中我们用new 对象的方式发生这种循环依赖的话程序会在运行时一直循环调用，直至内存溢出报错。下面说一下Spring是如果解决的。</p>
<p>Spring对循环依赖的处理有三种情况： </p>
<ol>
<li>构造器的循环依赖：这种依赖spring是处理不了的，直接抛出<code>BeanCurrentlylnCreationException</code>异常。 </li>
<li>单例模式下的setter循环依赖，通过“三级缓存”来处理循环依赖。 </li>
<li>非单例Bean的循环依赖，无法处理。</li>
</ol>
<p>DefaultSingletonBeanRegistry的实现方式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name –&gt; bean instance */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map singletonObjects = <span class="keyword">new</span> ConcurrentHashMap(<span class="number">256</span>);</span><br><span class="line"><span class="comment">/** Cache of singleton factories: bean name –&gt; ObjectFactory */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&gt; singletonFactories = <span class="keyword">new</span> HashMap&gt;(<span class="number">16</span>);</span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name –&gt; bean instance */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map earlySingletonObjects = <span class="keyword">new</span> HashMap(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="comment">//isSingletonCurrentlyInCreation()判断当前单例bean是否正在创建中</span></span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="comment">//allowEarlyReference 是否允许从singletonFactories中通过getObject拿到对象</span></span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="comment">//从singletonFactories中移除，并放入earlySingletonObjects中。</span></span><br><span class="line">                    <span class="comment">//其实也就是从三级缓存移动到了二级缓存</span></span><br><span class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口在AbstractBeanFactory里实现，并在核心方法doCreateBean（）引用下面的方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(singletonFactory, <span class="string">&quot;Singleton factory must not be null&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">            <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">            <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Mysql-索引的数据结构"><a href="#Mysql-索引的数据结构" class="headerlink" title="Mysql 索引的数据结构"></a>Mysql 索引的数据结构</h3><h4 id="索引是什么"><a href="#索引是什么" class="headerlink" title="索引是什么"></a>索引是什么</h4><p>索引是帮助数据库高效获取数据的数据结构</p>
<h4 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h4><h5 id="从存储结构上来划分"><a href="#从存储结构上来划分" class="headerlink" title="从存储结构上来划分"></a>从存储结构上来划分</h5><ul>
<li>Btree 索引（B+tree，B-tree)</li>
<li>哈希索引</li>
<li>full-index 全文索引</li>
<li>RTree</li>
</ul>
<h5 id="从应用层次上来划分"><a href="#从应用层次上来划分" class="headerlink" title="从应用层次上来划分"></a>从应用层次上来划分</h5><ul>
<li>普通索引：即一个索引只包含单个列，一个表可以有多个单列索引。</li>
<li>唯一索引：索引列的值必须唯一，但允许有空值。</li>
<li>复合索引：一个索引包含多个列。</li>
</ul>
<h5 id="从表记录的排列顺序和索引的排列顺序是否一致来划分"><a href="#从表记录的排列顺序和索引的排列顺序是否一致来划分" class="headerlink" title="从表记录的排列顺序和索引的排列顺序是否一致来划分"></a>从表记录的排列顺序和索引的排列顺序是否一致来划分</h5><ul>
<li>聚集索引：表记录的排列顺序和索引的排列顺序一致。</li>
<li>非聚集索引：表记录的排列顺序和索引的排列顺序不一致。</li>
</ul>
<h5 id="聚集索引和非聚集索引"><a href="#聚集索引和非聚集索引" class="headerlink" title="聚集索引和非聚集索引"></a>聚集索引和非聚集索引</h5><ul>
<li>聚集索引：就是以主键创建的索引。</li>
<li>非聚集索引：就是以非主键创建的索引（也叫做二级索引）</li>
</ul>
<h4 id="Mysql-索引的数据结构-1"><a href="#Mysql-索引的数据结构-1" class="headerlink" title="Mysql 索引的数据结构"></a>Mysql 索引的数据结构</h4><h5 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h5><p>可能直接想到的就是用哈希表来实现快速查找，就像我们平时用的 hashmap 一样，value = get(key)， O(1) 时间复杂度一步到位，确实，<strong>哈希索引</strong> 是一种方式。</p>
<p>定义</p>
<p>哈希索引就是采用一定的哈希算法，只需一次哈希算法即可立刻定位到相应的位置，速度非常快。<strong>本质上就是把键值换算成新的哈希值，根据这个哈希值来定位</strong></p>
<p>局限性</p>
<ul>
<li>哈希索引没办法利用索引完成排序。</li>
<li>不能进行多字段查询。</li>
<li>在有大量重复键值的情况下，哈希索引的效率也是极低的（出现哈希碰撞问题）。</li>
<li>不支持范围查询。</li>
</ul>
<p>在 MySQL 常用的 InnoDB 引擎中，还是使用 B+ 树索引比较多。InnoDB 是自适应哈希索引的（hash 索引的创建由 <strong>InnoDB 存储引擎自动优化创建</strong>）。</p>
<h5 id="B-树"><a href="#B-树" class="headerlink" title="B 树"></a>B 树</h5><p>目前索引常用的数据结构是 B+ 树，先介绍一下什么是 B 树（也就是 B- 树）。</p>
<p>B 树的特点：</p>
<ul>
<li>关键字分布在整棵树的所有节点。</li>
<li>任何一个关键字 <strong>出现且只出现在一个节点中</strong>。</li>
<li>搜索有可能在 <strong>非叶子节点</strong> 结束。</li>
<li>其搜索性能等价于在关键字全集内做一次二分查找</li>
</ul>
<h5 id="B-树-1"><a href="#B-树-1" class="headerlink" title="B+ 树"></a>B+ 树</h5><p>了解了 B 树，再来看一下 B+ 树，也是 MySQL 索引大部分情况所使用的数据结构</p>
<p>B+ 树基本特点</p>
<ul>
<li>非叶子节点的子树指针与关键字个数相同。</li>
<li>非叶子节点的子树指针 P[i]，指向关键字属于 <strong>[k[i],K[i+1])</strong> 的子树（<strong>注意：区间是前闭后开</strong>)。</li>
<li><strong>为所有叶子节点增加一个链指针</strong>。</li>
<li><strong>所有关键字都在叶子节点出现</strong></li>
</ul>
<p>B+ 树的特性</p>
<ul>
<li>所有的关键字 <strong>都出现在叶子节点的链表中</strong>，且链表中的关键字是有序的。</li>
<li><strong>搜索只在叶子节点命中</strong>。</li>
<li>非叶子节点相当于是 <strong>叶子节点的索引层</strong>，叶子节点是 <strong>存储关键字数据的数据层</strong>。</li>
</ul>
<p>相对 B 树，B+ 树做索引的优势</p>
<ul>
<li>B+ 树的磁盘读写代价更低。<strong>B+ 树的内部没有指向关键字具体信息的指针</strong>，所以其内部节点相对 B 树更小，如果把所有关键字存放在同一块盘中，那么盘中所能容纳的关键字数量也越多，一次性读入内存的需要查找的关键字也就越多，<strong>相应的，IO 读写次数就降低了</strong>。</li>
<li><strong>树的查询效率更加稳定</strong>。B+ 树所有数据都存在于叶子节点，所有关键字查询的路径长度相同，每次数据的查询效率相当。而 B 树可能在非叶子节点就停止查找了，所以查询效率不够稳定。</li>
<li><strong>B+ 树只需要去遍历叶子节点就可以实现整棵树的遍历</strong></li>
</ul>
<h4 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h4><ol>
<li><h4 id="违反最左匹配原则"><a href="#违反最左匹配原则" class="headerlink" title="违反最左匹配原则"></a>违反最左匹配原则</h4><p><strong>最左匹配原则</strong>：最左优先，以最左边的为起点任何连续的索引都能匹配上，如不连续，则匹配不上。</p>
<p>如：建立索引为 (a,b) 的联合索引，那么只查 where b = 2 则不生效。换句话说：如果建立的索引是 (a,b,c)，也只有 (a),(a,b),(a,b,c) 三种查询可以生效</p>
</li>
<li><h4 id="在索引列上做任何操作"><a href="#在索引列上做任何操作" class="headerlink" title="在索引列上做任何操作"></a>在索引列上做任何操作</h4><p>如计算、函数、（手动或自动）类型转换等操作，会导致索引失效而进行全表扫描。</p>
</li>
<li><h4 id="使用不等于（-、-lt-gt-）"><a href="#使用不等于（-、-lt-gt-）" class="headerlink" title="使用不等于（!= 、&lt;&gt;）"></a>使用不等于（!= 、&lt;&gt;）</h4></li>
<li><h4 id="like-中以通配符开头-’-abc’"><a href="#like-中以通配符开头-’-abc’" class="headerlink" title="like 中以通配符开头 (’%abc’)"></a>like 中以通配符开头 (’%abc’)</h4><p>索引失效</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select * from user where name like &#39;%zhangsan&#39;;</span><br></pre></td></tr></table></figure>

<p>索引生效</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select * from user where name like &#39;zhangsan%;</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="字符串不加单引号索引失效"><a href="#字符串不加单引号索引失效" class="headerlink" title="字符串不加单引号索引失效"></a>字符串不加单引号索引失效</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select * from user where name &#x3D; 2000;</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="or-连接索引失效"><a href="#or-连接索引失效" class="headerlink" title="or 连接索引失效"></a>or 连接索引失效</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select * from user where name &#x3D; &#39;2000&#39; or age &#x3D; 20 or pos &#x3D;&#39;cxy&#39;;</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h4><p>正常（索引参与了排序），没有违反最左匹配原则</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select * from user where name &#x3D; &#39;zhangsan&#39; and age &#x3D; 20 order by age,pos;</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="group-by"><a href="#group-by" class="headerlink" title="group by"></a>group by</h4><p>正常（索引参与了排序）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select name,age from user where name &#x3D; &#39;zhangsan&#39; group by age;</span><br></pre></td></tr></table></figure>

<p>违反最左前缀法则，导致产生临时表（会降低性能）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explain select name,age from user where name &#x3D; &#39;zhangsan&#39; group by pos,age;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="SpringBoot-运行原理"><a href="#SpringBoot-运行原理" class="headerlink" title="SpringBoot 运行原理"></a>SpringBoot 运行原理</h3><p>Spring 启动流程</p>
<ol>
<li>监听开始启动</li>
<li>创建上下文， <code>createApplicationContext</code>默认创建Servlet上下文，可以指定<code>webApplicationType</code>类型</li>
<li>准备上下文，准备上下文的外部化配置等</li>
<li>启动上下文，其实就是运行Spring的Application的refresh启动上下文，并扫描和注册Spring组件</li>
<li>监听已启动</li>
<li>监听开始运行</li>
</ol>
<p>Spring 自动装配</p>
<p>spring.factories里配置了默认的自动装配类，会根据条件进行选择装配</p>
<h3 id="Dubbo-服务挂了，如何实现重试？"><a href="#Dubbo-服务挂了，如何实现重试？" class="headerlink" title="Dubbo 服务挂了，如何实现重试？"></a>Dubbo 服务挂了，如何实现重试？</h3><p>如果注册中心挂了，消费者会从本地缓存里读取服务提供者的地址，进行通讯，直到注册中心恢复，然后重新去注册中心获取服务列表，</p>
<p>保证服务的高可用。</p>
<h3 id="K8s的作用，如何编排"><a href="#K8s的作用，如何编排" class="headerlink" title="K8s的作用，如何编排"></a>K8s的作用，如何编排</h3><p>容器编排平台， 我们将单体式的架构拆分成越来越多细小的服务，运行在各自的容器中，那么该如何解决它们之间的依赖管理，服务发现，资源管理，高可用等问题</p>
<p><strong>在容器环境中，编排通常涉及到三个方面:</strong></p>
<ul>
<li>资源编排 - 负责资源的分配，如限制 namespace 的可用资源，scheduler 针对资源的不同调度策略；</li>
<li>工作负载编排 - 负责在资源之间共享工作负载，如 Kubernetes 通过不同的 controller 将 Pod 调度到合适的 node 上，并且负责管理它们的生命周期；</li>
<li>服务编排 - 负责服务发现和高可用等，如 Kubernetes 中可用通过 Service 来对内暴露服务，通过 Ingress 来对外暴露服务。</li>
</ul>
<h3 id="G1和CMS的区别"><a href="#G1和CMS的区别" class="headerlink" title="G1和CMS的区别"></a>G1和CMS的区别</h3><p>按分代收集来说，CMS是老年代收集器，G1则是混合收集，它开创了混合收集的模式，衡量标准不在是属于哪个分代，而是哪块内存值得收集，哪块内存中存放的垃圾数量最多，回收收益最大来进行收集。</p>
<p>按收集算法来说，CMS收集器是基于标记-清除的垃圾收集器，由于CMS是一款基于“标记-清除”算法实现的收集器，就会造成大量空间碎片产生，如果空间碎片过多时，当需要足够大大连续空间来分配大对象大时候，会不得不提前触发Full GC的情况；而G1从整体来看是基于“标记-整理”算法实现的收集器，从局部上看（两个Region之间）又是基于“标记-复制”算法实现，无论如何，这两种算法在运行期间都不会产生内存空间碎片，垃圾收集完成之后能提供规整的可用内存</p>
<h3 id="Mysql数据库的默认隔离级别"><a href="#Mysql数据库的默认隔离级别" class="headerlink" title="Mysql数据库的默认隔离级别"></a>Mysql数据库的默认隔离级别</h3><p>默认隔离级别是：REPEATABLE_READ</p>
<h3 id="gRPC框架的原理，序列化在哪一层"><a href="#gRPC框架的原理，序列化在哪一层" class="headerlink" title="gRPC框架的原理，序列化在哪一层"></a>gRPC框架的原理，序列化在哪一层</h3><p>gRPC 默认使用 Protocol Buffers 作为 RPC 序列化框架，通过 Protocol Buffers 对消息进行序列化和反序列化，然后通过 Netty 的 HTTP/2，以 Stream 的方式进行数据传输。</p>
<p>由于存在一些特殊的处理，gRPC 并没有直接使用 Netty 提供的 Protocol Buffers Handler, 而是自己集成 Protocol Buffers 工具类进行序列化和反序列化，下面一起分析它的设计和实现原理。</p>
<h3 id="gRPC-如何实现服务发现以及使用的什么负载均衡策略"><a href="#gRPC-如何实现服务发现以及使用的什么负载均衡策略" class="headerlink" title="gRPC 如何实现服务发现以及使用的什么负载均衡策略"></a>gRPC 如何实现服务发现以及使用的什么负载均衡策略</h3><p>服务发现与负载均衡<br>当server端是集群部署时，client调用server就需要用到服务发现与负载均衡。通常有两总方式：</p>
<p>一种方式是在client与server之间加代理，由代理来做负载均衡<br>一种方式是将服务注册到一个数据中心，client通过数据中心查询到所有服务的节点信息，然后自己选择负载均衡的策略</p>
]]></content>
      <categories>
        <category>面试总结</category>
      </categories>
      <tags>
        <tag>面试总结</tag>
      </tags>
  </entry>
  <entry>
    <title>Java GC 笔记</title>
    <url>/Java%20GC%20%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<img src="https://tvax1.sinaimg.cn/large/008aQ1h9ly1gimnz80rlej30sg0sgwg5.jpg" style="zoom:60%;" />

 <a id="more"></a>  

<h3 id="垃圾收集器（Garbage-Collection，GC）"><a href="#垃圾收集器（Garbage-Collection，GC）" class="headerlink" title="垃圾收集器（Garbage Collection，GC）"></a>垃圾收集器（Garbage Collection，GC）</h3><h4 id="内存分配与回收的神秘面纱"><a href="#内存分配与回收的神秘面纱" class="headerlink" title="内存分配与回收的神秘面纱"></a>内存分配与回收的神秘面纱</h4><p>​        Java的自动内存管理主要是针对对象内存的回收和对象内存的分配。同时，Java的自动内存管理最核心的功能是<strong>Java Heap</strong>内存中对象的分配与回收。</p>
<h5 id="堆内存划分"><a href="#堆内存划分" class="headerlink" title="堆内存划分"></a>堆内存划分</h5><p>​        堆内存分为新生代、老年代和永久代。新生代又被进一步分为：Eden 区＋Survivor1 区＋Survivor2 区。值得注意的是，在 JDK8中移除永久代，取而代之的是一个叫元空间（Metaspace）的区域（永久代使用的是JVM的堆内存空间，而元空间使用的是物理内存，直接受到本机的物理内存限制）</p>
<h5 id="栈上分配"><a href="#栈上分配" class="headerlink" title="栈上分配"></a>栈上分配</h5><p>​        对象分配首先会尝试在栈上分配，如果分配失败，会尝试TLAB分配，如果继续失败则会在堆内的Eden区内分配，当Eden区空间无法容纳该对象时，会分配在老年代区域。</p>
<p>栈上分配是Java虚拟机提供的一项优化技术，它的基本思想是，对于那些线程私有对象(指不可能被其他线程访问的对象)可以将它们打散分配在栈上，而不是分配在堆上。</p>
<ul>
<li><p>好处：分配在栈上可以在线程结束后自行销毁，不需要垃圾回收器介入，从而提高系统的性能。</p>
</li>
<li><p>局限性：栈空间小，对于大对象无法实现栈上分配。</p>
</li>
<li><p>基础：栈上分配需要依赖于逃逸分析和标量替换。</p>
</li>
</ul>
<h6 id="栈上分配示例"><a href="#栈上分配示例" class="headerlink" title="栈上分配示例"></a>栈上分配示例</h6><p>设置最大堆内存为10m，为了更好的看出测试结果：</p>
<p>启动参数：<code>-Xmx10m -Xms10m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:-UseTLAB -XX:+EliminateAllocations</code></p>
<p><code>-Xmx10m -Xms10m</code> 设置了最大堆和初始堆内存大小</p>
<p><code>-XX:+DoEscapeAnalysis</code> 开启了逃逸分析</p>
<p><code>-XX:-UseTLAB</code> 关闭了TLAB线程本地分配缓冲区的内存</p>
<p><code>-XX:+EliminateAllocations</code> 开启了标量替换</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JVM对象分配之栈上分配 &amp; TLAB分配</span></span><br><span class="line"><span class="comment"> * VM Args: -Xmx10m -Xms10m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:-UseTLAB -XX:+EliminateAllocations</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.zxb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-09-04 16:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateObjectDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectHolder</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 栈内分配对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createByStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// objectHolder 在方法内部创建，所以不是逃逸对象，所以会在栈上分配对象</span></span><br><span class="line">        ObjectHolder objectHolder = <span class="keyword">new</span> ObjectHolder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ObjectHolder objectHolder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 堆内分配对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createByHeap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// objectHolder 是方法外部定义的对象，所以是逃逸对象，就需要在堆内分配对象</span></span><br><span class="line">        objectHolder = <span class="keyword">new</span> ObjectHolder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">100_000_000</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            createByStack();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;耗时：&quot;</span> + (System.currentTimeMillis() - start) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行1亿次的结果发现，并未出现GC，而且很快执行完，说明该方法内的对象是创建在虚拟机栈中，随着栈帧的退出而对象消亡。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">2047</span><span class="type">K</span>-&gt;<span class="number">488</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0007411</span> <span class="type">secs</span>]</span><br><span class="line">耗时：<span class="number">6</span> ms</span><br></pre></td></tr></table></figure>

<p>当我们测试有逃逸对象体的时候结果如下，可以发现对象会在堆内分配，如果开启了TLAB，则会在TLAB分配：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">100_000_000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        createByHeap();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;耗时：&quot;</span> + (System.currentTimeMillis() - start) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">// 省略......</span><br><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">3142</span><span class="type">K</span>-&gt;<span class="number">1094</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0002338</span> <span class="type">secs</span>]</span><br><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">3142</span><span class="type">K</span>-&gt;<span class="number">1094</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0002363</span> <span class="type">secs</span>]</span><br><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">3142</span><span class="type">K</span>-&gt;<span class="number">1094</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0002392</span> <span class="type">secs</span>]</span><br><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">3142</span><span class="type">K</span>-&gt;<span class="number">1094</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0002356</span> <span class="type">secs</span>]</span><br><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">3142</span><span class="type">K</span>-&gt;<span class="number">1094</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0002461</span> <span class="type">secs</span>]</span><br><span class="line">[<span class="type">GC</span> (<span class="type">Allocation</span> <span class="type">Failure</span>)  <span class="number">3142</span><span class="type">K</span>-&gt;<span class="number">1094</span><span class="type">K</span>(<span class="number">9728</span><span class="type">K</span>), <span class="number">0.0002566</span> <span class="type">secs</span>]</span><br><span class="line">耗时：<span class="number">3058</span> ms</span><br></pre></td></tr></table></figure>

<p>当使用如下参数（任意一行）运行，都会发现触大量GC</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//不使用逃逸分析</span></span><br><span class="line">-server -Xmx15m -Xms15m -XX:－DoEscapeAnalysis -XX:+PrintGC -XX:-UseTLAB -XX:+EliminateAllocations</span><br><span class="line"></span><br><span class="line"><span class="comment">//不使用标量替换</span></span><br><span class="line">-server -Xmx15m -Xms15m -XX:＋DoEscapeAnalysis -XX:+PrintGC -XX:-UseTLAB -XX:－EliminateAllocations</span><br></pre></td></tr></table></figure>

<p>可以得出结论: 栈上分配需要依赖于逃逸分析和标量替换。</p>
<p>从结果上来看，栈内分配对象的效率远远高于堆内分配对象的效率，栈内分配的对象随着栈帧的弹出而消亡，不需要GC的参与，大大提高了分配性能。</p>
<h6 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h6><p>栈上分配的一个技术基础是进行逃逸分析。目的是判断对象的作用域是否有可能逃逸出逃逸体。</p>
<p>虚拟机会进行逃逸分析，判断线程内私有对象是否有可能被其他线程访问，导致逃逸，然后虚拟机就会根据是否可能会逃逸将其分配在栈上，或者堆中。</p>
<p>只有在server模式下，才能开启逃逸分析。参数: -XX:+DoEscapeAnalysis 是开启逃逸分析。 -XX:+EliminateAllocations 是开启标杆替换，允许将对象打散分配到栈上，默认状态是开启的。</p>
<p>逃逸分析大概分为以下类型：</p>
<ul>
<li>全部变量赋值逃逸</li>
<li>方法返回值逃逸</li>
<li>实例引用发生逃逸</li>
<li>线程逃逸：赋值给类变量或可以在其他线程中访问的实例变量</li>
</ul>
<h6 id="标量替换"><a href="#标量替换" class="headerlink" title="标量替换"></a>标量替换</h6><p>​        标量替换，scalar replacement。Java中的原始类型无法再分解，可以看作标量（scalar）；指向对象的引用也是标量；而对象本身则是聚合量（aggregate），可以包含任意个数的标量。如果把一个Java对象拆散，将其成员变量恢复为分散的变量，这就叫做标量替换。拆散后的变量便可以被单独分析与优化，可以各自分别在活动记录（栈帧或寄存器）上分配空间；原本的对象就无需整体分配空间了。</p>
<h6 id="什么是TLAB"><a href="#什么是TLAB" class="headerlink" title="什么是TLAB"></a>什么是TLAB</h6><p>​        TLAB，全称Thread Local Allocation Buffer，即：线程本地分配缓存。这是一块线程专用的内存分配区域。TLAB占用的是Eden区的空间。在TLAB启用的情况下（默认开启），JVM会为每一个线程分配一块TLAB私有区域</p>
<p>局限性：TLAB空间一般不会太大（占用eden区），所以大对象无法进行TLAB分配，只能直接分配到堆上。</p>
<h6 id="为什么需要TLAB"><a href="#为什么需要TLAB" class="headerlink" title="为什么需要TLAB"></a>为什么需要TLAB</h6><p>  这是为了加速对象的分配。由于对象一般分配在堆上，而堆是线程共用的，因此可能会有多个线程在堆上申请空间，而每一次的对象分配都必须线程同步，会使分配的效率下降。考虑到对象分配几乎是Java中最常用的操作，因此JVM使用了TLAB这样的线程专有区域来避免多线程冲突，提高对象分配的效率。</p>
<h5 id="对象在Edge区分配"><a href="#对象在Edge区分配" class="headerlink" title="对象在Edge区分配"></a>对象在Edge区分配</h5><p>​        目前主流的垃圾收集器都会采用分代回收算法，因此需要将堆内存分为新生代和老年代，这样我们就可以根据各个年代的特点选择合适的垃圾收集算法。</p>
<p>大多数情况下，对象在新生代中 eden 区分配。当 eden 区没有足够空间进行分配时，虚拟机将发起一次Minor GC。</p>
<ul>
<li><strong>新生代GC（Minor GC）</strong>: 指发生新生代的的垃圾收集动作，Minor GC非常频繁，回收速度一般也比较快。</li>
<li><strong>老年代GC（Major GC/Full GC）</strong>: 指发生在老年代的GC，出现了Major GC经常会伴随至少一次的Minor GC（并非绝对），Major GC的速度一般会比Minor GC的慢10倍以上。</li>
</ul>
<h5 id="大对象直接进入老年代"><a href="#大对象直接进入老年代" class="headerlink" title="大对象直接进入老年代"></a>大对象直接进入老年代</h5><p>大对象就是需要大量连续内存空间的对象（比如：字符串、数组）。</p>
<p><strong>为什么要这样呢？</strong></p>
<p>为了避免为大对象分配内存时由于分配担保机制带来的复制而降低效率。</p>
<h5 id="长期存活的对象将进入老年代"><a href="#长期存活的对象将进入老年代" class="headerlink" title="长期存活的对象将进入老年代"></a>长期存活的对象将进入老年代</h5><p>既然虚拟机采用了分代收集的思想来管理内存，那么内存回收时就必须能识别哪些对象应放在新生代，哪些对象应放在老年代中。为了做到这一点，虚拟机给每个对象一个对象年龄（Age）计数器。</p>
<p>如果对象在 Eden 出生并经过第一次 Minor GC 后仍然能够存活，并且能被 Survivor 容纳的话，将被移动到 Survivor 空间中，并将对象年龄设为1，对象在 Survivor 中每熬过一次 MinorGC, 年龄就增加1岁，当它的年龄增加到一定程度（默认为15岁），就会被晋升到老年代中。对象晋升到老年代的年龄阈值，可以通过参数 <code>-XX:MaxTenuringThreshold</code> 来设置。</p>
<h5 id="动态对象年龄判定"><a href="#动态对象年龄判定" class="headerlink" title="动态对象年龄判定"></a>动态对象年龄判定</h5><p>为了更好的适应不同程序的内存情况，虚拟机不是永远要求对象年龄必须达到了某个值才能进入老年代，如果 Survivor 空间中相同年龄所有对象大小的总和大于 Survivor 空间的一半，年龄大于或等于该年龄的对象就可以直接进入老年代，无需达到要求的年龄。</p>
<h5 id="空间分配担保"><a href="#空间分配担保" class="headerlink" title="空间分配担保"></a>空间分配担保</h5><p>在发生Minor GC前，虚拟机会先检查老年代最大可用的连续空间是否大于新生代所有对象的总空间，如果条件成立，那么Minor GC可以确保是安全的。</p>
<p>如果不成立，则虚拟机会查看<code>HandlePromotionFailure</code>设置值是否允许担保失败。</p>
<p>如果允许，那么会检查老年代最大可用的连续空间是否大于历次晋升到老年代的平均大小，如果大于，将尝试一次Minor GC，尽管这次Minor GC是有风险的。</p>
<p>如果小于，或者<code>HandlePromotionFailure</code>设置不允许冒险，那么这时就要执行一次Full GC。</p>
<h4 id="如何判断对象活着？"><a href="#如何判断对象活着？" class="headerlink" title="如何判断对象活着？"></a>如何判断对象活着？</h4><h5 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h5><ul>
<li>是在对象中添加一个引用计数器，每当有一个地方引用它时，计数器就加1；当引用失效时，计数器就减1；任何时刻计数器为0的对象就是不能再被使用</li>
<li>主流Java虚拟机并没有选用引用计数算法来管理内存</li>
<li>原因是该算法很难解决对象之间互相循环引用的问题</li>
</ul>
<h5 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h5><h6 id="什么是可达性分析算法"><a href="#什么是可达性分析算法" class="headerlink" title="什么是可达性分析算法"></a>什么是可达性分析算法</h6><p>通过一系列称为“GC Roots”的根对象作为起始节点集，从这些节点开始，根据引用关系向下搜索，搜索过程所走的路径称为“引用链（Reference Chain）”，如果某个对象到GC Roots间没有任何引用链相连或从GC Roots到这个对象不可达时，则证明此对象是不可能再被使用的</p>
<p><img src="http://wx1.sinaimg.cn/large/008aQ1h9ly1ghrccgxbicj30wm0u0413.jpg"></p>
<h6 id="什么是-GC-Roots对象"><a href="#什么是-GC-Roots对象" class="headerlink" title="什么是 GC Roots对象"></a>什么是 GC Roots对象</h6><ul>
<li>虚拟机栈中引用的对象，比如各线程调用方法堆栈中使用的参数、局部变量、临时变量等</li>
<li>方法区中类静态属性引用的对象，比如字符串常量池里的引用和Java类的引用类型静态变量</li>
<li>本地方法栈中JNI引用的对象</li>
<li>Java虚拟机内部的引用，比如：基本数据类型对应的Class对象，以及一些异常对象（NPE、OOM）等，还有系统类加载器</li>
<li>所有被同步锁（synchronized关键字）持有的对象</li>
<li>反映Java虚拟机内部情况的JMXBean、JVMTI中注册的回调、本地代码缓存等</li>
</ul>
<h4 id="再谈引用"><a href="#再谈引用" class="headerlink" title="再谈引用"></a>再谈引用</h4><p>无论通过引用计数算法判断对象的引用数量，还是通过可达性分析算法判断对象是否引用链可达，判定对象是否存活都和“引用“有关</p>
<h5 id="强引用（Strongly-Reference）"><a href="#强引用（Strongly-Reference）" class="headerlink" title="强引用（Strongly Reference）"></a>强引用（Strongly Reference）</h5><ul>
<li>不会被垃圾收集器回收掉的引用</li>
</ul>
<h5 id="软引用（Soft-Reference）"><a href="#软引用（Soft-Reference）" class="headerlink" title="软引用（Soft Reference）"></a>软引用（Soft Reference）</h5><ul>
<li>当JVM将要发生内存溢出前，会回收这部分引用，若内存还是不够，则OOM</li>
</ul>
<h5 id="弱引用（Weak-Reference）"><a href="#弱引用（Weak-Reference）" class="headerlink" title="弱引用（Weak Reference）"></a>弱引用（Weak Reference）</h5><ul>
<li>被弱引用关联的对象只能生存到下一次垃圾收集发生为止</li>
</ul>
<h5 id="虚引用（Phantom-Reference）"><a href="#虚引用（Phantom-Reference）" class="headerlink" title="虚引用（Phantom Reference）"></a>虚引用（Phantom Reference）</h5><ul>
<li>最弱的引用关系，无法造成任何影响，也无法通过虚引用获取一个对象实例</li>
<li>虚引用关联的唯一目的只是为了能在这个对象被垃圾收集器回收时候收到一个通知</li>
</ul>
<h4 id="引用计数式垃圾收集"><a href="#引用计数式垃圾收集" class="headerlink" title="引用计数式垃圾收集"></a>引用计数式垃圾收集</h4><h5 id="直接垃圾收集"><a href="#直接垃圾收集" class="headerlink" title="直接垃圾收集"></a>直接垃圾收集</h5><ul>
<li>主流Java虚拟机中均未涉及此算法</li>
<li>Objective-C采用此方式作为内存管理</li>
</ul>
<h4 id="追踪式垃圾收集（间接垃圾收集）"><a href="#追踪式垃圾收集（间接垃圾收集）" class="headerlink" title="追踪式垃圾收集（间接垃圾收集）"></a>追踪式垃圾收集（间接垃圾收集）</h4><h5 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h5><h6 id="弱分代假说"><a href="#弱分代假说" class="headerlink" title="弱分代假说"></a>弱分代假说</h6><ul>
<li>大多数对象朝生夕死</li>
</ul>
<h6 id="强分代假说"><a href="#强分代假说" class="headerlink" title="强分代假说"></a>强分代假说</h6><ul>
<li><p>熬过多次垃圾收集过程的对象越难以消亡</p>
</li>
<li><p>根据以上假说多款收集器一致的设计原则：</p>
<ul>
<li>收集器应该将Java堆划分出不同的区域，然后将回收对象依据其年龄分配到不同的区域之中存储</li>
<li>根据分代设计理论，一般至少会把Java堆划分为新生代和老年代，在新生代中，每次垃圾收集会有大量的对象死亡，而每次存活的少量对象晋升到老年代存放</li>
</ul>
<p>跨代引用假说</p>
<ul>
<li>跨代引用相对于同代引用来说仅占少数</li>
<li>存在互相引用关系的两个对象，是应该倾向于同时生存或者同时消亡的</li>
<li>依据该假说，就不用为了少量的跨代引用扫描整个老年代，也不必浪费空间专门记录每个对象是否存在或存在哪些跨代引用，只需要在新生代建立一个全局的数据结构（记忆集），这个结构把老年代划分若干个小块，标识出老年代的哪一块内存会存在跨代引用</li>
<li>在Minor GC时，只有包含了跨代引用的小块内存里的对象才会被加入到GC Roots进行扫描，这样就不用扫描整个老年代了</li>
</ul>
</li>
</ul>
<h4 id="垃圾收集分类"><a href="#垃圾收集分类" class="headerlink" title="垃圾收集分类"></a>垃圾收集分类</h4><h6 id="部分收集（Partial-GC）"><a href="#部分收集（Partial-GC）" class="headerlink" title="部分收集（Partial GC）"></a>部分收集（Partial GC）</h6><ul>
<li>目标不是完整收集整个Java堆的垃圾收集</li>
<li>新生代收集（<strong>Minor GC/Young GC</strong>）<ul>
<li>目标只是新生代的垃圾收集</li>
</ul>
</li>
<li>老年代收集（<strong>Major GC/Old GC</strong>）<ul>
<li>目标只是老年代的垃圾收集</li>
<li>目前只有CMS收集器会有单独收集老年代的行为</li>
</ul>
</li>
<li>混合收集（<strong>Mixed GC</strong>）<ul>
<li>目标是收集整个新生代以及部分老年代的垃圾收集</li>
<li>目前只有<strong>G1收集器</strong>有这种行为</li>
</ul>
</li>
</ul>
<h6 id="整堆收集（Full-GC）"><a href="#整堆收集（Full-GC）" class="headerlink" title="整堆收集（Full GC）"></a>整堆收集（Full GC）</h6><ul>
<li>目标收集整个Java堆和方法区的垃圾收集</li>
</ul>
<p>Full GC触发条件</p>
<ul>
<li>System.gc()方法的调用</li>
<li>方法区空间不足</li>
<li>Metaspace区内存达到阈值</li>
<li>统计得到的Minor GC晋升到旧生代的平均大小大于老年代的剩余空间</li>
<li>堆中产生大对象超过阈值</li>
<li>老年代连续空间不足</li>
<li>CMS GC时出现promotion failed和concurrent mode failure</li>
</ul>
<h4 id="垃圾收集器算法"><a href="#垃圾收集器算法" class="headerlink" title="垃圾收集器算法"></a>垃圾收集器算法</h4><h5 id="标记-清除算法（Mark-Sweep）"><a href="#标记-清除算法（Mark-Sweep）" class="headerlink" title="标记-清除算法（Mark-Sweep）"></a>标记-清除算法（Mark-Sweep）</h5><ul>
<li><p>分为“标记”和“清除”两个阶段</p>
<ul>
<li>首先标记所有要回收的对象，在标记完成后，统一回收掉所有被标记的对象</li>
<li>也可以反过来，标记存活的对象，统一回收所有未被标记的对象</li>
<li>标记的过程就是对象是否属于垃圾的判断过程</li>
</ul>
</li>
<li><p>缺点</p>
<ul>
<li><p>执行效率不稳定</p>
<ul>
<li>如果堆中有大量的对象，其中大部分是要被回收堆，这时就需要大量标记和清除的动作，导致标记和清除过程的执行效率都随着对象的数量增长而降低</li>
</ul>
</li>
<li><p>内存空间碎片化问题</p>
<ul>
<li>标记/清除后产生大量不连续的内存碎片，空间碎片太多可能会导致以后程序运行过程需要分配较大的对象时无法找到足够的连续内存而提前触发一次GC动作</li>
</ul>
</li>
</ul>
</li>
<li><p>在HotSpot虚拟机中</p>
<ul>
<li>关注低延迟的CMS收集器是基于标记-清除算法的，当内存空间碎片过多时CMS收集器就会采用标记-整理算法</li>
</ul>
<h5 id="标记-复制算法"><a href="#标记-复制算法" class="headerlink" title="标记-复制算法"></a>标记-复制算法</h5></li>
<li><p>简称复制算法，解决标记-清除算法面临大量对象执行效率低的问题</p>
<ul>
<li>就是将内存按容量划分为大小相等的两块，每次只是使用其中一块</li>
<li>当这一块内存快使用完，就将存活的对象复制到另一块内存上面，然后把使用的这一块内存空间一次清理掉</li>
</ul>
</li>
<li><p>好处</p>
<ul>
<li>不用考虑空间碎片化问题，只需移动堆顶指针，按顺序分配即可，这样实现简单高效</li>
</ul>
</li>
<li><p>缺点</p>
<ul>
<li>如果内存中多数对象都是存活的，就会存在大量内存复制的开销</li>
<li>将内存缩小为原来的一半，浪费了大量的空间</li>
</ul>
</li>
<li><p>根据以上特点提出更优化的半区复制分代策略（Appel式回收）</p>
<ul>
<li><p>Appel式回收的做法</p>
<ul>
<li><p>将新生代分为</p>
<ul>
<li>一块较大的Eden空间</li>
<li>两块较小的Survivor空间</li>
</ul>
</li>
<li><p>每次分配内存只使用Eden空间和其中一块Survivor空间，然后直接清理掉Eden空间和用过的那块Survivor空间</p>
</li>
<li><p>发生垃圾收集时，将Eden和Survivor中仍然存活的对象一次性复制到另外一块Survivor空间上，然后直接清理掉Eden和已用的Survivor空间</p>
</li>
<li><p>HotSpot虚拟机默认Eden和Survivor的大小比例是8:1，也就是新生代可用内存空间为整个新生代容量的90%（Eden80%+Survivor10%）</p>
</li>
<li><p>但无法保证每次回收都有不多于10%对象存活，所以Appel式回收设计，当Survivor空间不足以容纳一次Minor GC之后存活的对象时，就要依赖其他内存区域（实际大多是老年代）进行分配担保（Handle Promotion）</p>
</li>
</ul>
</li>
<li><p>HotSpot的Serial/ParNew等新生代收集器均采用这种策略来设计新生代内存布局</p>
</li>
</ul>
<h5 id="标记-整理算法（Mark-Compact）"><a href="#标记-整理算法（Mark-Compact）" class="headerlink" title="标记-整理算法（Mark-Compact）"></a>标记-整理算法（Mark-Compact）</h5></li>
<li><p>标记过程仍与“标记-清除”算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都像内存空间一端移动，然后直接清理掉边界以外的内存</p>
</li>
<li><p>标记-清除和标记-整理本质区别：前者是非移动式的回收算法，后者是移动式的</p>
</li>
<li><p>缺点</p>
<ul>
<li><p>移动存活对象，在老年代中每次回收都有大量对象存活的区域，移动存活对象并更新所有引用这些对象的地方将会是极为繁重的操作</p>
</li>
<li><p>对象移动操作必须全程暂停用户程序才能进行</p>
</li>
<li><p>若不移动和整理存活对象，将会导致空间碎片化问题</p>
<ul>
<li>就只能依赖复杂的内存分配器和内存访问器来解决</li>
</ul>
</li>
</ul>
</li>
<li><p>在HotSpot虚拟机中</p>
<ul>
<li>关注吞吐量的收集器Parallel Scavenge基于标记-整理算法</li>
</ul>
</li>
</ul>
<h4 id="经典垃圾收集器"><a href="#经典垃圾收集器" class="headerlink" title="经典垃圾收集器"></a>经典垃圾收集器</h4><h5 id="Serial收集器"><a href="#Serial收集器" class="headerlink" title="Serial收集器"></a>Serial收集器</h5><ul>
<li><p>在JDK1.3以前是HotSpot虚拟机新生代收集器的唯一选择</p>
</li>
<li><p>客户端模式下默认新生代收集器</p>
</li>
<li><p>单线程工作的收集器</p>
</li>
<li><p>在收集过程中会停顿用户线程，直到它收集介绍</p>
</li>
<li><p>优势</p>
<ul>
<li>和其他单线程收集器相比，简单而高效</li>
<li>对于内存资源受限的环境，是所有收集器里额外内存消耗最小的</li>
<li>对于单核处理器或处理器核心较少的环境来说，Serial收集器由于没有线程交互的开销，可以获得最高的单线程收集效率</li>
</ul>
<p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghzxp44d6sj31160bcq3n.jpg"></p>
</li>
</ul>
<h5 id="ParNew收集器"><a href="#ParNew收集器" class="headerlink" title="ParNew收集器"></a>ParNew收集器</h5><ul>
<li>是Serial收集器的多线程并行版本</li>
<li>ParNew收集器是激活CMS收集器后的默认新生代收集器</li>
<li>从JDK9 G1收集器的出现，CMS+ParNew收集器的组合就不再是官方推荐的服务器模式下的默认收集器</li>
<li>ParNew收集器默认开启的收集线程数与处理器核心数量相同，也可以使用<code>-XX:ParallelGCThreads</code>参数来限制垃圾收集器的线程数</li>
</ul>
<p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghzxtft4mgj31160bawfa.jpg"></p>
<h5 id="Parallel-Scavenge收集器"><a href="#Parallel-Scavenge收集器" class="headerlink" title="Parallel Scavenge收集器"></a>Parallel Scavenge收集器</h5><ul>
<li><p>也是新生代收集器</p>
</li>
<li><p>基于标记-复制算法实现的收集器</p>
</li>
<li><p>也是并行收集的多线程收集器</p>
</li>
<li><p>特点</p>
<ul>
<li>与其他收集器关注点不同，CMS等收集器的关注点是尽可能地缩短垃圾收集时用户线程的停顿时间</li>
<li>Parallel Scavenge收集器的目标则是达到一个可控制的吞吐量</li>
<li>所谓吞吐量就是处理器用于运行用户代码的时间与处理器总消耗时间的比值</li>
<li>吞吐量 = 运行用户代码时间 /（运行用户代码时间 + 运行垃圾收集器时间）</li>
<li>所以Parallel Scavenge收集器又被称作“吞吐量优先收集器”</li>
</ul>
</li>
<li><p>Parallel Scavenge收集器提供了两个参数用来精确控制吞吐量</p>
<ul>
<li>控制最大垃圾收集停顿时间的<code>-XX:MaxGCPauseMillis</code>参数</li>
<li>直接设置吞吐量大小的<code>-XX:GCTimeRatio</code>参数</li>
</ul>
<p><img src="http://wx4.sinaimg.cn/large/008aQ1h9ly1ghzy9wa8ehj31160ba751.jpg"></p>
</li>
</ul>
<h5 id="Serial-Old收集器"><a href="#Serial-Old收集器" class="headerlink" title="Serial Old收集器"></a>Serial Old收集器</h5><ul>
<li><p>Serial Old收集器是Serial收集器的老年代版本</p>
</li>
<li><p>也是一个单线程收集器</p>
</li>
<li><p>使用标记-整理算法实现的收集器</p>
</li>
<li><p>主要也是提供客户端模式下HotSpot虚拟机使用</p>
</li>
<li><p>若是用于服务端模式下，则可能有两种用途</p>
<ul>
<li>在JDK5及以前的版本中与Parallel Scavenge收集器搭配使用</li>
<li>是作为CMS收集器发生失败时的后备预案，在并发收集发生Concurrent Mode Failure时使用</li>
</ul>
<p><img src="http://wx2.sinaimg.cn/large/008aQ1h9ly1ghzxp44d6sj31160bcq3n.jpg"></p>
</li>
</ul>
<h5 id="Parallel-Old收集器"><a href="#Parallel-Old收集器" class="headerlink" title="Parallel Old收集器"></a>Parallel Old收集器</h5><ul>
<li>Parallel Old收集器是Parallel Scavenge收集器的老年代版本</li>
<li>支持多线程并发收集，基于标记-整理算法实现</li>
<li>从JDK6开始提供，为了解决Parallel Scavenge收集器的尴尬状态，原因在于Parallel Scavenge收集器，老年代除了Serial Old收集器以外别无选择，无法与其他表现良好的老年代收集器配合工作，如CMS收集器</li>
<li>吞吐量优先收集器的组合，在注重吞吐量或者处理器资源较为稀缺的场合，可以考虑Parallel Scavenge加Parallel Old收集器这个组合</li>
</ul>
<p><img src="http://wx4.sinaimg.cn/large/008aQ1h9ly1ghzy9wa8ehj31160ba751.jpg"></p>
<h5 id="CMS（Concurrent-Mark-Sweep）收集器"><a href="#CMS（Concurrent-Mark-Sweep）收集器" class="headerlink" title="CMS（Concurrent Mark Sweep）收集器"></a>CMS（Concurrent Mark Sweep）收集器</h5><h6 id="什么是CMS收集器"><a href="#什么是CMS收集器" class="headerlink" title="什么是CMS收集器"></a>什么是CMS收集器</h6><ul>
<li>以获取最短回收停顿时间为目标的收集器</li>
<li>从名字来看CMS收集器是基于标记-清除算法实现的</li>
<li>在JDK9以后不官方不推荐使用CMS收集器</li>
</ul>
<h6 id="CMS-工作过程"><a href="#CMS-工作过程" class="headerlink" title="CMS 工作过程"></a>CMS 工作过程</h6><ul>
<li><p>初始标记（CMS initial mark）</p>
<ul>
<li>标记一下GC Roots能直接关联到到对象，速度很快，需要停顿用户线程</li>
</ul>
</li>
<li><p>并发标记（CMS concurrent mark）</p>
<ul>
<li>从GC Roots直接关联对象开始遍历整个对象图的过程，该过程耗时长但不需要停顿用户线程</li>
</ul>
</li>
<li><p>重新标记（CMS remark）</p>
<ul>
<li>修正并发标记期间，因用户线程继续运作而导致标记产生变动但那一部分对象的标记记录，该阶段停顿的时间比初始标记要长一些，但也远比并发标记的时间要短</li>
</ul>
</li>
<li><p>并发清除（CMS concurrent sweep）</p>
<ul>
<li>清理删掉标记阶段判断的已经死亡的对象，由于不需要移动存活对象，所以该阶段也是可以和用户线程同时并发</li>
</ul>
<p><img src="http://wx3.sinaimg.cn/large/008aQ1h9ly1ghzyuvrtrdj30tw07tq3n.jpg"></p>
</li>
</ul>
<h6 id="CMS-优点"><a href="#CMS-优点" class="headerlink" title="CMS 优点"></a>CMS 优点</h6><ul>
<li>并发收集</li>
<li>低停顿</li>
</ul>
<h6 id="CMS-缺点"><a href="#CMS-缺点" class="headerlink" title="CMS 缺点"></a>CMS 缺点</h6><ul>
<li><p>对处理器资源非常敏感，在并发阶段，会导致应用程序变慢，降低了总吞吐量</p>
</li>
<li><p>CMS收集器默认启动的回收线程数是（处理器核心数量+3）/4</p>
<ul>
<li>如果处理器核心数在4个以上，并发回收时垃圾收集器只占用不超过25%的处理器运算资源，并且会随着处理器核心数增加而下降</li>
<li>当处理器核心数不足4个时，CMS收集器对用户程序的影响就可能变得很大</li>
</ul>
</li>
<li><p>由于CMS收集器无法处理“浮动垃圾”，有可能出现“Concurrent Mode Failure”失败进而导致一次完全“Stop The World”的Full GC的产生</p>
<ul>
<li>浮动垃圾：在CMS的并发标记和并发清理阶段，用户线程是还在继续运行的，程序在运行自然就还会伴随有新的垃圾对象不断产生，但这一部分垃圾对象是出现在标记过程结束以后，CMS无法在当次收集处理掉它们，只好留到下一次清理，这一部分垃圾就是浮动垃圾</li>
</ul>
</li>
<li><p>由于CMS是一款基于“标记-清除”算法实现的收集器，就会造成大量空间碎片产生，如果空间碎片过多时，当需要足够大大连续空间来分配大对象大时候，会不得不提前触发Full GC的情况</p>
<ul>
<li><p>解决方案</p>
<ul>
<li>CMS收集器提供一个-XX:+UseCMSCompactAtFullCollection开关参数（默认开启，JDK9开始弃用），用于在CMS收集器不得不进行Full GC时开启内存碎片的合并整理过程，由于这个内存整理必须移动存活对象，（在Shenandoah和ZGC出现前）是无法并发的</li>
<li>空间碎片问题虽然解决了，但停顿时间又会变长，因此虚拟机提供了参数-XX:CMSFullGCsBeforeCompaction（JDK9开始弃用），用于要求CMS收集器在执行过若干次（数量由参数值决定）不整理空间的Full GC之后，下一次进入Full GC前会先进行碎片整理（默认值为0，表示每次进入Full GC时都进行碎片整理）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Garbage-First（G1）收集器"><a href="#Garbage-First（G1）收集器" class="headerlink" title="Garbage First（G1）收集器"></a>Garbage First（G1）收集器</h5><h6 id="什么是G1收集器"><a href="#什么是G1收集器" class="headerlink" title="什么是G1收集器"></a>什么是G1收集器</h6><ul>
<li>Garbage First（简称G1）收集器是垃圾收集器技术发展历史上的里程碑式的成果，它开创了收集器面向局部收集的设计思路和基于Region的内存布局形式</li>
<li>从JDK7确立项目目标，G1收集器就被视为JDK7中HotSpot虚拟机的一项重要进化特征，直到JDK8 Update 40之后，这个版本以后的G1收集器才被Oracle官方称为“全功能的垃圾收集器”</li>
<li>面向服务端应用的垃圾收集器，HotSpot期望它代替CMS收集器，在JDK9中G1就代替Parallel Scavenge加Parallel Old组合，成为服务端模式下的默认垃圾收集器，而CMS则标记为不推荐使用的收集器，在未来CMS可能会被废弃</li>
</ul>
<h6 id="G1收集器设计模式"><a href="#G1收集器设计模式" class="headerlink" title="G1收集器设计模式"></a>G1收集器设计模式</h6><ul>
<li><p>G1收集器以前的其他收集器，垃圾收集的目标范围要么是整个新生代（Minor GC），要么是老年代（Major GC），要么是整个Java堆（Full GC）；而G1跳出了这个樊笼，它可以面对堆内存任何部分来组成回收集（Collection Set，简称CSet）进行回收，衡量标准不在是属于哪个分代，而是哪块内存中存放的垃圾数量最多，回收收益最大，这就是G1收集器的混合收集（Mixed GC）模式</p>
</li>
<li><p>G1开创基于Region的堆内存布局是它能够实现这个目标的关键</p>
</li>
<li><p>虽然G1也遵循分代收集理论设计的，但在堆内存的布局与其他收集器有很大差异</p>
<ul>
<li>G1不再坚持固定大小以及固定数量但分代区域划分，而是把连续的Java堆划分为多个大小相等的独立区域（Region），每一个Region都可以根据需要，扮演新生代的Edge空间、Survivor空间或者老年代空间</li>
<li>G1收集器能根据不同的Region采用不同的策略去处理</li>
<li>Region中还有一类特殊的Humongous区域，专门用来存储大对象，G1认为只要大小超过了一个Region容量一半的对象即可判定为大对象</li>
<li>每个Region的大小可以通过参数-XX:G1HeapRegionSize设定，取值范围为1MB-32MB，且为2的n次幂</li>
<li>对于那些超过了整个Region容量的超级大对象，将会被存放在N个连续的Humongous Region之中，G1的大多数行为都把Humongous Region作为老年代的一部分来进行看待</li>
</ul>
</li>
<li><p>虽然G1仍然保留新生代和老年代的概念，但新生代和老年代不再是固定的了，它们都是一系列区域（不需要连续）的动态集合</p>
<ul>
<li>G1收集器之所以能够建立可预测的停顿时间模型，是因为它将Region作为单次回收的最小单元，即每次收集到的内存空间都是Region大小的整数倍，这样可以有计划地避免在整个Java堆中进行全区域的垃圾收集</li>
<li>处理思路是让G1收集器跟踪各个Region里面的垃圾堆积的“价值”大小，价值即回收所获得的空间大小以及回收所需时间的经验值，然后在后台维护一个优先级列表，每次根据用户设定允许的收集停顿时间（-XX:MaxGCPauseMillis指定，默认是200ms），优先处理回收价值受益最大的那些Region，这也就是“Garbage First”名字的由来</li>
<li>这种使用Region划分内存空间，以及具有优先级的区域回收方式，保证了G1收集器在有限的时间内获取尽可能高的收集效率</li>
</ul>
</li>
</ul>
<h6 id="G1收集器运作过程（不计算用户线程运行过程中的动作）"><a href="#G1收集器运作过程（不计算用户线程运行过程中的动作）" class="headerlink" title="G1收集器运作过程（不计算用户线程运行过程中的动作）"></a>G1收集器运作过程（不计算用户线程运行过程中的动作）</h6><ul>
<li><p>初始标记（Initial Marking）</p>
<ul>
<li>标记GC Roots能直接关联到到对象，并且修改TAMS指针的值，让下一阶段用户线程并发运行时，能正确地在可用的Region中分配新对象</li>
<li>该阶段需要停顿线程，但耗时很短，而且是借用进行Minor GC的时候同步完成的，所以G1收集器在这个阶段实行并没有额外的停顿</li>
</ul>
</li>
<li><p>并发标记（Concurrent Marking）</p>
<ul>
<li>从GC Roots开始对堆中对象进行可达性分析，递归扫描整个堆里的对象图，找出要回收的对象，这阶段耗时比较长，但可与用户线程并发执行</li>
<li>当扫描图扫描完成后，还要重新处理SATB记录下的在并发时有引用变动的对象</li>
</ul>
</li>
<li><p>最终标记（Final Marking）</p>
<ul>
<li>对用户线程做另一个短暂对暂停，用于处理并发阶段结束后仍遗留下来的最后那少量的SATB记录</li>
</ul>
</li>
<li><p>筛选回收（Live Data Counting and Evacuation）</p>
<ul>
<li>负责更新Region的统计数据，对各个Region的回收价值和成本进行排序，根据用户所期望的停顿时间来指定回收计划，可以自由选择任意多个Region构成回收集，然后把决定回收的那一部分Region的存活对象复制到空的Region中，再清理掉整个旧Region的全部空间</li>
<li>这里的操作涉及存活对象的移动，是必须暂停用户线程，由多条收集器线程并行完成的</li>
</ul>
</li>
<li><p>G1收集器除了并发标记外，其余阶段也是要完全暂停用户线程的，换言之，它并非纯粹地追求低延迟，官方给它设定的目标是在延迟可控的情况下获得尽可能高的吞吐量，所以才担当起“全功能收集器”的重任与期望</p>
<p><img src="http://wx4.sinaimg.cn/large/008aQ1h9ly1ghzyvezb1bj30ti07aq3p.jpg"></p>
</li>
</ul>
<h6 id="G1收集器特点"><a href="#G1收集器特点" class="headerlink" title="G1收集器特点"></a>G1收集器特点</h6><ul>
<li><p>可由用户指定期望的停顿时间是G1收集器很强大的一个功能，设置不同的期望停顿时间，可让G1在不同应用场景中取得关注吞吐量和关注延迟之间的最佳平衡</p>
<ul>
<li>默认停顿时间200ms，必须保证“期望值”符合实际</li>
<li>若是停顿时间设置很低，则可能出现由于停顿目标时间太短，导致每次选出来的回收集只占堆内存很小的一部分，收集器收集的速度逐渐跟不上分配器分配的速度，导致垃圾慢慢堆积，最终引发Full GC而降低性能</li>
<li>所以期望停顿时间设置为100-200ms或200-300ms是比较合理的</li>
</ul>
</li>
<li><p>从G1开始，先进的垃圾收集器的设计导向都不约而同地变为追求能够应付应用的内存分配速率（Allocation Rate），而不是追求一次把整个Java堆全部清理干净</p>
<ul>
<li>这样应用在分配，同时收集器在收集，只要收集的速度能跟上对象分配的速度，那这一切能运作得很完美</li>
</ul>
</li>
</ul>
<h6 id="G1收集器相比CMS的优点"><a href="#G1收集器相比CMS的优点" class="headerlink" title="G1收集器相比CMS的优点"></a>G1收集器相比CMS的优点</h6><ul>
<li><p>G1从整体来看是基于“标记-整理”算法实现的收集器，从局部上看（两个Region之间）又是基于“标记-复制”算法实现，无论如何，这两种算法在运行期间都不会产生内存空间碎片，垃圾收集完成之后能提供规整的可用内存</p>
<ul>
<li>有利于应用程序长时间运行</li>
<li>分配大对象时不容易造成无法找到连续内存空间而提前触发一次收集</li>
</ul>
</li>
<li><p>可以自定义指定最大停顿时间</p>
</li>
<li><p>分Region的内存布局</p>
</li>
<li><p>按收益动态确定回收集</p>
</li>
</ul>
<h6 id="G1收集器相比CMS的缺点"><a href="#G1收集器相比CMS的缺点" class="headerlink" title="G1收集器相比CMS的缺点"></a>G1收集器相比CMS的缺点</h6><ul>
<li><p>在运行过程中，G1垃圾收集器内存占用（Footprint）要比CMS要高</p>
<ul>
<li>G1和CMS都使用卡表来处理跨代指针，但G1的卡表实现更复杂，堆中每个Region，无论扮演新生代还是老年代角色，都必须有一份卡表，导致G1的记忆集（和其他内存消耗）可能会占整个堆容量的20%乃至更多的内存空间</li>
<li>CMS的卡表就相当简单，只有唯一一份，而且只需要处理老年代到新生代的引用，反过来不需要，由于新生代的对象具有朝生夕灭的不稳定性，引用变化频繁，能省下这个区域的维护开销是很划算的</li>
</ul>
</li>
<li><p>程序运行时的额外执行负载（Overload）要比CMS高</p>
<ul>
<li><p>由于G1和CMS收集器各自实现特点导致用户程序运行时的负载会有不同，譬如它们都使用写屏障，CMS用写后屏障来更新维护卡表</p>
</li>
<li><p>G1除了使用写后屏障来进行同样的卡表维护操作外，为了实现原始快照搜索（SATB）算法，还需要使用写前屏障来跟踪并发时的指针变化情况</p>
<ul>
<li>相比增量更新算法，原始快照搜索能够减少并发标记和重新标记阶段的消耗，避免CMS那样在最终标记阶段停顿时间过长的缺点，但是在用户程序运行过程中确实会产生由跟踪引用变化带来的额外负担</li>
<li>由于G1对写屏障的复杂操作要比CMS消耗更多对运算资源，所以CMS的写屏障实现时直接的同步操作， 而G1就不得不将其实现为类似于消息队列的结构，把写前屏障和写后屏障中要做的事情都放到队列里，然后再异步处理</li>
</ul>
</li>
</ul>
</li>
<li><p>以上优缺点仅仅是针对G1和CMS两款垃圾收集器单独某方面的实现细节的定性分析，通常说哪款收集器要更好、要好上多少，往往是针对具体场景才能做的定量比较</p>
<ul>
<li>目前在小内存应用上CMS的表现大概率仍然会优于G1收集器</li>
<li>而在大内存应用上G1则大多能发挥其优势</li>
<li>这个优劣势的Java堆容量平衡点通常在6GB-8GB之间</li>
<li>随着HotSpot对G1对不断优化，也会让对比结果继续向G1倾斜</li>
</ul>
</li>
</ul>
<h5 id="低延迟垃圾收集器"><a href="#低延迟垃圾收集器" class="headerlink" title="低延迟垃圾收集器"></a>低延迟垃圾收集器</h5><ul>
<li><p>垃圾收集器三项重要指标</p>
<ul>
<li>内存占用（Footprint）</li>
<li>吞吐量（Throughput）</li>
<li>延迟（Latency）</li>
</ul>
</li>
<li><p>实验状态的低延迟垃圾收集器</p>
<ul>
<li>Shenandoah收集器（存在于OpenJDK，而不存在于OracleJDK）</li>
<li>ZGC收集器</li>
</ul>
</li>
</ul>
<h5 id="不垃圾回收的垃圾收集器"><a href="#不垃圾回收的垃圾收集器" class="headerlink" title="不垃圾回收的垃圾收集器"></a>不垃圾回收的垃圾收集器</h5><h6 id="Epsilon收集器"><a href="#Epsilon收集器" class="headerlink" title="Epsilon收集器"></a>Epsilon收集器</h6><ul>
<li>JDK11推出的不能够进行垃圾收集的垃圾收集器</li>
<li>适用于运行数分钟或者数秒，只要Java虚拟机能正确分配内存，在堆耗尽之前就会退出</li>
</ul>
]]></content>
      <categories>
        <category>JVM笔记</category>
      </categories>
      <tags>
        <tag>GC</tag>
        <tag>JVM内存分配</tag>
      </tags>
  </entry>
</search>
